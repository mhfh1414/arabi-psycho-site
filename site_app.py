from flask import Flask, render_template, request, redirect, url_for
import re

app = Flask(__name__)

# ===================== قاعدة DSM المبسّطة/الموسّعة =====================
DSM_DB = {
    # اضطرابات المزاج
    "اضطراب اكتئابي جسيم": [
        "حزن","مزاج منخفض","فقدان المتعة","انعدام المتعة","يأس","شعور بالذنب","بكاء","انسحاب اجتماعي",
        "انتحار","أفكار انتحارية","طاقة منخفضة","إرهاق","بطء نفسي حركي","أرق","كثرة نوم","اضطراب نوم",
        "شهية منخفضة","فقدان وزن","زيادة وزن","تركيز ضعيف","احتقار الذات"
    ],
    "اكتئاب مستمر (عسر المزاج)": [
        "مزاج مكتئب مزمن","تشاؤم مزمن","طاقة قليلة","نوم ضعيف","شهية قليلة","ثقة بالنفس منخفضة","تركيز ضعيف","إنتاجية ضعيفة"
    ],
    "اضطراب ثنائي القطب": [
        "نوبة هوس","هوس","نشاط زائد","طاقة عالية","قليل نوم","اندفاع","تهور","أفكار سباق","طلاقة الكلام",
        "عظمة","نوبات اكتئاب","تذبذب المزاج"
    ],
    # القلق والطيف
    "اضطراب القلق العام": [
        "قلق","قلق مفرط","توتر","أفكار سلبية","توجس","أرق","شد عضلي","صعوبة تركيز","تعب","قابلية استفزاز"
    ],
    "اضطراب الهلع": [
        "نوبة هلع","خفقان","اختناق","ضيق نفس","تعرق","رجفة","دوار","خوف الموت","خوف فقدان السيطرة","خدر","غثيان"
    ],
    "رهاب اجتماعي": [
        "خوف اجتماعي","خوف التقييم","خجل شديد","تجنب اجتماعي","احمرار","رجفة","قلق أداء","رهبة مواجهة"
    ],
    "رهاب محدد": ["رهاب","خوف شديد","تجنب مواقف","خوف من طيران","خوف من حشرات","خوف من أماكن مرتفعة"],
    "رهاب الساحة (الأماكن)": ["خوف من الأماكن المفتوحة","خوف من الازدحام","تجنب مواصلات","صعوبة الخروج وحيدًا"],
    # الوسواس والصدمة
    "اضطراب الوسواس القهري": [
        "وسواس","أفكار اقتحامية","طقوس","سلوك قهري","تفقد متكرر","غسل متكرر","تنظيم مفرط","عدّ قهري","خوف تلوث"
    ],
    "اضطراب ما بعد الصدمة": [
        "صدمة","حدث صادم","استرجاع الحدث","فلاش باك","كابوس","تجنب","خدر عاطفي","يقظة مفرطة","حساسية صوت"
    ],
    # طيف ذهاني
    "فصام": [
        "هلوسة","هلاوس سمعية","أوهام","ضلالات","تفكير غير منظم","انسحاب اجتماعي","تسطّح وجداني","انعدام إرادة"
    ],
    "اضطراب فصامي عاطفي": ["أعراض ذهانية","اكتئاب شديد","هوس","تذبذب مزاج","هلوسة","أوهام"],
    "اضطراب وهامي": ["ضلالات ثابتة","غيرة وهامية","اضطهاد","عظمة","شك مرضي"],
    # نمائية وعصبية
    "اضطراب فرط الحركة وتشتت الانتباه": [
        "تشتت","عدم تركيز","فرط حركة","اندفاعية","نسيان","تأجيل","تنظيم ضعيف","كثرة حركة","مقاطعة"
    ],
    "اضطراب طيف التوحد": [
        "تواصل اجتماعي ضعيف","تواصل غير لفظي ضعيف","صعوبات علاقات","اهتمامات مقيدة","روتين صارم",
        "حساسيات حسية","حركات نمطية","لغة متأخرة"
    ],
    "اضطراب وسواس قهري شخصية": ["انشغال بالتفاصيل","كمالية","صرامة","جفاف عاطفي","انشغال بالقواعد"],
    # نوم وأكل وجسد
    "أرق مزمن": ["صعوبة نوم","استيقاظ مبكر","نوم متقطع","عدم راحة","إجهاد نهاري"],
    "اضطراب نهم الطعام": ["نهم","أكل بشراهة","فقدان تحكم","أكل سرًا","ندم بعد الأكل","زيادة وزن"],
    "نهام عصبي": ["نهم متكرر","تطهير","استفراغ","ملينات","صورة جسد مشوهة"],
    "قهم عصبي": ["نقص وزن شديد","خوف من زيادة الوزن","صورة جسد سلبية","تقييد طعام"],
    "أعراض جسدية (سوماتيزيشن)": ["ألم غير مفسر","أعراض جسدية متعددة","انشغال صحي","زيارة أطباء كثيرة"],
    "قلق المرض (هيبوكوندريا)": ["خوف مرض خطير","تفقد جسد","طمأنة متكررة","بحث طبي مستمر"],
    # إدمان مواد
    "اضطراب تعاطي الكحول": ["كحول","سكر متكرر","تحمل","أعراض انسحاب","فقدان سيطرة","مشاكل عمل"],
    "اضطراب تعاطي القنب": ["حشيش","قنب","استخدام يومي","تسامح","انسحاب","قلق بعد الإيقاف"],
    "اضطراب تعاطي المنبهات": ["منشطات","أمفيتامين","كوكايين","سهَر","فقدان شهية","بارانويا","استخدام قهري"],
    "اضطراب تعاطي الأفيونات": ["هيروين","مورفين","أوكسيكودون","انسحاب أفيوني","رغبة ملحة","تحمل"],
    # شخصية
    "شخصية حدّية": ["اندفاع","تقلب عاطفي","خوف هجر","إيذاء ذاتي","فراغ مزمن","علاقات غير مستقرة"],
    "شخصية نرجسية": ["عظمة","حاجة إعجاب","تعاطف قليل","استغلالي","حسّاس للنقد"],
    "شخصية معادية للمجتمع": ["خرق قواعد","عدوانية","خداع","اندفاع","لامسؤولية","ندم قليل"],
    "شخصية اجتنابية": ["مثالية سلبية","تجنب نقد","خجل شديد","نقص كفاءة","حساسية رفض"],
    "شخصية اتكالية": ["اتكالية","صعوبة قرار","خوف فراق","احتياج دعم مستمر"],
    # تكيف وولادة وهورمونات ومعرفية
    "اضطراب تكيف": ["توتر موقف","حزن بعد حدث","قلق ظرفي","تراجع أداء بعد ضغط"],
    "اكتئاب ما حول الولادة": ["بعد الولادة","حزن ما بعد الولادة","بكاء","قلق طفل","نوم مضطرب"],
    "اضطراب ما قبل الطمث المزعج": ["تقلب مزاج قبل الدورة","تهيج","حساسية","انتفاخ","شهية"],
    "اضطراب معرفي خفيف/خرف مبكر": ["نسيان جديد","ضياع","بطء معالجة","تراجع تنفيذي"],
    # أخرى
    "وسواس اكتناز": ["اكتناز","صعوبة رمي","تكديس","فوضى منزل"],
    "اضطراب قلق انفصالي (بالغ)": ["قلق انفصال","صعوبة ابتعاد","كابوس فقد","أعراض جسدية عند الفراق"],
    "توريت/عرّات": ["عرات","حركات لا إرادية","أصوات لا إرادية","تفريغ توتر"]
}

def normalize(s: str) -> str:
    """تبسيط خفيف للنص العربي ليتحمل اختلافات الكتابة."""
    s = s.strip()
    s = re.sub(r"[ًٌٍَُِّْـ]", "", s)   # حذف الحركات
    s = s.replace("أ","ا").replace("إ","ا").replace("آ","ا").replace("ة","ه").replace("ى","ي")
    return s

def score_diagnoses(symptoms_text: str):
    """تحويل وصف الأعراض إلى قائمة تشخيصات مرتّبة حسب التطابق."""
    text = normalize(symptoms_text or "")
    scores = {}
    for disorder, keywords in DSM_DB.items():
        sc = 0
        for kw in keywords:
            if normalize(kw) in text:
                sc += 1
        if sc:
            scores[disorder] = sc
    return sorted(scores.items(), key=lambda x: x[1], reverse=True)

# =========================== المسارات ===========================
@app.route("/")
@app.route("/index")
def index():
    """الواجهة الرئيسية الأزرق/ذهبي."""
    return render_template("index.html")

# صفحة موحّدة: نموذج دراسة حالة + تشخيص DSM
@app.route("/dsm", methods=["GET", "POST"])
def dsm():
    if request.method == "POST":
        name     = request.form.get("name","").strip()
        age      = request.form.get("age","").strip()
        gender   = request.form.get("gender","").strip()
        duration = request.form.get("duration","").strip()
        symptoms = request.form.get("symptoms","").strip()
        history  = request.form.get("history","").strip()

        ranked = score_diagnoses(symptoms)
        if ranked:
            top = [f"{d} <span class='badge ok'>مطابقة تقريبية ({pts})</span>" for d, pts in ranked[:3]]
            diagnosis_html = "<strong>أقرب التشخيصات:</strong><br>" + "<br>".join(top)
        else:
            diagnosis_html = "<span class='badge warn'>لا توجد أعراض كافية للتشخيص وفق القاموس المبسّط.</span>"

        return render_template(
            "dsm.html",
            name=name, age=age, gender=gender, duration=duration,
            symptoms=symptoms, history=history, diagnosis=diagnosis_html
        )
    # GET: عرض النموذج
    return render_template("dsm.html")

# توافق خلفي: أي روابط قديمة
@app.route("/case_study")
@app.route("/case_dsm")
@app.route("/dsm.html")
def legacy_to_dsm():
    return redirect(url_for("dsm"))

# بقية الصفحات (لمنع BuildError في الروابط)
@app.route("/tests")
def tests():
    return render_template("tests.html")

@app.route("/cbt")
def cbt():
    return render_template("cbt.html")

@app.route("/addiction")
def addiction():
    return render_template("addiction.html")

@app.route("/request_doctor")
def request_doctor():
    return render_template("request_doctor.html")

@app.route("/request_specialist")
def request_specialist():
    return render_template("request_specialist.html")

# ======================== معالجات الأخطاء ========================
@app.errorhandler(404)
def not_found(e):
    return render_template("error.html", code=404, message="الصفحة غير موجودة."), 404

@app.errorhandler(500)
def server_error(e):
    return render_template("error.html", code=500, message="خطأ داخلي في الخادم."), 500

# =========================== التشغيل ===========================
if __name__ == "__main__":
    # في Render سيُستخدم gunicorn؛ هذا فقط للتجربة محليًا
    app.run(host="0.0.0.0", port=10000)
