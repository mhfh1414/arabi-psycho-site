# -*- coding: utf-8 -*-
from flask import Flask, render_template, request, redirect, url_for

app = Flask(__name__)

# ===============================
# 1) Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù‘ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
# ===============================
def strip_diacritics(s: str) -> str:
    if not s:
        return ""
    # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ + ØªÙˆØ­ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    repl = (
        ("\u064B", ""),("\u064C",""),("\u064D",""),("\u064E",""),
        ("\u064F",""),("\u0650",""),("\u0651",""),("\u0652",""),
        ("Ø£","Ø§"),("Ø¥","Ø§"),("Ø¢","Ø§"),("Ù‰","ÙŠ"),("Ø©","Ù‡"),
        ("Ø¤","Ùˆ"),("Ø¦","ÙŠ")
    )
    for a,b in repl:
        s = s.replace(a,b)
    return s

def norm(text: str) -> str:
    t = (text or "").lower()
    t = "".join(ch if ("0" <= ch <= "9") or ("a" <= ch <= "z")
                or ("\u0600" <= ch <= "\u06FF") or ch.isspace() else " "
                for ch in t)
    t = " ".join(t.split())
    return strip_diacritics(t)

def has_any(text, arr):  # Ù‡Ù„ ÙŠØ­ØªÙˆÙŠ Ø£ÙŠ ÙƒÙ„Ù…Ø©
    return any(k in text for k in arr)

def count_hits(text, arr):  # Ø¹Ø¯Ø¯ Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª
    return sum(1 for k in arr if k in text)

# =========================================
# 2) Ù‚Ø§Ø¹Ø¯Ø© DSM Ù…ÙˆØ³Ø¹Ø© (ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù…Ø®ØªØµØ±Ø©)
#    ØªÙ‚Ø¯Ø± ØªÙˆØ³Ù‘Ø¹Ù‡Ø§ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø·
#    ÙƒÙ„ Ø¹Ù†ØµØ±: code, name, any[], aka?[], all?[], exclude?[], min_days?
# =========================================
DSM_CATALOG = [
    # -------- Ù…Ø²Ø§Ø¬/Ø§ÙƒØªØ¦Ø§Ø¨ --------
    {"code":"MDD","name":"Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨ Ø§Ù„Ø´Ø¯ÙŠØ¯ (MDD)",
     "aka":["Ø§ÙƒØªØ¦Ø§Ø¨","Ø­Ø²Ù†","Ø¶ÙŠÙ‚Ù‡","Ù…Ø²Ø§Ø¬ Ù…Ù†Ø®ÙØ¶","ÙƒØªÙ…Ù‡"],
     "any":["Ø­Ø²Ù†","ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ù…ØªØ¹Ù‡","Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ù„Ù…ØªØ¹Ù‡","Ø°Ù†Ø¨","Ø§Ù†Ø¹Ø¯Ø§Ù… Ù‚ÙŠÙ…Ù‡","ÙŠØ§Ø³","Ø§Ù†Ø³Ø­Ø§Ø¨","Ø§Ø±Ù‡Ø§Ù‚","Ø§Ø±Ù‚","Ù†ÙˆÙ… Ø²Ø§Ø¦Ø¯","Ø§Ù†ØªØ­Ø§Ø±","ØªÙÙƒÙŠØ± Ø¨Ø§Ù„Ù…ÙˆØª"],
     "min_days":14},
    {"code":"PDD","name":"Ø§Ù„Ø§ÙƒØªØ¦Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ…Ø± (Ø¯ÙŠØ³ØªÙŠÙ…ÙŠØ§)",
     "any":["Ø­Ø²Ù† Ù…Ø²Ù…Ù†","Ù…Ø²Ø§Ø¬ Ù…Ù†Ø®ÙØ¶","Ø·Ø§Ù‚Ù‡ Ù…Ù†Ø®ÙØ¶Ù‡","ØªØ´Ø§Ø¤Ù…","Ù†Ù‚Øµ Ø«Ù‚Ù‡"],
     "min_days":365},
    {"code":"PMDD","name":"Ø§Ù„Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù…Ø²Ø¹Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù„Ø­ÙŠØ¶",
     "any":["ØªÙ‚Ù„Ø¨ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙˆØ±Ù‡","ØªÙ‡ÙŠØ¬ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙˆØ±Ù‡","Ø§ÙƒØªØ¦Ø§Ø¨ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙˆØ±Ù‡"]},

    # -------- Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø¨ --------
    {"code":"BP1","name":"Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„",
     "any":["Ù†ÙˆØ¨Ù‡ Ù‡ÙˆØ³","Ù‡ÙˆØ³","Ù†Ø´ÙˆÙ‡","Ù‚Ù„Ù‡ Ù†ÙˆÙ… Ø¯ÙˆÙ† ØªØ¹Ø¨","Ø§ÙÙƒØ§Ø± Ø¹Ø¸Ù…Ù‡","Ø§Ù†Ø¯ÙØ§Ø¹","Ø§Ù†ÙØ§Ù‚ Ø²Ø§Ø¦Ø¯","ÙƒÙ„Ø§Ù… Ø³Ø±ÙŠØ¹"],
     "exclude":["Ø­Ø²Ù† ÙÙ‚Ø·"], "min_days":7},
    {"code":"BP2","name":"Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ù‡ÙˆØ³ Ø®ÙÙŠÙ + Ø§ÙƒØªØ¦Ø§Ø¨)",
     "any":["Ù‡ÙˆØ³ Ø®ÙÙŠÙ","Ø·Ø§Ù‚Ù‡ Ø¹Ø§Ù„ÙŠÙ‡","Ù‚Ù„Ù‡ Ù†ÙˆÙ…","Ø§ÙƒØªØ¦Ø§Ø¨"], "min_days":4},

    # -------- Ù‚Ù„Ù‚/Ø±Ù‡Ø§Ø¨ --------
    {"code":"GAD","name":"Ù‚Ù„Ù‚ Ù…Ø¹Ù…Ù‘Ù… (GAD)",
     "aka":["ØªÙˆØªØ±","ØªÙÙƒÙŠØ± Ø²Ø§ÙŠØ¯","Ø¶ÙŠÙ‚Ù‡"],
     "any":["Ù‚Ù„Ù‚","ØªÙˆØªØ±","ØªÙÙƒÙŠØ± Ø²Ø§ÙŠØ¯","Ø´Ø¯ Ø¹Ø¶Ù„ÙŠ","ØªØ¹Ø¨ Ø³Ø±ÙŠØ¹","ØµØ¹ÙˆØ¨Ù‡ ØªØ±ÙƒÙŠØ²","Ø§Ø±Ù‚"],
     "min_days":180},
    {"code":"PD","name":"Ù†ÙˆØ¨Ø§Øª Ù‡Ù„Ø¹",
     "aka":["ÙØ¬Ø¹Ù‡"],
     "any":["Ù†ÙˆØ¨Ù‡ Ù‡Ù„Ø¹","Ø®ÙÙ‚Ø§Ù†","Ø§Ø®ØªÙ†Ø§Ù‚","Ø¯ÙˆØ®Ù‡","Ø±Ø¬ÙÙ‡","Ø®ÙˆÙ Ù…ÙˆØª","Ø®ÙˆÙ ÙÙ‚Ø¯ Ø§Ù„Ø³ÙŠØ·Ø±Ù‡"]},
    {"code":"SOC","name":"Ø±Ù‡Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ",
     "any":["Ø®ÙˆÙ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ø®ÙˆÙ Ù…Ù† ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø§Ø³","Ø§Ø­Ù…Ø±Ø§Ø±","ØªØ¬Ù†Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª","Ø±Ø¹Ø´Ù‡ Ø§Ù…Ø§Ù… Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±"],
     "min_days":180},
    {"code":"Agoraphobia","name":"Ø±Ù‡Ø§Ø¨ Ø§Ù„Ù…ÙŠØ§Ø¯ÙŠÙ†/Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…",
     "any":["Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬","Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø²Ø­Ø§Ù…","ØªØ¬Ù†Ø¨ Ù…ÙˆØ§ØµÙ„Ø§Øª"], "min_days":180},
    {"code":"SP","name":"Ø±Ù‡Ø§Ø¨ Ù…Ø­Ø¯Ø¯",
     "any":["Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ÙƒØ¨","Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø·ÙŠØ±Ø§Ù†","Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø­Ù‚Ù†","ÙÙˆØ¨ÙŠØ§"]},

    # -------- ÙˆØ³ÙˆØ§Ø³ Ù‚Ù‡Ø±ÙŠ --------
    {"code":"OCD","name":"Ø§Ù„ÙˆØ³ÙˆØ§Ø³ Ø§Ù„Ù‚Ù‡Ø±ÙŠ",
     "aka":["ÙˆØ³ÙˆØ§Ø³","Ù‚Ù‡Ø±ÙŠ"],
     "any":["Ø§ÙÙƒØ§Ø± ØªØ³Ù„Ø·ÙŠÙ‡","ØºØ³Ù„ Ù…ØªÙƒØ±Ø±","ØªÙÙ‚Ø¯","Ø·Ù‚ÙˆØ³","ØªÙ†Ø¸ÙŠÙ… Ù‚Ù‡Ø±ÙŠ","Ø¹Ø¯","ØªÙƒØ±Ø§Ø±"],
     "min_days":90},
    {"code":"BDD","name":"ØªØ´ÙˆÙ‘Ù‡ ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø³Ø¯",
     "any":["Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø¹ÙŠØ¨ Ø´ÙƒÙ„ÙŠ","ØªÙÙ‚Ø¯ Ù…Ø±Ø§ÙŠÙ‡","Ø§Ø®ÙØ§Ø¡ Ù…Ù„Ø§Ù…Ø­"], "min_days":90},
    {"code":"Tricho","name":"Ù†ØªÙ Ø§Ù„Ø´Ø¹Ø±",
     "any":["Ù†ØªÙ Ø´Ø¹Ø±","Ø´Ø¯ Ø´Ø¹Ø±","ÙØ±Ø§ØºØ§Øª"]},
    {"code":"Onycho","name":"Ù‚Ø¶Ù… Ø§Ù„Ø§Ø¸Ø§ÙØ± Ø§Ù„Ù‚Ù‡Ø±ÙŠ",
     "any":["Ù‚Ø¶Ù… Ø§Ø¸Ø§ÙØ±","Ø§ÙƒÙ„ Ø§Ø¸Ø§ÙØ±"]},

    # -------- ØµØ¯Ù…Ø§Øª --------
    {"code":"PTSD","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØµØ¯Ù…Ø© (PTSD)",
     "any":["ØµØ¯Ù…Ø©","ÙƒØ§Ø¨ÙˆØ³","Ø§Ø³ØªØ±Ø¬Ø§Ø¹","ØªØ¬Ù†Ø¨","ÙŠÙ‚Ø¸Ù‡ Ù…ÙØ±Ø·Ù‡","Ø®Ø¯Ø±"], "min_days":30},
    {"code":"ASD","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙƒØ±Ø¨ Ø­Ø§Ø¯",
     "any":["ØµØ¯Ù…Ø© Ø­Ø¯ÙŠØ«Ù‡","ÙƒØ§Ø¨ÙˆØ³","Ø§Ø³ØªØ±Ø¬Ø§Ø¹","Ø®Ø¯Ø±"], "min_days":3},

    # -------- Ø°Ù‡Ø§Ù†ÙŠØ§Øª --------
    {"code":"SCHZ","name":"ÙØµØ§Ù…",
     "any":["Ù‡Ù„Ø§ÙˆØ³ Ø³Ù…Ø¹ÙŠÙ‡","Ø¶Ù„Ø§Ù„Ø§Øª","ØªÙÙƒÙƒ ÙƒÙ„Ø§Ù…","Ø§Ù†Ø³Ø­Ø§Ø¨","ØªØ¨Ù„Ø¯ ÙˆØ¬Ø¯Ø§Ù†ÙŠ"], "min_days":180},
    {"code":"Schizoaff","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙØµØ§Ù…ÙŠ Ø¹Ø§Ø·ÙÙŠ",
     "any":["Ø§Ø¹Ø±Ø§Ø¶ ÙØµØ§Ù…","Ù†ÙˆØ¨Ø§Øª Ù…Ø²Ø§Ø¬"]},
    {"code":"BriefPsych","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø°Ù‡Ø§Ù†ÙŠ ÙˆØ¬ÙŠØ²",
     "any":["Ù‡Ù„Ø§ÙˆØ³","Ø¶Ù„Ø§Ù„Ø§Øª","ØªÙÙƒÙƒ","Ø¶ØºØ· Ù†ÙØ³ÙŠ Ù‚ÙˆÙŠ"], "min_days":1},

    # -------- Ø§Ù†ØªØ¨Ø§Ù‡/ØªÙ†ÙÙŠØ°ÙŠ --------
    {"code":"ADHD","name":"ÙØ±Ø· Ø­Ø±ÙƒØ©/ØªØ´ØªØª (Ø¨Ø§Ù„ØºÙŠÙ†)",
     "aka":["Ù†Ø³Ø§ÙŠÙŠÙ†"],
     "any":["ØªØ´ØªØª","Ù†Ø³ÙŠØ§Ù†","ØªØ§Ø¬ÙŠÙ„","Ø§Ù†Ø¯ÙØ§Ø¹","ØªÙ†Ø¸ÙŠÙ… ÙˆÙ‚Øª Ø¶Ø¹ÙŠÙ","Ø­Ø±ÙƒÙ‡ Ø²Ø§ÙŠØ¯Ù‡"], "min_days":180},

    # -------- Ù†ÙˆÙ… --------
    {"code":"INS","name":"Ø£Ø±Ù‚ Ù…Ø²Ù…Ù†",
     "any":["Ø§Ø±Ù‚","ØµØ¹ÙˆØ¨Ù‡ Ù†ÙˆÙ…","Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ Ù…Ø¨ÙƒØ±","Ù†ÙˆÙ… Ø³Ø·Ø­ÙŠ"], "min_days":90},
    {"code":"Hypersomnia","name":"ÙØ±Ø· Ø§Ù„Ù†Ø¹Ø§Ø³",
     "any":["Ù†Ø¹Ø§Ø³ Ù†Ù‡Ø§Ø±ÙŠ","Ù†ÙˆÙ… Ø·ÙˆÙŠÙ„","ØºÙÙˆØ§Øª"]},
    {"code":"Parasomnia","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨Ø§Øª Ù†ÙˆÙ… (ÙƒÙˆØ§Ø¨ÙŠØ³/Ù…Ø´ÙŠ Ù†ÙˆÙ…)",
     "any":["ÙƒØ§Ø¨ÙˆØ³","Ù…Ø´ÙŠ Ø§Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…","Ù‡Ù„Ø¹ Ù„ÙŠÙ„ÙŠ"]},

    # -------- Ø£ÙƒÙ„ --------
    {"code":"AN","name":"ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø´Ù‡ÙŠØ© Ø§Ù„Ø¹ØµØ¨ÙŠ",
     "any":["Ù†Ù‚Øµ ÙˆØ²Ù† Ø´Ø¯ÙŠØ¯","Ø®ÙˆÙ Ø²ÙŠØ§Ø¯Ù‡ ÙˆØ²Ù†","ØµÙˆØ±Ù‡ Ø¬Ø³Ù… Ù…Ø´ÙˆÙ‡Ù‡","ØªÙ‚ÙŠÙŠØ¯ Ø§ÙƒÙ„"], "min_days":90},
    {"code":"BN","name":"Ù†Ù‡Ø§Ù… Ø¹ØµØ¨ÙŠ",
     "any":["Ù†Ù‡Ù… Ø§ÙƒÙ„","Ù‚ÙŠØ¡ ØªØ¹ÙˆÙŠØ¶ÙŠ","Ù…Ù„ÙŠÙ†Ø§Øª","ØªØ°Ø¨Ø°Ø¨ ÙˆØ²Ù†"], "min_days":90},
    {"code":"BED","name":"Ù†Ù‡Ù… Ø§Ù„Ø·Ø¹Ø§Ù…",
     "any":["Ø§ÙƒÙ„ ÙƒÙ…ÙŠØ§Øª ÙƒØ¨ÙŠØ±Ù‡","ÙÙ‚Ø¯ Ø§Ù„Ø³ÙŠØ·Ø±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø§ÙƒÙ„","Ù†Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø§ÙƒÙ„"], "min_days":90},

    # -------- Ø¬Ø³Ø¯ÙŠØ© Ø§Ù„Ø´ÙƒÙ„/Ù‚Ù„Ù‚ ØµØ­ÙŠ --------
    {"code":"SOM","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø£Ø¹Ø±Ø§Ø¶ Ø¬Ø³Ø¯ÙŠØ©",
     "any":["Ø§Ù„Ø§Ù… Ù…ØªÙ†Ù‚Ù„Ù‡","Ø§Ø¹Ø±Ø§Ø¶ Ø¬Ø³Ø¯ÙŠÙ‡ ÙƒØ«ÙŠØ±Ù‡","ÙØ­ÙˆØµØ§Øª Ø³Ù„ÙŠÙ…Ù‡","Ø§Ù†Ø´ØºØ§Ù„ ØµØ­ÙŠ"], "min_days":180},
    {"code":"IAD","name":"Ù‚Ù„Ù‚ Ø§Ù„Ù…Ø±Ø¶ (Ù‡ÙŠØ¨ÙˆÙƒÙˆÙ†Ø¯Ø±ÙŠØ§)",
     "any":["Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ù…Ø±Ø¶","ØªÙÙ‚Ø¯ Ø¬Ø³Ø¯","Ù‚Ø±Ø§Ø¡Ø© Ø·Ø¨ÙŠÙ‡ Ù…ÙØ±Ø·Ù‡"], "min_days":180},

    # -------- ØªÙØ§Ø±Ù‚ÙŠ --------
    {"code":"DID","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ØªÙØ§Ø±Ù‚ÙŠ",
     "any":["Ù‡ÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ù‡","ÙØ¬ÙˆØ§Øª Ø°Ø§ÙƒØ±Ù‡","Ø§Ù†ÙØµØ§Ù„"]},
    {"code":"DPDR","name":"Ø§Ø®ØªÙ„Ø§Ù„ Ø§Ù„Ø¢Ù†ÙŠØ©/Ø§Ù„ÙˆØ§Ù‚Ø¹",
     "any":["Ù„Ø§ÙˆØ§Ù‚Ø¹ÙŠÙ‡","Ø§Ù†ÙØµØ§Ù„ Ø¹Ù† Ø§Ù„Ø°Ø§Øª","Ø¶Ø¨Ø§Ø¨ÙŠÙ‡ Ø§Ù„Ø¹Ø§Ù„Ù…"], "min_days":30},

    # -------- ØªØ¹Ø§Ø·ÙŠ/Ø¥Ø¯Ù…Ø§Ù† --------
    {"code":"AUD","name":"ØªØ¹Ø§Ø·ÙŠ Ø§Ù„ÙƒØ­ÙˆÙ„",
     "any":["Ø®Ù…Ø±","ÙƒØ­ÙˆÙ„","Ø«Ù…Ø§Ù„Ù‡","Ø§Ù†Ø³Ø­Ø§Ø¨","ÙÙ‚Ø¯ Ø§Ù„Ø³ÙŠØ·Ø±Ù‡"]},
    {"code":"CUD","name":"ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ø­Ø´ÙŠØ´",
     "any":["Ø­Ø´ÙŠØ´","Ù‚Ù†Ø¨","Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙŠÙˆÙ…ÙŠ","Ù†Ø³ÙŠØ§Ù†"]},
    {"code":"OUD","name":"ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ø£ÙÙŠÙˆÙ†Ø§Øª",
     "any":["Ù‡ÙŠØ±ÙˆÙŠÙ†","Ù…Ø³ÙƒÙ†Ø§Øª Ø§ÙÙŠÙˆÙ†ÙŠÙ‡","Ø§Ù†Ø³Ø­Ø§Ø¨","ØªØ­Ù…Ù„"]},
    {"code":"STIM","name":"ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ù…Ù†Ø¨Ù‡Ø§Øª",
     "any":["Ø§Ù…ÙÙŠØªØ§Ù…ÙŠÙ†","ÙƒÙˆÙƒØ§ÙŠÙŠÙ†","ÙƒØ¨ØªØ§Ø¬ÙˆÙ†","Ø³Ù‡Ø± Ø·ÙˆÙŠÙ„","Ø¨Ø§Ø±Ø§Ù†ÙˆÙŠØ§"]},
    {"code":"BDZ","name":"Ø¥Ø³Ø§Ø¡Ø© Ø§Ù„Ø¨Ù†Ø²ÙˆØ¯ÙŠØ§Ø²Ø¨ÙŠÙ†",
     "any":["Ø²Ø§Ù†Ø§ÙƒØ³","ÙØ§Ù„ÙŠÙˆÙ…","Ø§Ù†Ø³Ø­Ø§Ø¨","ØªØ­Ù…Ù„"]},
    {"code":"TobUse","name":"ØªØ¹Ø§Ø·ÙŠ Ù†ÙŠÙƒÙˆØªÙŠÙ†/ØªØ¨Øº",
     "any":["ØªØ¯Ø®ÙŠÙ†","Ø³Ø¬Ø§Ø¦Ø±","Ø³Ø­Ø¨Ø§Øª","Ø±ØºØ¨Ù‡ Ø´Ø¯ÙŠØ¯Ù‡"]},

    # -------- Ù†Ù…Ùˆ Ø¹ØµØ¨ÙŠ --------
    {"code":"ASD","name":"Ø·ÙŠÙ Ø§Ù„ØªÙˆØ­Ø¯ (Ø¨Ø§Ù„ØºÙŠÙ†)",
     "any":["ØµØ¹ÙˆØ¨Ø§Øª ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø­ØµØ±ÙŠÙ‡","Ø­Ø³Ø§Ø³ÙŠÙ‡ Ø­Ø³ÙŠÙ‡"]},

    # -------- Ø´Ø®ØµÙŠØ© (Ù…Ø¤Ø´Ø±Ø§Øª) --------
    {"code":"BPD","name":"Ø³Ù…Ø§Øª Ø­Ø¯Ù‘ÙŠØ©",
     "any":["Ø§Ù†Ø¯ÙØ§Ø¹ Ø´Ø¯ÙŠØ¯","ØªÙ‚Ù„Ø¨ Ø­Ø§Ø¯","Ø®ÙˆÙ Ù‡Ø¬Ø±","Ø§ÙŠØ°Ø§Ø¡ Ø°Ø§ØªÙŠ"]},
    {"code":"AvPD","name":"Ø´Ø®ØµÙŠØ© ØªØ¬Ù†Ù‘Ø¨ÙŠØ©",
     "any":["ØªØ¬Ù†Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø´Ø¯ÙŠØ¯","Ø­Ø³Ø§Ø³ÙŠÙ‡ Ù„Ù„Ù†Ù‚Ø¯","Ø®Ø¬Ù„ Ù…ÙØ±Ø·"]},
    {"code":"OCPD","name":"Ø´Ø®ØµÙŠØ© Ù‚Ø³Ø±ÙŠØ©",
     "any":["Ù…Ø«Ø§Ù„ÙŠÙ‡ Ù…ÙØ±Ø·Ù‡","ØµØ±Ø§Ù…Ù‡","Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…"]},

    # -------- Ù…Ø¤Ø´Ø±Ø§Øª Ø·Ø¨ÙŠØ© Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ --------
    {"code":"Thy","name":"Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø¯Ø±Ù‚ÙŠ (Ø·Ø¨ÙŠ)",
     "any":["Ø®ÙÙ‚Ø§Ù†","ØªØ¹Ø±Ù‚","Ù†Ù‚Øµ ÙˆØ²Ù† ØºÙŠØ± Ù…ÙØ³Ø±","Ø±Ø¬ÙÙ‡"]},
    {"code":"Anemia","name":"Ø§Ø´ØªØ¨Ø§Ù‡ ÙÙ‚Ø± Ø¯Ù… (Ø·Ø¨ÙŠ)",
     "any":["Ø§Ø±Ù‡Ø§Ù‚ Ù…Ø²Ù…Ù†","Ø¯ÙˆØ®Ù‡","Ø´Ø­ÙˆØ¨"]},

    # -------- ØªÙƒÙŠÙ‘Ù/Ø¶ØºÙˆØ· --------
    {"code":"ADJ","name":"Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªÙƒÙŠÙ‘Ù",
     "any":["Ø­Ø²Ù† Ø¨Ø¹Ø¯ Ø­Ø¯Ø«","Ù‚Ù„Ù‚ Ø¨Ø¹Ø¯ Ø­Ø¯Ø«","ØµØ¹ÙˆØ¨Ù‡ ØªÙƒÙŠÙ","Ø¶ØºÙˆØ· Ø­ÙŠØ§ØªÙŠÙ‡"]},
    {"code":"Grief","name":"Ø­Ø²Ù†/ÙØ¬ÙŠØ¹Ù‡ Ù…Ø·ÙˆÙ‘Ù„",
     "any":["ÙÙ‚Ø¯ Ø´Ø®Øµ","Ø­Ø²Ù† Ù…Ø³ØªÙ…Ø±","Ø§Ø´ØªÙŠØ§Ù‚ Ù…Ø±ÙŠØ±"], "min_days":180},

    # -------- Ø§Ù†Ø¯ÙØ§Ø¹/Ø¹Ø§Ø¯Ø§Øª --------
    {"code":"IED","name":"Ø§Ù†ÙØ¬Ø§Ø±Ø§Øª ØºØ¶Ø¨ (IED)",
     "any":["Ù†ÙˆØ¨Ø§Øª ØºØ¶Ø¨ Ù„Ø§ ØªØªÙ†Ø§Ø³Ø¨","Ø¹Ø¯ÙˆØ§Ù† Ø§Ù†Ø¯ÙØ§Ø¹ÙŠ"]},
    {"code":"Klepto","name":"Ù‡ÙˆØ³ Ø³Ø±Ù‚Ø© (Ù…Ø¤Ø´Ø±)",
     "any":["Ø³Ø±Ù‚Ù‡ Ù…ØªÙƒØ±Ø±Ù‡ Ø¨Ù„Ø§ Ù…ÙƒØ³Ø¨","ØªÙˆØªØ± Ù‚Ø¨Ù„ Ø§Ù„ÙØ¹Ù„","Ø±Ø§Ø­Ù‡ Ø¨Ø¹Ø¯Ù‡"]},
    {"code":"Pyro","name":"Ù‡ÙˆØ³ Ø§Ø´Ø¹Ø§Ù„ Ø­Ø±Ø§Ø¦Ù‚ (Ù…Ø¤Ø´Ø±)",
     "any":["Ø§Ø´Ø¹Ø§Ù„ Ù…ØªÙƒØ±Ø±","Ø§Ù‡ØªÙ…Ø§Ù… Ø¨Ø§Ù„Ù†Ø§Ø±"]},

    # -------- Ø£Ø®Ø±Ù‰ Ù„ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· --------
    {"code":"HealthAnx","name":"Ù‚Ù„Ù‚ ØµØ­ÙŠ Ø¨Ø¹Ø¯ Ø¬Ø§Ø¦Ø­Ù‡/Ø¹Ø¯ÙˆÙ‰",
     "any":["Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø¹Ø¯ÙˆÙ‰","ØªØ¹Ù‚ÙŠÙ… Ù…ÙØ±Ø·","ØªÙÙ‚Ø¯ Ø­Ø±Ø§Ø±Ù‡"]},
    {"code":"Rumination","name":"Ø§Ø¬ØªØ±Ø§Ø± Ø§ÙÙƒØ§Ø± Ù‚Ù‡Ø±ÙŠ",
     "any":["ØªÙÙƒÙŠØ± Ø¯Ø§Ø¦Ø±ÙŠ","Ø§Ø¹Ø§Ø¯Ù‡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¶ÙŠ","Ù„ÙˆÙ… Ø§Ù„Ø°Ø§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±"]},
    {"code":"DrivePhobia","name":"Ø±Ù‡Ø§Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø¯Ù‡/Ø§Ù„Ø·Ø±Ù‚",
     "any":["Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ù‚ÙŠØ§Ø¯Ù‡","ØªØ¬Ù†Ø¨ Ø§Ù„Ø·Ø±Ù‚","Ø®ÙˆÙ Ø­ÙˆØ§Ø¯Ø«"]}
]

# ============================
# 3) Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ±Ø´ÙŠØ­/Ø§Ù„ØªØ´Ø®ÙŠØµ
# ============================
def score_disorder(text: str, duration_days: int, d: dict) -> int:
    score = 0
    # Ù…Ø±Ø§Ø¯ÙØ§Øª
    score += count_hits(text, [norm(k) for k in d.get("aka", [])])
    # ÙƒÙ„Ù…Ø§Øª Ø£ÙŠÙ‘Ø§Ù‹ Ù…Ù†Ù‡Ø§
    score += count_hits(text, [norm(k) for k in d.get("any", [])])
    # ÙƒÙ„Ù…Ø§Øª ÙŠØ¬Ø¨ ØªÙˆÙØ±Ù‡Ø§ (Ø¥Ù† ÙˆØ¬Ø¯Øª)
    score += 2 * count_hits(text, [norm(k) for k in d.get("all", [])])
    # Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ØªÙ‚Ù„Ù‘Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø©
    if d.get("exclude") and has_any(text, [norm(k) for k in d["exclude"]]):
        score -= 2
    # Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø¯Ø© (Ø¥Ù† ÙˆÙØ¬Ø¯ Ø­Ø¯ Ø£Ø¯Ù†Ù‰)
    if d.get("min_days") and duration_days is not None:
        try:
            if int(duration_days) >= int(d["min_days"]):
                score += 2
        except Exception:
            pass
    return max(score, 0)

def run_dsm_engine(symptoms: str, history: str, duration_days: int):
    text = norm((symptoms or "") + " " + (history or ""))
    results = []
    for d in DSM_CATALOG:
        sc = score_disorder(text, duration_days, d)
        if sc > 0:
            results.append((d["name"], sc))
    # ØªØ±ØªÙŠØ¨ ÙˆÙ†Ø±Ø¬Ø¹ Ø£Ø¹Ù„Ù‰ 10 ÙÙ‚Ø·
    results.sort(key=lambda x: x[1], reverse=True)
    top = results[:10]
    # ØµÙŠØ§ØºØ© Ù†ØµÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ dsm.html (Ù‚Ø§Ø¦Ù…Ø© Ø³Ø·ÙˆØ±)
    formatted = [f"{name} â€” Ø¯Ø±Ø¬Ø© {score}" for name, score in top]
    return formatted

# ============================
# 4) Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Routes)
# ============================
@app.route("/")
def home():
    return render_template("index.html")

# Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø©: Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© + DSM (ÙÙŠ Ù‚Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ dsm.html)
@app.route("/dsm", methods=["GET","POST"])
def dsm():
    if request.method == "POST":
        name     = request.form.get("name","").strip()
        age      = request.form.get("age","").strip()
        gender   = request.form.get("gender","").strip()
        duration = request.form.get("duration","").strip()
        symptoms = request.form.get("symptoms","").strip()

        diagnosis = run_dsm_engine(symptoms, history="", duration_days=int(duration) if duration else 0)
        if not diagnosis:
            diagnosis = ["âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø±Ø§Ø¶ ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ´Ø®ÙŠØµ"]

        return render_template("dsm.html",
                               name=name, age=age, gender=gender,
                               duration=duration, symptoms=symptoms,
                               diagnosis=diagnosis)
    return render_template("dsm.html", diagnosis=None)

# ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ùˆ Ø§Ø³ØªÙØ®Ø¯Ù…
@app.route("/case_study", methods=["GET","POST"])
def case_study_legacy():
    return redirect(url_for("dsm"), code=301)

# ØµÙØ­Ø§Øª Ø«Ø§Ù†ÙˆÙŠØ© Ù„Ù„ØªÙ†Ù‚Ù„ (Placeholder)
@app.route("/tests")
def tests():
    return render_template("tests.html") if template_exists("tests.html") else "<h1>ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù†ÙØ³ÙŠØ© ÙˆØ§Ù„Ø´Ø®ØµÙŠØ©</h1>"

@app.route("/cbt")
def cbt():
    return render_template("cbt.html") if template_exists("cbt.html") else "<h1>ğŸ’¡ Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø³Ù„ÙˆÙƒÙŠ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ (CBT)</h1>"

@app.route("/addiction")
def addiction():
    return render_template("addiction.html") if template_exists("addiction.html") else "<h1>ğŸš­ Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¥Ø¯Ù…Ø§Ù†</h1>"

@app.route("/request_doctor")
def request_doctor():
    return render_template("request_doctor.html") if template_exists("request_doctor.html") else "<h1>ğŸ‘¨â€âš•ï¸ Ø·Ù„Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¨</h1>"

@app.route("/request_specialist")
def request_specialist():
    return render_template("request_specialist.html") if template_exists("request_specialist.html") else "<h1>ğŸ‘¨â€ğŸ’¼ Ø·Ù„Ø¨ Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ Ø§Ù„Ù†ÙØ³ÙŠ</h1>"

# Ø£Ø¯Ø§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚Ø§Ù„Ø¨ (Ø­ØªÙ‰ Ù„Ø§ ÙŠØªØ¹Ø·Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ù†Ø§Ù‚ØµØ©)
def template_exists(name: str) -> bool:
    import os
    return os.path.exists(os.path.join(app.root_path, "templates", name))

# ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„ÙŠ
if __name__ == "__main__":
    # Ø¹Ù„Ù‰ Render/Ø®Ø§Ø¯Ù… Ø¥Ù†ØªØ§Ø¬ Ø§Ø³ØªØ®Ø¯Ù… Procfile + gunicorn
    app.run(host="0.0.0.0", port=5000)
