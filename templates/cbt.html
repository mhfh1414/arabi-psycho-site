<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>CBT — خطة علاجية مبدئية</title>
<style>
  body{margin:0;background:#0f2347;color:#eef3ff;font-family:"Noto Kufi Arabic",Tahoma,Arial}
  .wrap{max-width:1000px;margin:auto;padding:22px}
  h1{margin:0 0 6px} .muted{color:#c8d4f3}
  .card{background:linear-gradient(180deg,#123674cc,#0c2556cc);border:1px solid #ffffff17;border-radius:18px;padding:16px;margin-top:14px;box-shadow:0 8px 22px #0005}
  .pill{display:inline-block;background:#14366f;border:1px solid #ffffff1a;color:#dbe6ff;border-radius:999px;padding:6px 10px;font-size:12px;margin:4px 6px 0 0}
  ul{margin:8px 0 0 0; padding:0 1rem}
  .section h2{margin:0 0 8px;font-size:18px}
  .btn{background:linear-gradient(180deg,#1e3a8a,#0b1c3e);color:#fff;border:1px solid #ffffff22;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>العلاج السلوكي المعرفي (CBT) — خطة مبدئية</h1>
  <div class="muted">الخطة التالية مُقترَحة بناءً على ملخص DSM والفئات النشطة.</div>

  <div class="card">
    <h2>ملخص وارد من DSM</h2>
    {% set _active = cbt_data.active %}
    <pre style="white-space:pre-wrap;line-height:1.7">{{ cbt_data.summary }}</pre>
    <div>
      <strong>فئات نشطة:</strong>
      {% set active_list = [] %}
      {% if _active %}
        {% set active_list = _active %}
      {% endif %}
    </div>
  </div>

  <div class="card section">
    <h2>اقتراحات البروتوكول</h2>
    <div id="protocolPills"></div>
    <ul id="protocolList"></ul>
    <div style="margin-top:12px">
      <button class="btn" onclick="window.print()">طباعة / PDF</button>
    </div>
  </div>
</div>

<script>
  // نحاول قراءة JSON للفئات النشطة (قد تأتي كنص)
  let activeRaw = {{ cbt_data.active|tojson|safe }};
  // لو كان النص عبارة عن سلسلة JSON داخل سلسلة:
  if (typeof activeRaw === 'string'){
    try{ activeRaw = JSON.parse(activeRaw); }catch(_){}
  }
  const active = Array.isArray(activeRaw) ? activeRaw : [];

  // خريطة مبسطة: فئة → توصيات CBT
  const map = [
    {match:'القلق', keys:['قلق','الهلع','الرهاب','anxiety'], rec:[
      'التثقيف النفسي عن القلق ودورة القلق/تجنّب',
      'تمارين تنفّس بطني وتنظيم فسيولوجي',
      'إعادة هيكلة معرفية (أفكار كارثية → بدائل واقعية)',
      'تعريض تدريجي مع منع الأمان/الاطمئنان'
    ]},
    {match:'الاكتئاب', keys:['اكتئاب','depress'], rec:[
      'تنشيط سلوكي (جدولة أنشطة مُبهجة/ذات معنى)',
      'تحديد أفكار تلقائية سلبية ومواجهتها',
      'مهارات حل المشكلات وزيادة السلوك الهادف'
    ]},
    {match:'الوسواس', keys:['وسواس','قهرية','ocd'], rec:[
      'تعريض ومنع الاستجابة (ERP) بخطة تدريجية',
      'تتبع الطقوس والابتعاد عن طقوس الأمان',
      'عمل على المعتقدات الجوهرية (المسؤولية المبالغ بها)'
    ]},
    {match:'الصدمة', keys:['صدمة','trauma','ضغوط'], rec:[
      'تنظيم الاستثارة (grounding, تنفّس)',
      'معالجة سردية آمنة للذكرى الصادمية',
      'تعريض تخيلي تدريجي مع دعم'
    ]},
    {match:'ثنائية القطب', keys:['ثنائية','هوس','bipolar'], rec:[
      'مراقبة المزاج والنوم يوميًا',
      'بناء روتين ثابت للنوم وأنشطة خفيفة',
      'العمل المعرفي على اندفاعية القرارات'
    ]},
    {match:'الإدمان/المواد', keys:['إدمان','مواد','substance'], rec:[
      'تحليل وظيفي للمثيرات/الدوافع',
      'تجنب المثيرات العالية الخطورة + خطة طوارئ',
      'بدائل سلوكية ولائحة داعمين',
      'التزام بخطة متابعة (جلسات/مجموعات دعم)'
    ]},
    {match:'الشخصية', keys:['شخصية','personality'], rec:[
      'تنظيم انفعالي ويقظة ذهنية (DBT Skills)',
      'دوران علاقات/حدود صحية وتمارين تواصل'
    ]},
    {match:'نوم', keys:['نوم','sleep'], rec:[
      'نظافة النوم وجدولة ثابتة',
      'تقييد النوم والتحكم بالمحفزات'
    ]}
  ];

  // توليد التوصيات
  const pills = document.getElementById('protocolPills');
  const list  = document.getElementById('protocolList');

  const found = new Set();
  active.forEach(title=>{
    // نعرضها كبادجات
    const span = document.createElement('span');
    span.className = 'pill';
    span.textContent = title;
    pills.appendChild(span);

    // نطابق العنوان على الخريطة
    map.forEach(m=>{
      if (m.keys.some(k => title.includes(k))){
        m.rec.forEach(r => found.add(r));
      }
    });
  });

  // لو ما تطابقت فئات محددة، نعطي بروتوكول عام
  if (found.size === 0){
    ['تحديد الأفكار التلقائية وإعادة الهيكلة المعرفية',
     'تنشيط سلوكي وجدولة نشاطات أسبوعية',
     'مهارات استرخاء وتنفّس',
     'تتبّع تقدّم أسبوعي مع أهداف قابلة للقياس'].forEach(r => found.add(r));
  }

  // عرض القائمة
  [...found].forEach(r=>{
    const li = document.createElement('li');
    li.textContent = r;
    list.appendChild(li);
  });
</script>
</body>
</html>
