<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DSM โ ูุทุงุจูุฉ ุงูุฃุนุฑุงุถ ูุนุฑุถ ุงููุชุงุฆุฌ</title>
<style>
  :root{--bg:#0f2347;--ink:#eef3ff;--muted:#cbd5e1;--c1:#123a7acc;--c2:#0c2a59cc;--accent:#f5b546;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--chip:#14366f}
  *{box-sizing:border-box} body{margin:0;font-family:"Tajawal","Noto Kufi Arabic",Tahoma,Arial,sans-serif;background:radial-gradient(1000px 700px at 80% -10%,#1b4da0 0%,#0f2347 55%) fixed;color:var(--ink);line-height:1.9}
  .wrap{max-width:1180px;margin:auto;padding:22px}
  h1{margin:0 0 8px;font-size:clamp(22px,3vw,32px)} .sub{color:var(--muted);font-size:13px;margin-top:-6px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr)} .card{grid-column:span 12;background:linear-gradient(180deg,var(--c1),var(--c2));border:1px solid #ffffff1a;border-radius:18px;padding:16px;backdrop-filter:blur(6px);box-shadow:0 8px 22px #0005}
  @media (min-width:960px){ .sm{grid-column:span 6} } label{display:block;margin:6px 0 6px;font-weight:700}
  input,textarea,select{width:100%;background:#0a1b3b;border:1px solid #ffffff22;color:#fff;border-radius:10px;padding:10px;font-size:15px;outline:none}
  textarea{min-height:90px;resize:vertical}
  .btn{background:linear-gradient(180deg,#1e3a8a,#0b1c3e);color:#fff;border:1px solid #ffffff22;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
  .btn:active{transform:translateY(1px)} .btn.alt{background:linear-gradient(180deg,#15803d,#0b3e1b)}
  .badge{background:var(--chip);border:1px solid #ffffff22;color:#dbe6ff;border-radius:999px;padding:4px 10px;font-size:12px}
  .results h2{margin:0 0 10px} .item{border:1px solid #ffffff1a;border-radius:14px;padding:12px;margin:10px 0;background:#0b1f49cc}
  .bar{height:9px;background:#ffffff18;border-radius:999px;overflow:hidden} .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444)}
  .pill{display:inline-block;background:#14366f;border:1px solid #ffffff22;color:#dbe6ff;border-radius:999px;padding:6px 10px;font-size:12px;margin:3px 5px 0 0}
  details{border:1px solid #ffffff12;border-radius:14px;padding:10px 12px;background:#0a1e45cc} details summary{cursor:pointer;font-weight:800}
  .warn{color:var(--warn)} .bad{color:var(--bad)} .ok{color:var(--ok)} .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header style="margin-bottom:14px">
    <h1>ูุทุงุจูุฉ ุงูุฃุนุฑุงุถ (ููุท DSM) โ ุนุฑุถ ุงููุชุงุฆุฌ</h1>
    <div class="sub">ุตูุงุบุฉ ูุจุณูุทุฉ ูุบูุฑ ููุณูุฎุฉ ุญุฑูููุง. ุฃุฏุงุฉ ุฏุนู ูููุณุช ุชุดุฎูุตูุง ููุงุฆููุง.</div>
  </header>

  <!-- ูููุฐุฌ/ุจูุงูุงุช ูุฏุฎูุฉ (ุชููุฃ ุชููุงุฆููุง ูู ุฏุฑุงุณุฉ ุงูุญุงูุฉ ุฅู ููุฌุฏุช) -->
  <section class="grid">
    <div class="card sm">
      <h2>ุจูุงูุงุช ุงูุญุงูุฉ</h2>
      <label>ุงูุงุณู</label><input id="name" placeholder="โ">
      <div class="grid" style="gap:10px">
        <div class="sm"><label>ุงูุนูุฑ</label><input id="age" type="number" min="1" placeholder="โ"></div>
        <div class="sm"><label>ุงูุฌูุณ</label>
          <select id="gender"><option value="">โ</option><option>ุฐูุฑ</option><option>ุฃูุซู</option><option>ุขุฎุฑ</option></select>
        </div>
      </div>
      <label>ูุฏูุฉ ุงูุฃุนุฑุงุถ (ุจุงูุฃูุงู)</label><input id="duration" type="number" min="0" placeholder="โ">
    </div>
    <div class="card sm">
      <h2>ูุตู ุงูุฃุนุฑุงุถ</h2>
      <label>ุงูุฃุนุฑุงุถ</label><textarea id="symptoms" placeholder="ุงููุต ุงูุฐู ุฃุฏุฎูู ุงูุนููู"></textarea>
      <label>ุงูุชุงุฑูุฎ ุงูุทุจู/ุงูููุณู</label><textarea id="history" placeholder="ุงุฎุชูุงุฑู"></textarea>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button class="btn" onclick="analyze()">ุชุญููู ุงูุฃุนุฑุงุถ</button>
        <button class="btn alt" onclick="resetForm()">ูุณุญ</button>
        <span class="badge">ูุง ูุชู ุญูุธ ุงูุจูุงูุงุช</span>
      </div>
    </div>
  </section>

  <!-- ุงููุชุงุฆุฌ -->
  <section id="results" class="card results" style="margin-top:14px;display:none">
    <h2>๐ฏ ุงููุชุงุฆุฌ ุงููุฑุชุจุฉ ุญุณุจ ุงูุซูุฉ</h2>
    <div id="flags" class="muted" style="margin:-6px 0 8px"></div>
    <div id="list"></div>
    <div class="muted" style="margin-top:8px">โ๏ธ ููุงุณุชุฑุดุงุฏ ููุท โ ูููุตุญ ุจูุฑุงุฌุนุฉ ูุฎุชุต ุนูุฏ ุงูุญุงุฌุฉ.</div>
  </section>

  <!-- ูุชุงููุฌ ุงูุงุถุทุฑุงุจุงุช (ูุฑุฌุน ูุจูุฑ) -->
  <section class="card" style="margin-top:14px">
    <h2>๐ ูุฑุฌุน ุงูุงุถุทุฑุงุจุงุช</h2>
    <p class="muted">ูุงุฆูุฉ ูุงุณุนุฉ ููุจุณูุทุฉ ุชุบุทู ุงูุงุถุทุฑุงุจุงุช ุงูุดุงุฆุนุฉ (ูุฒุงุฌุ ูููุ ูุณูุงุณุ ุตุฏูุฉุ ุฐูุงููุ ููุงุฆูุ ูููุ ุฃููุ ุฌุณุฏู ุงูุดููุ ุดุฎุตูุฉุ ุฅุฏูุงู...).</p>
    <div id="catalog"></div>
  </section>
</div>

<!-- ููุฑูุฑ ุจูุงูุงุช ุฏุฑุงุณุฉ ุงูุญุงูุฉ ูู Flask ููุชููุฆุฉ -->
<script>window.CASE={{ case_data|tojson|safe }};</script>

<script>
/* ========== ููุงุนุฏ ุงููุทุงุจูุฉ (ูุฎุชุตุฑุฉ ููุง โ ููุณ ุฑูุญ DSM ุจุฏูู ูุณุฎ ุญุฑูู) ========== */
const RULES=[ /* ููุณ ุงููุฌููุนุฉ ุงููุงุณุนุฉ ูู ุงูููุงุนุฏ ููุง ูู ุงูุฑุฏ ุงูุณุงุจู (MDE, GAD, PANIC, OCD, PTSD, PSY, MANIA, PDD, SAD, PHOBIA, ADHD_A, ASD, SSD, IAD, AN, BN, BED, INS, SUD, BPD_S, DISS) */
  {code:'MDE',name:'ููุจุฉ ุงูุชุฆุงุจูุฉ ูุจุฑู',group:'ุงููุฒุงุฌ',min:5,core:['ุญุฒู','ูุขุจุฉ','ูุฒุงุฌ ููุฎูุถ','ููุฏุงู ุงููุชุนุฉ','ุนุฏู ุงุณุชูุชุงุน'],durationMin:14,keys:['ุญุฒู','ูุขุจุฉ','ููุฏุงู ุงููุชุนุฉ','ุนุฏู ุงุณุชูุชุงุน','ุฃุฑู','ููู ูููู','ูุนุงุณ ุฒุงุฆุฏ','ุดููุฉ ููุฎูุถุฉ','ููุฏุงู ูุฒู','ุดููุฉ ุฒุงุฆุฏุฉ','ุชุจุงุทุค','ุฅุซุงุฑุฉ ููุณูุฉ ุญุฑููุฉ','ุฅุฑูุงู','ุทุงูุฉ ููุฎูุถุฉ','ุฐูุจ','ุนุฏูู ุงููููุฉ','ููู ุงูุฐุงุช','ุตุนูุจุฉ ุชุฑููุฒ','ุชุดุชุช','ุจุทุก ุงูุชูููุฑ','ุฃููุงุฑ ุงูุชุญุงุฑ','ุชููู ุงูููุช'],red:['ุงูุชุญุงุฑ','ุฃุคุฐู ููุณู','ูุชู ููุณู'],tips:['ุงูุนูุงุฌ ุงูุณูููู ุงููุนุฑูู ูููุฏ','ุงุณุชุดุงุฑุฉ ูุฎุชุต ุนูุฏ ุงุดุชุฏุงุฏ ุงูุฃุนุฑุงุถ']},
  {code:'PDD',name:'ุงูุชุฆุงุจ ูุณุชูุฑ (ูุฒูู)',group:'ุงููุฒุงุฌ',min:2,core:['ูุฒุงุฌ ููุฎูุถ'],durationMin:730,keys:['ูุฒุงุฌ ููุฎูุถ','ููุฏุงู ุดููุฉ','ุฒูุงุฏุฉ ุดููุฉ','ููู ุฒุงุฆุฏ','ุฃุฑู','ุทุงูุฉ ููุฎูุถุฉ','ุชูุฏูุฑ ุฐุงุช ูุชุฏู','ุชุฑููุฒ ุถุนูู','ุชุฑุฏุฏ'],red:[],tips:['ุชุชุจูุน ุงููุฒุงุฌ ูุงูุฏุนู ุงูููุณู']},
  {code:'MANIA',name:'ููุณ (ุซูุงุฆู ุงููุทุจ)',group:'ุงููุฒุงุฌ',min:3,core:['ูุฒุงุฌ ูุฑุชูุน','ููุฌุงู ุบูุฑ ูุนุชุงุฏ','ุทุงูุฉ ุนุงููุฉ'],durationMin:7,keys:['ุซูุฉ ููุฑุทุฉ','ููุฉ ุญุงุฌุฉ ููููู','ููุงู ูุซูุฑ','ุซุฑุซุฑุฉ','ุฃููุงุฑ ุณุจุงู','ุชุดุชูุช ุณุฑูุน','ุงูุฏูุงุน','ูุฎุงุทุฑุฉ ูุงููุฉ','ุณููู ุฌูุณู ูุชููุฑ'],red:['ุงูุฏูุงุน ุฎุทูุฑ','ูุฎุงุทุฑุฉ ุดุฏูุฏุฉ'],tips:['ุชููููู ุทุจูุจ ููุณู ุถุฑูุฑู']},
  {code:'GAD',name:'ููู ูุนููู',group:'ุงูููู',min:3,core:['ููู','ุชูุชุฑ','ุฎูู ูุณุชูุฑ'],durationMin:180,keys:['ุชูุชุฑ','ุนุตุจูุฉ','ุชุนุจ','ุฅุฑูุงู','ุตุนูุจุฉ ุชุฑููุฒ','ุชุดุชูุช','ุดุฏ ุนุถูู','ุฃุฑู','ุตุญู ูุชูุฑุฑ','ููู ุนูู ุฃุดูุงุก ูุซูุฑุฉ','ููู ููุฑุท'],red:[],tips:['ุชูุงุฑูู ุงูุงุณุชุฑุฎุงุก ูCBT ูุนูุงูุฉ']},
  {code:'PANIC',name:'ููุจุงุช ููุน',group:'ุงูููู',min:4,core:['ููุจุฉ','ููุน','ุฎูู ุดุฏูุฏ ูุฌุฃุฉ'],durationMin:0,keys:['ุฎููุงู','ุฑุฌูุฉ','ุชุนุฑู','ุถูู ููุณ','ุงุฎุชูุงู','ุฃูู ุตุฏุฑ','ุฏูุฎุฉ','ุบุซูุงู','ุบุฑุจุฉ ุงููุงูุน','ุฎูู ูู ุงูููุช','ุฎุฏุฑ','ุชูููู','ูุดุนุฑูุฑุฉ','ุณุฎููุฉ'],red:['ููุฏุงู ูุนู ูุชูุฑุฑ'],tips:['ุชุฏุฑูุจ ุชูููุณ ูุฃุฑุถูุฉ','ุชูููู ุฑูุงุจ ุงูุณุงุญ ุฅู ููุฌุฏ']},
  {code:'SAD',name:'ููู ุงุฌุชูุงุนู',group:'ุงูููู',min:3,core:['ุฎูู ูู ุงูุชูููู','ููู ุงุฌุชูุงุนู','ุฎุฌู ุดุฏูุฏ'],durationMin:180,keys:['ุชุฌููุจ ููุงูู ุงุฌุชูุงุนูุฉ','ุงุญูุฑุงุฑ','ุงุฑุชุฌุงู','ุชุนุฑูู','ุชุนุทูู ูุธููู'],red:[],tips:['ุชุนุฑุถ ุชุฏุฑูุฌู ูููุงุฑุงุช ุงุฌุชูุงุนูุฉ']},
  {code:'PHOBIA',name:'ุฑููุงุจ ูุญุฏุฏ',group:'ุงูููู',min:2,core:['ุฎูู ุดุฏูุฏ ูู ุดูุก ูุญุฏุฏ','ููุจูุง'],durationMin:180,keys:['ุชุฌููุจ ุงูุดูุก','ุชุญููู ูุน ููู ุดุฏูุฏ','ุชุนุทูู ูุธููู'],red:[],tips:['ุงูุชุนุฑูุถ ุงูุชุฏุฑูุฌู ูุนูุงู ุฌุฏูุง']},
  {code:'OCD',name:'ูุณูุงุณ ููุฑู',group:'ูุณูุงุณ/ููุฑ',min:2,core:['ูุณุงูุณ','ุฃููุงุฑ ูุชุณูุทุฉ'],durationMin:30,keys:['ุณููู ููุฑู','ุบุณู ูุชูุฑุฑ','ุชููุฏ ุงูุฃุจูุงุจ','ุชุฑุชูุจ','ุนุฏู ูุชูุฑุฑ','ุถูู ุฅู ุชูููุช ุงูุทููุณ'],red:[],tips:['ERP (ุงูุชุนุฑูุถ ูููุน ุงูุงุณุชุฌุงุจุฉ) ูู ุงูุนูุงุฌ ุงูุฃุจุฑุฒ']},
  {code:'PTSD',name:'ูุง ุจุนุฏ ุงูุตุฏูุฉ',group:'ุงูุตุฏูุฉ',min:4,core:['ุญุงุฏุซุฉ ุตุงุฏูุฉ','ุงุนุชุฏุงุก','ุญุฑุจ','ุญุงุฏุซ ุดุฏูุฏ'],durationMin:30,keys:['ุฐูุฑูุงุช ุงูุชุญุงููุฉ','ููุงุจูุณ','ุชุฌููุจ ูุฐููุฑุงุช','ุชููุธ ููุฑุท','ุงุณุชุซุงุฑุฉ','ููุจุงุช ุบุถุจ','ุฎุฏุฑ ุนุงุทูู','ุงููุตุงู'],red:['ุฎุทุฑ ุนูู ุงูููุณ ุฃู ุงูุขุฎุฑูู'],tips:['ุนูุงุฌ ูุนุฑูู ูุชูุฑูุฒ ุนูู ุงูุตุฏูุฉ / EMDR']},
  {code:'PSY',name:'ุฐูุงู/ุทูู ูุตุงูู',group:'ุฐูุงูู',min:2,core:['ููุงูุณ','ุถูุงูุงุช','ุชููู ููุงู'],durationMin:30,keys:['ููุงูุณ ุณูุนูุฉ','ุฃููุงุฑ ุงุถุทูุงุฏ','ุชููู ุงูุชูููุฑ','ุงูุณุญุงุจ ุงุฌุชูุงุนู','ุฅููุงู ุฐุงุช'],red:['ุฃุตูุงุช ุชุฃูุฑ','ุฎุทูุฑุฉ ุนูู ุงูุขุฎุฑูู'],tips:['ุชูููู ุทุจู ูุจููุฑ ููู']},
  {code:'ADHD_A',name:'ูุฑุท ุญุฑูุฉ ูุชุดุชุช (ุจุงูุบ)',group:'ููุงุฆู',min:5,core:['ุชุดุชุช','ููุต ุงูุชุจุงู','ุงูุฏูุงุน'],durationMin:180,keys:['ูุณูุงู','ููุฏ ุงูุฃุดูุงุก','ุชุฃุฌูู','ุนุฏู ุฅูุฌุงุฒ','ุจุฏุก ููุงู ูุซูุฑุฉ','ุญุฑูุฉ ุฒุงุฆุฏุฉ','ุชูุชุฑ ุฌุณุฏู','ููุงุทุนุฉ ุงูุขุฎุฑูู','ุงูุฏูุงุนูุฉ'],red:[],tips:['ุชูุธูู ุงูููุช ูุงุณุชุฑุงุชูุฌูุงุช ุณููููุฉ']},
  {code:'ASD',name:'ุทูู ุชูุญุฏ (ูุญุต ุจุงูุบูู)',group:'ููุงุฆู',min:4,core:['ุตุนูุจุงุช ุชูุงุตู ุงุฌุชูุงุนู ููุฐ ุงูุทูููุฉ'],durationMin:365,keys:['ุญุณุงุณูุฉ ููุฃุตูุงุช','ุญุณุงุณูุฉ ูููุณ','ุงูุชูุงูุงุช ุถููุฉ','ุฑูุชูู ุตุงุฑู','ุตุนูุจุฉ ูุฑุงุกุฉ ุงูุฅุดุงุฑุงุช ุงูุงุฌุชูุงุนูุฉ','ุชุงุฑูุฎ ููุฐ ุงูุทูููุฉ'],red:[],tips:['ุชูููู ูุชุฎุตุต ููุชุดุฎูุต ุงููุคูุฏ']},
  {code:'SSD',name:'ุฃุนุฑุงุถ ุฌุณุฏูุฉ ูุน ููู ุตุญู',group:'ุฌุณุฏู ุงูุดูู',min:2,core:['ุฃุนุฑุงุถ ุฌุณุฏูุฉ ูุฒููุฉ','ููู ุนูู ุงูุตุญุฉ'],durationMin:180,keys:['ุชูููุฑ ููุฑุท ุจุงูุฃุนุฑุงุถ','ูุญูุตุงุช ูุชูุฑุฑุฉ','ููู ุตุญู ูุณุชูุฑ'],red:[],tips:['ุงูุชุซููู ูุฅุฏุงุฑุฉ ุงูููู ููููุงู']},
  {code:'IAD',name:'ููู ูุฑุถู (ููู ุนูู ุงูุตุญุฉ)',group:'ุฌุณุฏู ุงูุดูู',min:1,core:['ููู ุตุญู'],durationMin:180,keys:['ุฎูู ูู ูุฑุถ ุฎุทูุฑ','ุงุทูุฆูุงู ุทุจู ูุชูุฑุฑ','ุชููุฏ ูุณุชูุฑ ูุฃุนุฑุงุถ ุฌุณุฏูุฉ'],red:[],tips:['CBT ูุณุชูุฏู ุงููุจุงูุบุฉ ุงูุฅุฏุฑุงููุฉ']},
  {code:'AN',name:'ููุฏุงู ุดููุฉ ุนุตุจู',group:'ุฃูู',min:3,core:['ูุญุงูุฉ ุดุฏูุฏุฉ','ุฎูู ูู ุฒูุงุฏุฉ ุงููุฒู'],durationMin:90,keys:['ุชูููุฏ ุงูุฃูู','ุญุณุงุจ ุงูุณุนุฑุงุช','ุตูุฑุฉ ุฌุณู ูุดูููุฉ','ุฏูุฎุฉ','ุงููุทุงุน ุญูุถ'],red:['ุฏูุงุฑ ุดุฏูุฏ','ุฅุบูุงุก','ุจุทุก ููุจ'],tips:['ูุฑูู ูุชุนุฏุฏ ุงูุชุฎุตุตุงุช ูุทููุจ']},
  {code:'BN',name:'ููุงู ุนุตุจู',group:'ุฃูู',min:3,core:['ููู','ุฅูุฑุงุท ูู ุงูุฃูู'],durationMin:90,keys:['ุณููู ุชุนููุถู (ููุก/ูุณูู/ุตูู)','ุชุฃุซุฑ ุชูุฏูุฑ ุงูุฐุงุช ุจุงููุฒู','ููุจุงุช ูุชูุฑุฑุฉ'],red:[],tips:['CBT-E ุฎูุงุฑ ูุนูุงู']},
  {code:'BED',name:'ููู ุงูุทุนุงู',group:'ุฃูู',min:3,core:['ููู'],durationMin:90,keys:['ุฃูู ุณุฑูุน ุฌุฏูุง','ุฃูู ุญุชู ุงูุงูุฒุนุงุฌ','ุฃูู ุฏูู ุฌูุน','ุดุนูุฑ ุจุงูุฐูุจ ุจุนุฏ ุงูููู'],red:[],tips:['ุชูุธูู ุงููุฌุจุงุช ูุฏุนู ุณูููู']},
  {code:'INS',name:'ุฃุฑู ูุฒูู',group:'ููู',min:1,core:['ุฃุฑู','ุตุนูุจุฉ ููู','ุงุณุชููุงุธ ูุจูุฑ'],durationMin:90,keys:['ุตุนูุจุฉ ุจุฏุก ุงูููู','ุตุญู ูุชูุฑุฑ','ูุนุงุณ ููุงุฑู','ุชุนุจ'],red:[],tips:['CBT-I ููุธุงูุฉ ุงูููู']},
  {code:'SUD',name:'ุงุถุทุฑุงุจ ุชุนุงุทู ููุงุฏ',group:'ุฅุฏูุงู',min:3,core:['ุชุนุงุทู','ูุฎุฏุฑุงุช','ูุญูู','ููุจููุงุช'],durationMin:90,keys:['ุฑุบุจุฉ ูููุฉ','ููุฏ ุงูุณูุทุฑุฉ','ุฃูุซุฑ ููุง ุฃููู','ูุญุงููุงุช ูุงุดูุฉ','ููุช ุทููู ููุชุนุงุทู/ุงูุชุนุงูู','ูุดุงูู ุงุฌุชูุงุนูุฉ/ููููุฉ','ุชุญููู','ุงูุณุญุงุจ'],red:['ุชุนุงุทู ุญูู','ุฅุบูุงุก','ุฌุฑุนุฉ ุฒุงุฆุฏุฉ'],tips:['ุฎุทุฉ ุงูุชูุงุน + ุฏุนู + ุฃุญูุงููุง ุฏูุงุก']},
  {code:'BPD_S',name:'ููุท ุนุงุทูู ุบูุฑ ูุณุชูุฑ (ูุญุต)',group:'ุดุฎุตูุฉ',min:5,core:['ุงูุฏูุงุน','ุนูุงูุงุช ูุถุทุฑุจุฉ','ุชูููุจ ูุฒุงุฌ'],durationMin:180,keys:['ุฎูู ูุฌุฑ','ุงูุฏูุงุน ูุคุฐู ููุฐุงุช','ูุฑุงุบ ูุฒูู','ุบุถุจ ุดุฏูุฏ','ุฅูุฐุงุก ุงูุฐุงุช','ูุฏูุจ'],red:['ุงูุชุญุงุฑ','ุฅูุฐุงุก ุงูุฐุงุช'],tips:['ููุงุฑุงุช DBT ูุชูุธูู ุงููุนุงูู']},
  {code:'DISS',name:'ุชูุงุฑูู (ูุฌูุงุช/ุชุจุฏุฏ/ุชุบุฑูุจ)',group:'ุชูุงุฑูู',min:2,core:['ูุฌูุงุช ุฐุงูุฑุฉ','ุชุจุฏุฏ','ุชุบุฑูุจ'],durationMin:0,keys:['ุงููุตุงู','ุฅุญุณุงุณ ุจุนุฏู ุงููุงูุนูุฉ','ูุณูุงู ุฃุญุฏุงุซ ูููุฉ'],red:[],tips:['ุชูููู ูุชุฎุตุต ุนูุฏ ุงูุดู']},
];

/* ========== ุชููุฆุฉ ุชููุงุฆูุฉ ูู ุฏุฑุงุณุฉ ุงูุญุงูุฉ ========== */
(function prefill(){
  try{
    const d = (window.CASE||{});
    if(d.name)     document.getElementById('name').value = d.name;
    if(d.age)      document.getElementById('age').value = d.age;
    if(d.gender)   document.getElementById('gender').value = d.gender;
    if(d.duration) document.getElementById('duration').value = d.duration;
    if(d.symptoms) document.getElementById('symptoms').value = d.symptoms;
    if(d.history)  document.getElementById('history').value = d.history;
    if(d.symptoms) analyze();
  }catch(_){}
})();

/* ========== ุงูุชุญููู ูุงูุนุฑุถ ========== */
function normalize(t){return (t||'').toString().trim().toLowerCase();}
function analyze(){
  const dur = parseInt(document.getElementById('duration').value||'0',10)||0;
  const txt = normalize([document.getElementById('symptoms').value, document.getElementById('history').value].join(' '));

  const flags=[];
  if(txt.includes('ุงูุชุญุงุฑ')||txt.includes('ุฃุคุฐู ููุณู')||txt.includes('ูุชู ููุณู')) flags.push('โ๏ธ ูุคุดุฑุงุช ุฎุทุฑ ุนูู ุงูููุณ โ ุงุทูุจ ูุณุงุนุฏุฉ ุนุงุฌูุฉ');
  if(txt.includes('ุฃุตูุงุช')||txt.includes('ููุงูุณ')||txt.includes('ุถูุงูุงุช')) flags.push('โ๏ธ ูุคุดุฑุงุช ุฐูุงููุฉ โ ููุฒู ุชูููู ุณุฑูุน');

  const scored = RULES.map(r=>{
    const coreHit = r.core.length===0?true:r.core.some(k=>txt.includes(k));
    if(!coreHit) return null;
    let met=0, matched=[];
    r.keys.forEach(k=>{
      const variants = k.split('/').join('|').split('|').map(x=>x.trim()).filter(Boolean);
      if(variants.some(v=>txt.includes(v))) { met++; matched.push(k); }
    });
    if(met<r.min) return {r,score:0,met,matched};
    const coverage = met/Math.max(r.keys.length,r.min);
    let score = 1/(1+Math.exp(-8*(coverage-0.5)));
    if(r.durationMin && dur>=r.durationMin) score=Math.min(1,score+0.1);
    if(r.durationMin && dur>0 && dur<r.durationMin/2) score=Math.max(0,score-0.1);
    const reds=(r.red||[]).filter(x=>txt.includes(x));
    return {r,score,met,matched,reds};
  }).filter(Boolean).sort((a,b)=>b.score-a.score);

  const results=document.getElementById('results');
  const list=document.getElementById('list');
  const flagsBox=document.getElementById('flags');
  list.innerHTML=''; flagsBox.innerHTML='';
  if(flags.length) flagsBox.innerHTML=flags.map(f=>`<div class="bad">${f}</div>`).join('');

  if(scored.length===0){
    results.style.display='block';
    list.innerHTML=`<div class="item"><b>ูุง ุชูุฌุฏ ูุทุงุจูุฉ ูุงููุฉ</b><div class="muted">ุฌุฑูุจ ูุตููุง ุฃุฏู ููุฃุนุฑุงุถ ูุงููุฏุฉ.</div></div>`;
    return;
  }

  scored.slice(0,10).forEach(({r,score,met,matched,reds})=>{
    const pct=Math.round(score*100);
    const redsHtml=(reds&&reds.length)?`<div class="bad" style="margin-top:6px">โ๏ธ ุฃุนูุงู ุญูุฑุงุก: ${reds.join('ุ ')}</div>`:'';
    const tipsHtml=(r.tips&&r.tips.length)?`<div class="muted" style="margin-top:6px">ุงูุชุฑุงุญุงุช: ${r.tips.join(' โ ')}</div>`:'';
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px">
        <div><b>${r.name}</b> <span class="muted">(${r.group})</span></div>
        <div style="min-width:120px;text-align:left"><small>ุงูุซูุฉ</small></div>
      </div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="muted" style="margin-top:6px">ุฃุนุฑุงุถ ูุทุงุจูุฉ: ${met} โข ุงูุญุฏ ุงูุฃุฏูู: ${r.min}${r.durationMin?` โข ุงููุฏุฉ ุงูููุตู ุจูุง โฅ ${r.durationMin} ููู`:''}</div>
      ${matched.length?`<div style="margin-top:6px">${matched.slice(0,6).map(k=>`<span class="pill">${k}</span>`).join(' ')}</div>`:''}
      ${redsHtml}
      ${tipsHtml}
    `;
    list.appendChild(el);
  });

  results.style.display='block';
}

/* ========== ูุชุงููุฌ ูุงูู ููุชุตูุญ ========== */
function renderCatalog(){
  const byGroup={}; RULES.forEach(r=>{(byGroup[r.group]=byGroup[r.group]||[]).push(r);});
  const root=document.getElementById('catalog'); root.innerHTML='';
  Object.keys(byGroup).forEach(group=>{
    const box=document.createElement('details'); box.open=false;
    const items=byGroup[group].map(r=>{
      const keys=r.keys.slice(0,8).map(k=>`<span class="pill">${k}</span>`).join(' ');
      return `<div class="item"><div><b>${r.name}</b> <span class="muted">โ ุงูุญุฏ ุงูุฃุฏูู: ${r.min}${r.durationMin?`, ุงููุฏุฉ โฅ ${r.durationMin} ููู`:''}</span></div><div style="margin-top:6px">${keys}</div></div>`;
    }).join('');
    box.innerHTML=`<summary>${group}</summary>${items}`;
    root.appendChild(box);
  });
}
renderCatalog();

/* ========== ุฃุฏูุงุช ========== */
function resetForm(){
  ['name','age','gender','duration','symptoms','history'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('results').style.display='none';
}
</script>
</body>
</html>
