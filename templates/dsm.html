<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุฏุฑุงุณุฉ ุญุงูุฉ + ุชุดุฎูุต DSM-5 (ููุณูุน)</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .form-section{background:#ffffff10;padding:16px;border-radius:14px;margin-bottom:18px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .pill{background:#101a4dcc;border:1px solid #2a3a86;padding:10px 14px;border-radius:12px}
    .muted{opacity:.85}
    .result{background:#0b1437cc;color:#fff;border-radius:18px;padding:22px;margin:18px 0}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#17b169;margin-inline-start:8px;font-size:.8rem}
    .weak{background:#777}
    .ok{background:#0ea5e9}
    .strong{background:#eab308;color:#222}
    .notes{line-height:1.9}
    .list{margin:0;padding-inline-start:18px}
    details{background:#ffffff0b;border:1px solid #ffffff20;border-radius:12px;margin:8px 0;padding:10px}
    summary{cursor:pointer;font-weight:800}
    .catalog{max-width:1080px;margin:18px auto;padding:0 6px}
    .hr{height:1px;background:#ffffff22;margin:14px 0}
    .hint{color:#dbe6ffb8;font-size:.95rem}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#f9c846;color:#2b1e00;border-radius:999px;padding:6px 10px;font-weight:800}
  </style>
</head>
<body class="hero">

  <header class="center">
    <h1>๐ ุฏุฑุงุณุฉ ุญุงูุฉ + ุชุดุฎูุต DSM-5 (ููุณูุน)</h1>
    <p class="sub">ุงููุฃ ุจูุงูุงุชู ุซู ุงุญุตู ุนูู ุชุญููู ุชูุฏูุฑู ูุจูู ุนูู ูุงุนุฏุฉ ููุณูุนุฉ ูู ุงูุงุถุทุฑุงุจุงุช โ ูุง ููุบูู ุนู ุงูุชูููู ุงูุฅููููููู.</p>
  </header>

  <!-- ===== ูููุฐุฌ ุฅุฏุฎุงู ===== -->
  <section class="form-section">
    <form action="{{ url_for('case_dsm') }}" method="post" class="card small">
      <div class="grid-auto">
        <label>ุงูุงุณู ุงููุงูู:
          <input name="full_name" value="{{ full_name or '' }}">
        </label>
        <label>ุงูุนูุฑ:
          <input name="age" type="number" min="1" max="120" value="{{ age or '' }}">
        </label>
        <label>ุงูุฌูุณ:
          <select name="gender">
            <option value="" {% if not gender %}selected{% endif %}>โ ุงุฎุชุฑ โ</option>
            <option {% if gender=='ุฐูุฑ' %}selected{% endif %}>ุฐูุฑ</option>
            <option {% if gender=='ุฃูุซู' %}selected{% endif %}>ุฃูุซู</option>
          </select>
        </label>
        <label>ูุฏุฉ ุงูุฃุนุฑุงุถ (ุจุงูุฃูุงู):
          <input name="duration_days" type="number" min="0" value="{{ duration_days or '' }}">
        </label>
      </div>

      <label>ุงูุฃุนุฑุงุถ (ุฃูุชุจ ุจุชูุตูู):
        <textarea name="symptoms" rows="4" placeholder="ูุซุงู: ุญุฒู ูุฒููุ ููุฏุงู ูุชุนุฉุ ุฃุฑูุ ุฃููุงุฑ ุชุดุงุคููุฉ...">{{ symptoms or '' }}</textarea>
      </label>

      <label>ุงูุชุงุฑูุฎ ุงูุทุจู/ุงูููุณู (ุงุฎุชูุงุฑู):
        <textarea name="history" rows="3" placeholder="ุฃุฏููุฉ ุญุงููุฉุ ุชุดุฎูุตุงุช ุณุงุจูุฉุ ุฃูุฑุงุถ ูุฒููุฉุ ุฃุญุฏุงุซ ุตุงุฏูุฉ...">{{ history or '' }}</textarea>
      </label>

      <div class="actions">
        <button class="btn" type="submit">๐ ุชุญููู ูุชุดุฎูุต</button>
        <a class="btn ghost" href="{{ url_for('home') }}">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
      </div>
    </form>
    <p class="hint">๐ก ุฏููุฉ ุงููุชูุฌุฉ ุชุชุญุณู ูููุง ูุตูุช ุงููุฏุฉ/ุงูุดุฏุฉ/ุงููุญูุฒุงุช/ุงูุฃููุงุช/ุงูุณูุงู.</p>
  </section>

  <!-- ===== ุงููุชุงุฆุฌ (ุชุธูุฑ ููุท ุจุนุฏ ุงูุฅุฑุณุงู) ===== -->
  {% if symptoms %}
  <section class="card">
    <h2>๐ ุฃุนูู ุงูุชุฑุดูุญุงุช ุงูุชุดุฎูุตูุฉ</h2>
    <div id="out"></div>
  </section>
  {% endif %}

  <div class="catalog">
    <div class="hr"></div>
    <h2>๐ ูุชุงููุฌ ูุฑุฌุนู (DSM-5 ููุณูุน)</h2>
    <p class="hint">ูุฐุง ุงููุชุงููุฌ ูููุฑุงุกุฉ ุงูุณุฑูุนุฉ โ ุงูุชุญููู ุงูุขูู ูุนุชูุฏ ุนูู ููุฑุณ ูููุงุช ููุณูุน ุจุงูุฃุณูู.</p>
    <div id="catalog"></div>
  </div>

  <footer class="footer">
    <a class="btn ghost" href="{{ url_for('home') }}">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
  </footer>

  {% if symptoms or True %}
  <script>
    // ======  ุงูุฅุฏุฎุงู ูู ุงูุฎุงุฏู  ======
    const FORM = {
      name: `{{ (full_name or '')|e }}`,
      age: parseInt(`{{ (age or '0')|e }}`) || null,
      gender: `{{ (gender or '')|e }}`.trim(),
      duration: parseInt(`{{ (duration_days or '0')|e }}`) || 0,
      symptoms: `{{ (symptoms or '')|e }}`.toLowerCase(),
      history: `{{ (history or '')|e }}`.toLowerCase()
    };

    // ======  ุฃุฏูุงุช ุชูุธูู ุนุฑุจูุฉ ======
    const stripDiacritics = s =>
      s.replace(/[\u064B-\u0652]/g,'') // ุญุฑูุงุช
       .replace(/ุฃ|ุฅ|ุข/g,'ุง')
       .replace(/ุฉ/g,'ู')
       .replace(/ู/g,'ู')
       .replace(/ุค/g,'ู').replace(/ุฆ/g,'ู');

    const norm = s => stripDiacritics(
      (s||'').toLowerCase()
        .replace(/[^\u0600-\u06FFa-z0-9\s]/g,' ')
        .replace(/\s+/g,' ')
        .trim()
    );

    const hasAny = (t,a)=>a?.some(k=>t.includes(k))||false;
    const countHits=(t,a)=> (a||[]).reduce((n,k)=> n+(t.includes(k)?1:0), 0);

    // ======  ูุงุนุฏุฉ ููุณูุนุฉ (ูุฌููุนุฉ ุจุญุณุจ ุงููุตูู) ======
    // ูู ุนูุตุฑ: { group, code, name, aka?, any[], all?, exclude?, minDays?, tips[] }
    const CATALOG = [
      // โโโ ุงุถุทุฑุงุจุงุช ุงููุฒุงุฌ/ุงูุงูุชุฆุงุจ โโโ
      {group:"ุงุถุทุฑุงุจุงุช ุงูุชุฆุงุจูุฉ", code:"MDD", name:"ุงูุงูุชุฆุงุจ ุงูุดุฏูุฏ (MDD)",
        aka:["ุงูุชุฆุงุจ","ุญุฒู","ุถููุฉ","ุถููู","ูุฒุงุฌ ููุฎูุถ","ููุฏุงู ุงููุชุนุฉ","ุงูุนุฏุงู ุงููุชุนุฉ","ูุง ุนุงุฏ ุงุณุชูุฐ"],
        any:["ุญุฒู","ููุฏุงู ุงููุชุนู","ุงูุนุฏุงู ุงููุชุนู","ูุงุณ","ุงูุนุฏุงู ูููู","ุฐูุจ","ุงูุณุญุงุจ","ุงุฑูุงู","ุงุฑู","ููู ุฒุงุฆุฏ","ููุต ุดููู","ุฒูุงุฏู ุดููู","ุงูุชุญุงุฑ","ุชูููุฑ ุจุงูููุช"],
        minDays:14, tips:["ุชูุดูุท ุณูููู","CBT","SSRI","ุงูุชุฃูุฏ ูู ุงูุณูุงูุฉ ูุฅุฏุงุฑุฉ ุฃููุงุฑ ุงูุชุญุงุฑูุฉ"]},
      {group:"ุงุถุทุฑุงุจุงุช ุงูุชุฆุงุจูุฉ", code:"PDD", name:"ุงูุงูุชุฆุงุจ ุงููุณุชูุฑ (ุฏูุณุชูููุง)",
        aka:["ุญุฒู ูุฒูู","ูุชูู ูุฒููู"], any:["ูุฒุงุฌ ููุฎูุถ","ุญุฒู","ุทุงูู ููุฎูุถู","ููุต ุซูู","ุชุดุงุคู"], minDays:365,
        tips:["CBT ุทููู ุงูุฃูุฏ","ุชูุธูู ููุท ุงูุญูุงุฉ ูุงูููู","ุฃุฏููุฉ ุนูุฏ ุงูุญุงุฌุฉ"]},
      {group:"ุงุถุทุฑุงุจุงุช ุงูุชุฆุงุจูุฉ", code:"PMDD", name:"ุงุถุทุฑุงุจ ูุฒุนุฌ ุณุงุจู ููุญูุถ",
        aka:["ุชููุจ ูุฒุงุฌ ูุจู ุงูุฏูุฑู"], any:["ุชููุจ","ุชููุฌ","ุงูุชุฆุงุจ ูุจู ุงูุฏูุฑู","ุงูู ูุจู ุงูุฏูุฑู"], tips:["ุชุชุจูุน ุงูุฃุนุฑุงุถ","SSRI ุทูุฑ ููุชูุงู"]},

      // โโโ ุงุถุทุฑุงุจุงุช ุซูุงุฆูุฉ ุงููุทุจ โโโ
      {group:"ุซูุงุฆู ุงููุทุจ", code:"BP1", name:"ุซูุงุฆู ุงููุทุจ ุงูููุน ุงูุฃูู",
        any:["ููุจู ููุณ","ููุณ","ูุดูู","ููู ููู ุฏูู ุชุนุจ","ููุงู ุณุฑูุน","ุงููุงุฑ ูุซูุฑู","ุงูุฏูุงุน","ุงููุงู ุฒุงุฆุฏ","ุงููุงุฑ ุนุธูู"],
        exclude:["ุญุฒู ููุท"], minDays:7, tips:["ูุซุจุชุงุช ูุฒุงุฌ","ุชุซููู ุฃุณุฑู","ุณูุงูุฉ"]},
      {group:"ุซูุงุฆู ุงููุทุจ", code:"BP2", name:"ุซูุงุฆู ุงููุทุจ ุงูููุน ุงูุซุงูู (ููุณ ุฎููู + ุงูุชุฆุงุจ)",
        any:["ููุณ ุฎููู","ุทุงูู ุนุงููู","ููู ููู","ุงูุชุฆุงุจ"], minDays:4, tips:["ุชุซุจูุช ูุฒุงุฌ","ุชุชุจุน ููู"]},

      // โโโ ุงูููู ูุงูุฑูุงุจ โโโ
      {group:"ุงุถุทุฑุงุจุงุช ุงูููู", code:"GAD", name:"ููู ูุนููู (GAD)",
        aka:["ุชูุชุฑ","ููู","ุชูููุฑ ุฒุงูุฏ","ุถููู"], any:["ููู","ุชูุชุฑ","ุชูููุฑ ุฒุงูุฏ","ุดุฏ ุนุถูู","ุชุนุจ ุณุฑูุน","ุตุนูุจู ุชุฑููุฒ","ุงุฑู"], minDays:180,
        tips:["CBT ููููู","ุงุณุชุฑุฎุงุก ูุชููุณ","SSRI/SNRI"]},
      {group:"ุงุถุทุฑุงุจุงุช ุงูููู", code:"PD", name:"ููุจุงุช ููุน/ูุฒุน",
        aka:["ููุงูุน","ูุฌุนู"], any:["ููุจู ููุน","ุฎููุงู","ุงุฎุชูุงู","ุฏูุฎู","ุฑุนุดู","ุฎูู ููุช","ุฎูู ููุฏ ุงูุณูุทุฑู"], tips:["ุชุนุฑูุถ ุฏุงุฎูู","ุชุซููู"]},
      {group:"ุงุถุทุฑุงุจุงุช ุงูููู", code:"SOC", name:"ุฑูุงุจ ุงุฌุชูุงุนู",
        any:["ุฎูู ุงุฌุชูุงุนู","ุฎูู ุชูููู ุงููุงุณ","ุงุญูุฑุงุฑ","ุชุฌูุจ ุงุฌุชูุงุนุงุช","ุชุนุฑู ุงูุงู ุงููุงุณ"], minDays:180,
        tips:["CBT ููุงุฑุงุช ุงุฌุชูุงุนูุฉ","ุชุนุฑูุถ ููุฃุฏุงุก","ุฏูุงุก ุฏุงุนู ููููุงูู ุนูุฏ ุงููุฒูู"]},
      {group:"ุงุถุทุฑุงุจุงุช ุงูููู", code:"Agoraphobia", name:"ุฑูุงุจ ุงูููุงุฏูู/ุงูุงุฒุฏุญุงู",
        any:["ุฎูู ูู ุงูุฎุฑูุฌ","ุฎูู ูู ุงูุฒุญุงู","ุชุฌูุจ ููุงุตูุงุช"], minDays:180, tips:["ุชุนุฑูุถ ูุชุฏุฑุฌ","CBT"]},
      {group:"ุงุถุทุฑุงุจุงุช ุงูููู", code:"SP", name:"ุฑูุงุจ ูุญุฏุฏ",
        any:["ุฎูู ูู ุงูุนูุงูุจ","ุฎูู ูู ุงูุทูุฑุงู","ุฎูู ูู ุงูุญูู","ููุจูุง"], tips:["ุชุนุฑูุถ ูุตูุฑ ููุฌู"]},

      // โโโ ูุณูุงุณ ููุฑู โโโ
      {group:"ูุณูุงุณ ููุฑู", code:"OCD", name:"ุงููุณูุงุณ ุงูููุฑู",
        aka:["ูุณูุงุณ","ููุฑู"], any:["ุงููุงุฑ ุชุณูุทูู","ุบุณู ูุชูุฑุฑ","ุชููุฏ","ุทููุณ","ุชูุธูู ููุฑู","ุนุฏ","ุชูุฑุงุฑ"], minDays:90,
        tips:["ERP (ุชุนุฑูุถ ูููุน ุงุณุชุฌุงุจุฉ)","SSRI ุฌุฑุนุงุช ุฃุนูู"]},
      {group:"ูุณูุงุณ ููุฑู", code:"BDD", name:"ุชุดูู ุตูุฑุฉ ุงูุฌุณุฏ",
        any:["ุงูุดุบุงู ุจุนูุจ ุดููู","ุชููุฏ ูุฑุงูู","ุงุฎูุงุก ููุงูุญ"], minDays:90, tips:["CBT + ERP","ุชุซููู"]},
      {group:"ูุณูุงุณ ููุฑู", code:"Tricho", name:"ูุชู ุงูุดุนุฑ", any:["ูุชู ุดุนุฑ","ุดุฏ ุดุนุฑ","ูุฑุงุบุงุช"], tips:["HRT ุชุฏุฑูุจ ุนุงุฏุงุช","CBT"]},
      {group:"ูุณูุงุณ ููุฑู", code:"Onycho", name:"ูุถู ุงูุงุธุงูุฑ ุงูููุฑู", any:["ูุถู ุงุธุงูุฑ","ุงูู ุงุธุงูุฑ"], tips:["HRT","ุจุฏุงุฆู ุญุณูุฉ"]},

      // โโโ ุตุฏูุงุช โโโ
      {group:"ุตุฏูุงุช", code:"PTSD", name:"ูุง ุจุนุฏ ุงูุตุฏูุฉ (PTSD)",
        any:["ุตุฏูุฉ","ูุงุจูุณ","ุงุณุชุฑุฌุงุน","ุชุฌูุจ","ููุธู ููุฑุทู","ุฎุฏุฑ"], minDays:30, tips:["TF-CBT/EMDR","ุฏุนู ุงุฌุชูุงุนู"]},
      {group:"ุตุฏูุงุช", code:"ASD", name:"ูุฑุจ ุญุงุฏ (Acute Stress)",
        any:["ุตุฏูุฉ ุญุฏูุซู","ูุงุจูุณ","ุงุณุชุฑุฌุงุน","ุฎุฏุฑ"], minDays:3, tips:["ุฏุนู ููุณู","ูุฑุงูุจุฉ ุงูุชุญูู ููPTSD"]},

      // โโโ ุฐูุงููุงุช โโโ
      {group:"ุฐูุงููุงุช", code:"SCHZ", name:"ูุตุงู",
        any:["ููุงูุณ ุณูุนูู","ุถูุงูุงุช","ุชููู ููุงู","ุงูุณุญุงุจ","ุชุจูุฏ ูุฌุฏุงูู"], minDays:180, tips:["ูุถุงุฏุงุช ุฐูุงู","ุฅุญุงูุฉ ุณุฑูุนุฉ"]},
      {group:"ุฐูุงููุงุช", code:"Schizoaff", name:"ูุตุงูู ุนุงุทูู", any:["ุงุนุฑุงุถ ูุตุงู","ููุจุงุช ูุฒุงุฌ"], tips:["ูุถุงุฏ ุฐูุงู + ูุซุจุช ูุฒุงุฌ"]},
      {group:"ุฐูุงููุงุช", code:"BriefPsych", name:"ุฐูุงูู ูุฌูุฒ", any:["ููุงูุณ","ุถูุงูุงุช","ุชููู","ุถุบุท ููุณู ููู"], minDays:1, tips:["ุณูุงูุฉ/ุชูููู ุฎุทุฑ","ูุถุงุฏ ุฐูุงู ูุตูุฑ"]},

      // โโโ ุงูุชุจุงู ูุชูููุฐู โโโ
      {group:"ุงูุชุจุงู/ุชูููุฐู", code:"ADHD", name:"ูุฑุท ุญุฑูุฉ/ุชุดุชุช (ุจุงูุบูู)",
        aka:["ุชุดุชุช","ูุณุงููู"], any:["ุชุดุชุช","ูุณูุงู","ุชุงุฌูู","ุงูุฏูุงุน","ุชูุธูู ููุช ุถุนูู","ุญุฑูู ุฒุงูุฏู"], minDays:180,
        tips:["CBT ุชูููุฐูุฉ","ุชูุธูู ุฑูุชูู"]},

      // โโโ ููู โโโ
      {group:"ููู", code:"INS", name:"ุฃุฑู ูุฒูู",
        any:["ุงุฑู","ุตุนูุจู ููู","ุงุณุชููุงุธ ูุจูุฑ","ููู ุณุทุญู"], minDays:90, tips:["CBT-I","ูุธุงูุฉ ููู"]},
      {group:"ููู", code:"Hypersomnia", name:"ูุฑุท ุงููุนุงุณ", any:["ูุนุงุณ ููุงุฑู","ููู ุทููู","ุบููุงุช"], tips:["ุชูุธูู ููู","ูุญุต ุฃุณุจุงุจ ุทุจูุฉ"]},
      {group:"ููู", code:"Parasomnia", name:"ุงุถุทุฑุงุจุงุช ููู (ููุงุจูุณ/ูุดู ููู)",
        any:["ูุงุจูุณ","ูุดู ุงุซูุงุก ุงูููู","ููุน ูููู"], tips:["ุณูุงูุฉ ุจูุฆุฉ ุงูููู","CBT ููููุงุจูุณ"]},

      // โโโ ุฃูู โโโ
      {group:"ุฃูู", code:"AN", name:"ููุฏุงู ุดููุฉ ุนุตุจู",
        any:["ููุต ูุฒู ุดุฏูุฏ","ุฎูู ุฒูุงุฏู ูุฒู","ุตูุฑู ุฌุณู ูุดููู","ุชูููุฏ ุงูู"], minDays:90,
        tips:["ูุฑูู ูุชุนุฏุฏ ุงูุชุฎุตุตุงุช","ุฎุทุฉ ุชุบุฐูุฉ","ูุฑุงูุจุฉ ูุฎุงุทุฑ"]},
      {group:"ุฃูู", code:"BN", name:"ููุงู ุนุตุจู",
        any:["ููู ุงูู","ููุก ุชุนููุถู","ููููุงุช","ุชุฐุจุฐุจ ูุฒู"], minDays:90, tips:["CBT-E","ูุญุต ุจูุชุงุณููู"]},
      {group:"ุฃูู", code:"BED", name:"ููู ุงูุทุนุงู", any:["ุงูู ูููุงุช ูุจูุฑู","ููุฏ ุงูุณูุทุฑู ุนูู ุงูุงูู","ูุฏู ุจุนุฏ ุงูุงูู"], minDays:90, tips:["CBT-E","ุชูุธูู ูุฌุจุงุช"]},

      // โโโ ุฌุณุฏูุฉ ุงูุดูู/ููู ุตุญู โโโ
      {group:"ุฌุณุฏูุฉ ุงูุดูู", code:"SOM", name:"ุงุถุทุฑุงุจ ุฃุนุฑุงุถ ุฌุณุฏูุฉ",
        any:["ุขูุงู ูุชูููู","ุงุนุฑุงุถ ุฌุณุฏูู ูุซูุฑู","ูุญูุตุงุช ุณูููู","ุงูุดุบุงู ุตุญู"], minDays:180, tips:["CBT ููุงูุดุบุงู","ุชูููู ูุญูุตุงุช"]},
      {group:"ุฌุณุฏูุฉ ุงูุดูู", code:"IAD", name:"ููู ุงููุฑุถ", any:["ุฎูู ูู ุงููุฑุถ","ุชููุฏ ุฌุณุฏ","ูุฑุงุกุฉ ุทุจูู ููุฑุทู"], minDays:180, tips:["CBT","ุงุชูุงู ูุฑุงุฌุนุฉ"]},

      // โโโ ุชูุงุฑูู โโโ
      {group:"ุชูุงุฑูู", code:"DID", name:"ุงุถุทุฑุงุจ ุงููููุฉ ุงูุชูุงุฑูู", any:["ูููุงุช ูุชุนุฏุฏู","ูุฌูุงุช ุฐุงูุฑู","ุงููุตุงู"], tips:["ุงุฎุชุตุงุตู ุตุฏูุงุช"]},
      {group:"ุชูุงุฑูู", code:"DPDR", name:"ุงุฎุชูุงู ุงูุขููุฉ/ุงููุงูุน", any:["ูุงูุงูุนูู","ุงููุตุงู ุนู ุงูุฐุงุช","ุถุจุงุจูู ุงูุนุงูู"], minDays:30, tips:["ุชุฃุฑูุถ","ุงุฏุงุฑุฉ ููู/ุงูุชุฆุงุจ"]},

      // โโโ ุชุนุงุทู/ุฅุฏูุงู โโโ
      {group:"ุชุนุงุทู/ุฅุฏูุงู", code:"AUD", name:"ุชุนุงุทู ุงููุญูู", any:["ุฎูุฑ","ูุญูู","ุซูุงูู","ุงูุณุญุงุจ","ููุฏ ุงูุณูุทุฑู"], tips:["ุฎุทุฉ ุชูููู/ุฅููุงู","ุฏุนู","ูุงูุชุฑููุณูู"]},
      {group:"ุชุนุงุทู/ุฅุฏูุงู", code:"CUD", name:"ุชุนุงุทู ุงูุญุดูุด", any:["ุญุดูุด","ููุจ","ุงุณุชุนูุงู ูููู","ูุณูุงู"], tips:["ุฅููุงู ุชุฏุฑูุฌู","CBT ููุฅุฏูุงู"]},
      {group:"ุชุนุงุทู/ุฅุฏูุงู", code:"OUD", name:"ุชุนุงุทู ุงูุฃููููุงุช", any:["ููุฑููู","ูุณููุงุช ุฃูููููู","ุงูุณุญุงุจ","ุชุญูู"], tips:["ุจุฑูุงูุฌ ุฏูุงุฆู (ุจูุจุฑูููุฑููู/ููุซุงุฏูู)"]},
      {group:"ุชุนุงุทู/ุฅุฏูุงู", code:"STIM", name:"ุชุนุงุทู ุงูููุจูุงุช", any:["ุงูููุชุงููู","ูููุงููู","ูุจุชุงุฌูู","ุณูุฑ ุทููู","ุจุงุฑุงูููุง"], tips:["ุฏุนู ุงูุชูุงุณ","ุนูุงุฌ ุฐูุงูู ุญุงุฏ"]},
      {group:"ุชุนุงุทู/ุฅุฏูุงู", code:"BDZ", name:"ุงุณุงุกุฉ ุงูุจูุฒูุฏูุงุฒุจูู", any:["ุฒุงูุงูุณ","ูุงูููู","ุงูุณุญุงุจ","ุชุญูู"], tips:["ุฎูุถ ุชุฏุฑูุฌู ูุฑุงูุจ"]},
      {group:"ุชุนุงุทู/ุฅุฏูุงู", code:"TobUse", name:"ุชุนุงุทู ููููุชูู/ุชุจุน", any:["ุชุฏุฎูู","ุณุฌุงุฆุฑ","ุณุญุจุงุช","ุฑุบุจู ุดุฏูุฏู"], tips:["NRT/ูุงุฑูููููู","ุฎุทุฉ ุฅููุงุน"]},

      // โโโ ุทูู ุงูุชูุญูุฏ/ููู โโโ
      {group:"ููู ุนุตุจู", code:"ASD", name:"ุทูู ุงูุชูุญูุฏ (ุจุงูุบูู)", any:["ุตุนูุจุงุช ุชูุงุตู ุงุฌุชูุงุนู","ุงูุชูุงูุงุช ุญุตุฑูู","ุญุณุงุณูู ุญุณูู"], tips:["ุชูููู ุชุฎุตุตู","ุชุฏุฑูุจ ููุงุฑุงุช"]},

      // โโโ ุดุฎุตูุฉ (ูุคุดุฑุงุช ุนุงูุฉ) โโโ
      {group:"ุดุฎุตูุฉ", code:"BPD", name:"ุณูุงุช ุญุฏููุฉ", any:["ุงูุฏูุงุน ุดุฏูุฏ","ุชูููุจ ุญุงุฏ","ุฎูู ูุฌุฑ","ุงูุฐุงุก ุฐุงุชู"], tips:["DBT","ุฎุทุฉ ุงูุงู"]},
      {group:"ุดุฎุตูุฉ", code:"AvPD", name:"ุชุฌููุจูุฉ", any:["ุชุฌูุจ ุงุฌุชูุงุนู ุดุฏูุฏ","ุญุณุงุณูู ููููุฏ","ุฎุฌู ููุฑุท"], tips:["CBT ุงุฌุชูุงุนู"]},
      {group:"ุดุฎุตูุฉ", code:"OCPD", name:"ูุณุฑูุฉ (ุดุฎุตูุฉ)", any:["ูุซุงููู ููุฑุทู","ุตุฑุงูู","ุงูุดุบุงู ุจุงููุธุงู"], tips:["ูุฑููู ูุนุฑููู","CBT"]},

      // โโโ ุฏูุงุฆู ุทุจูุฉ ูุฑุงููุฉ (ูุคุดุฑุงุช ูุงุณุชุจุนุงุฏ) โโโ
      {group:"ูุคุดุฑุงุช ุทุจูุฉ", code:"Thy", name:"ุงุดุชุจุงู ุงุถุทุฑุงุจ ุฏุฑูู", any:["ุฎููุงู","ุชุนุฑู","ููุต ูุฒู ุบูุฑ ููุณุฑ","ุฑุฌูู"], tips:["TSH/T4"]},
      {group:"ูุคุดุฑุงุช ุทุจูุฉ", code:"Anemia", name:"ุงุดุชุจุงู ููุฑ ุฏู", any:["ุงุฑูุงู ูุฒูู","ุฏูุฎู","ุดุญูุจ"], tips:["CBC"]},

      // โโโ ุชูููู/ุถุบูุท โโโ
      {group:"ุชูููู/ุถุบูุท", code:"ADJ", name:"ุงุถุทุฑุงุจ ุชูููู", any:["ุญุฒู ุจุนุฏ ุญุฏุซ","ููู ุจุนุฏ ุญุฏุซ","ุตุนูุจู ุชููู","ุถุบูุท ุญูุงุชูู"], tips:["ุนูุงุฌ ุฏุงุนู","ุญู ูุดููุงุช"]},
      {group:"ุชูููู/ุถุบูุท", code:"Grief", name:"ุญุฒู/ูุฌูุนู ูุทููู", any:["ููุฏ ุดุฎุต","ุญุฒู ูุณุชูุฑ","ุงุดุชูุงู ูุฑูุฑ"], minDays:180, tips:["ุนูุงุฌ ูุชูุญูุฑ ุญูู ุงูููุฏ"]},

      // โโโ ุงูุฏูุงุน/ุนุงุฏุงุช โโโ
      {group:"ุงูุฏูุงุน/ุนุงุฏุงุช", code:"IED", name:"ุงููุฌุงุฑุงุช ุบุถุจ (IED)", any:["ููุจุงุช ุบุถุจ ูุง ุชุชูุงุณุจ","ุนุฏูุงู ุงูุฏูุงุนู"], tips:["DBT/CBT ุบุถุจ"]},
      {group:"ุงูุฏูุงุน/ุนุงุฏุงุช", code:"Klepto", name:"ููุณ ุณุฑูุฉ (ูุคุดุฑ)", any:["ุณุฑูู ูุชูุฑุฑู ุจูุง ููุณุจ","ุชูุชุฑ ูุจู ุงููุนู","ุฑุงุญู ุจุนุฏู"], tips:["CBT/ุชุญูู ุงูุฏูุงุน"]},
      {group:"ุงูุฏูุงุน/ุนุงุฏุงุช", code:"Pyro", name:"ููุณ ุงุดุนุงู ุญุฑุงุฆู (ูุคุดุฑ)", any:["ุงุดุนุงู ูุชูุฑุฑ","ุงูุชูุงู ุจุงููุงุฑ"], tips:["ุชูููู ุฃูุงู/ูุงูููู"]},

      // โโโ ุฃุฎุฑู ุชูุณูุน ุงูุงูุชูุงุท โโโ
      {group:"ุฃุฎุฑู", code:"Rumination", name:"ุงุฌุชุฑุงุฑ ุงููุงุฑ", any:["ุชูููุฑ ุฏุงุฆุฑู","ุงุนุงุฏู ุชุญููู ุงููุงุถู","ููู ุฐุงุช ูุณุชูุฑ"], tips:["ุงููุงู ููุฑ","ูุดุงุท ุจุฏูู"]},
      {group:"ุฃุฎุฑู", code:"HealthAnx", name:"ููู ุตุญู ุจุนุฏ ุนุฏูู/ุฌุงุฆุญู", any:["ุฎูู ูู ุงูุนุฏูู","ุชุนููู ููุฑุท","ุชููุฏ ุญุฑุงุฑู"], tips:["CBT ููุงูุดุบุงู","ุชุนุฑูุถ ุชุฏุฑูุฌู"]},
      {group:"ุฃุฎุฑู", code:"DrivePhobia", name:"ุฑูุงุจ ุงูููุงุฏู/ุงูุทุฑู", any:["ุฎูู ูู ุงูููุงุฏู","ุชุฌูุจ ุงูุทุฑู","ุฎูู ุญูุงุฏุซ"], tips:["ุชุนุฑูุถ ุชุฏุฑูุฌู ุจุงูููุงูู"]}
    ];
    // (ูููู ุฅุถุงูุฉ ุงููุฒูุฏ ูุงุญููุง ุจุณูููุฉ ุจููุณ ุงูุจููุฉ)

    // ======  ุชูููุฏ ุงููุชุงููุฌ ุงููุฑุฌุนู (ูููุฑุงุกุฉ) ======
    (function renderCatalog(){
      const byGroup = {};
      CATALOG.forEach(d => {
        (byGroup[d.group]??=[]).push(d);
      });
      const catalogEl = document.getElementById('catalog');
      catalogEl.innerHTML = Object.keys(byGroup).map(g => `
        <details>
          <summary>${g}</summary>
          <ul>
            ${byGroup[g].map(d => `<li><b>${d.name}</b> <span class="muted">(${d.code})</span></li>`).join('')}
          </ul>
        </details>
      `).join('');
    })();

    // ======  ุญุณุงุจ ุงููุชูุฌุฉ ======
    const text = norm((FORM.symptoms||'') + ' ' + (FORM.history||''));
    const dur  = FORM.duration || 0;

    function scoreOne(d){
      let score = 0;
      score += countHits(text, (d.aka||[]).map(norm));
      score += countHits(text, (d.any||[]).map(norm));
      score += 2*countHits(text,(d.all||[]).map(norm));
      if (d.exclude && hasAny(text,(d.exclude||[]).map(norm))) score -= 2;
      if (d.minDays && dur >= d.minDays) score += 2;
      if (score < 0) score = 0;
      const level = score >= 10 ? "strong" : score >= 5 ? "ok" : score>0 ? "weak" : "weak";
      return {...d, score, level};
    }

    function renderResults(){
      const out = document.getElementById('out');
      if (!out) return;

      if (!text) {
        out.innerHTML = `<div class="result"><p>ุฃุฏุฎู ุงูุฃุนุฑุงุถ ูุนุฑุถ ูุชูุฌุฉ.</p></div>`;
        return;
      }

      const ranked = CATALOG.map(scoreOne)
        .filter(x=>x.score>0)
        .sort((a,b)=> b.score - a.score);

      if (!ranked.length) {
        out.innerHTML = `
          <div class="result">
            <h3>ูุง ุชูุฌุฏ ูุคุดุฑุงุช ูุงููุฉ ูุชุดุฎูุต ูุญุฏุฏ.</h3>
            <p class="notes">ุฒุฏ ุชูุงุตูู ุงูุฃุนุฑุงุถ (ุงูุดุฏุฉ/ุงููุฏุฉ/ุงููุญูุฒุงุช)ุ ุฃู ุฌุฑูุจ ุงุฎุชุจุงุฑุงุช ูุณุงุนุฏุฉ.</p>
            <div class="chips">
              <a class="chip" href="{{ url_for('tests') }}">ุงุฎุชุจุงุฑุงุช ูุณุงูุฏุฉ</a>
              <a class="chip" href="{{ url_for('cbt') }}">ุจุฏุก ุฎุทุฉ CBT</a>
            </div>
          </div>`;
        return;
      }

      const top = ranked.slice(0, 10);
      out.innerHTML = top.map(d => `
        <div class="result">
          <h3>${d.name}
            <span class="badge ${d.level}">
              ${d.level==='strong'?'ููู':d.level==='ok'?'ูุชูุณุท':'ุถุนูู'}
            </span>
            <span class="badge">ุฏุฑุฌุฉ: ${d.score}</span>
            <span class="badge muted">${d.group}</span>
          </h3>
          ${d.minDays? `<div class="muted">ุชููู ุงูุดุจูุฉ ุฅุฐุง ุงุณุชูุฑุช ุงูุฃุนุฑุงุถ โฅ ${d.minDays} ููููุง.</div>`:''}
          ${d.aka?.length? `<div class="muted">ูุฑุงุฏูุงุช/ุฏุงุฑุฌ: ${d.aka.join('ุ ')}</div>`:''}
          ${d.tips?.length? `<div class="notes"><b>ุงูุชุฑุงุญุงุช ุฃูููุฉ:</b><ul class="list">
            ${d.tips.map(t=>`<li>${t}</li>`).join('')}
          </ul></div>`:''}
        </div>
      `).join('') + `
        <div class="pill muted" style="margin-top:8px">
          โ๏ธ ูุฐู ูุชูุฌุฉ ุชูุฏูุฑูุฉ ุจุงููุทุงุจูุฉ ุงููุตูุฉ ูุงููุฏุฉุ ูุง ุชูุนุฏ ุชุดุฎูุตูุง ููุงุฆููุง. ููุชุฃููุฏ ููุณุชุญุณู ููุงุจูุฉ ูุฎุชุต.
          ูููู ุฑุจุท ุงููุชุงุฆุฌ ูุน <a href="{{ url_for('cbt') }}" class="btn ghost" style="margin-inline:6px">CBT</a>
          ุฃู ุฅุฌุฑุงุก <a href="{{ url_for('tests') }}" class="btn ghost" style="margin-inline:6px">ุงุฎุชุจุงุฑุงุช ูุณุงูุฏุฉ</a>.
        </div>
      `;
    }

    renderResults();
  </script>
  {% endif %}
</body>
</html>
