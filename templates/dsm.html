<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>دراسة حالة + تشخيص DSM-5 (موسّع)</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .form-section{background:#ffffff10;padding:16px;border-radius:14px;margin-bottom:18px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .pill{background:#101a4dcc;border:1px solid #2a3a86;padding:10px 14px;border-radius:12px}
    .muted{opacity:.85}
    .result{background:#0b1437cc;color:#fff;border-radius:18px;padding:22px;margin:18px 0}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#17b169;margin-inline-start:8px;font-size:.8rem}
    .weak{background:#777}
    .ok{background:#0ea5e9}
    .strong{background:#eab308;color:#222}
    .notes{line-height:1.9}
    .list{margin:0;padding-inline-start:18px}
    details{background:#ffffff0b;border:1px solid #ffffff20;border-radius:12px;margin:8px 0;padding:10px}
    summary{cursor:pointer;font-weight:800}
    .catalog{max-width:1080px;margin:18px auto;padding:0 6px}
    .hr{height:1px;background:#ffffff22;margin:14px 0}
    .hint{color:#dbe6ffb8;font-size:.95rem}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#f9c846;color:#2b1e00;border-radius:999px;padding:6px 10px;font-weight:800}
  </style>
</head>
<body class="hero">

  <header class="center">
    <h1>📝 دراسة حالة + تشخيص DSM-5 (موسّع)</h1>
    <p class="sub">املأ بياناتك ثم احصل على تحليل تقديري مبني على قاعدة موسّعة من الاضطرابات — لا يُغني عن التقييم الإكلينيكي.</p>
  </header>

  <!-- ===== نموذج إدخال ===== -->
  <section class="form-section">
    <form action="{{ url_for('case_dsm') }}" method="post" class="card small">
      <div class="grid-auto">
        <label>الاسم الكامل:
          <input name="full_name" value="{{ full_name or '' }}">
        </label>
        <label>العمر:
          <input name="age" type="number" min="1" max="120" value="{{ age or '' }}">
        </label>
        <label>الجنس:
          <select name="gender">
            <option value="" {% if not gender %}selected{% endif %}>— اختر —</option>
            <option {% if gender=='ذكر' %}selected{% endif %}>ذكر</option>
            <option {% if gender=='أنثى' %}selected{% endif %}>أنثى</option>
          </select>
        </label>
        <label>مدة الأعراض (بالأيام):
          <input name="duration_days" type="number" min="0" value="{{ duration_days or '' }}">
        </label>
      </div>

      <label>الأعراض (أكتب بتفصيل):
        <textarea name="symptoms" rows="4" placeholder="مثال: حزن مزمن، فقدان متعة، أرق، أفكار تشاؤمية...">{{ symptoms or '' }}</textarea>
      </label>

      <label>التاريخ الطبي/النفسي (اختياري):
        <textarea name="history" rows="3" placeholder="أدوية حالية، تشخيصات سابقة، أمراض مزمنة، أحداث صادمة...">{{ history or '' }}</textarea>
      </label>

      <div class="actions">
        <button class="btn" type="submit">🔍 تحليل وتشخيص</button>
        <a class="btn ghost" href="{{ url_for('home') }}">العودة للرئيسية</a>
      </div>
    </form>
    <p class="hint">💡 دقّة النتيجة تتحسن كلما وصفت المدة/الشدة/المحفزات/الأوقات/السياق.</p>
  </section>

  <!-- ===== النتائج (تظهر فقط بعد الإرسال) ===== -->
  {% if symptoms %}
  <section class="card">
    <h2>🔎 أعلى الترشيحات التشخيصية</h2>
    <div id="out"></div>
  </section>
  {% endif %}

  <div class="catalog">
    <div class="hr"></div>
    <h2>📚 كتالوج مرجعي (DSM-5 موسّع)</h2>
    <p class="hint">هذا الكتالوج للقراءة السريعة — التحليل الآلي يعتمد على فهرس كلمات موسّع بالأسفل.</p>
    <div id="catalog"></div>
  </div>

  <footer class="footer">
    <a class="btn ghost" href="{{ url_for('home') }}">العودة للرئيسية</a>
  </footer>

  {% if symptoms or True %}
  <script>
    // ======  الإدخال من الخادم  ======
    const FORM = {
      name: `{{ (full_name or '')|e }}`,
      age: parseInt(`{{ (age or '0')|e }}`) || null,
      gender: `{{ (gender or '')|e }}`.trim(),
      duration: parseInt(`{{ (duration_days or '0')|e }}`) || 0,
      symptoms: `{{ (symptoms or '')|e }}`.toLowerCase(),
      history: `{{ (history or '')|e }}`.toLowerCase()
    };

    // ======  أدوات تنظيف عربية ======
    const stripDiacritics = s =>
      s.replace(/[\u064B-\u0652]/g,'') // حركات
       .replace(/أ|إ|آ/g,'ا')
       .replace(/ة/g,'ه')
       .replace(/ى/g,'ي')
       .replace(/ؤ/g,'و').replace(/ئ/g,'ي');

    const norm = s => stripDiacritics(
      (s||'').toLowerCase()
        .replace(/[^\u0600-\u06FFa-z0-9\s]/g,' ')
        .replace(/\s+/g,' ')
        .trim()
    );

    const hasAny = (t,a)=>a?.some(k=>t.includes(k))||false;
    const countHits=(t,a)=> (a||[]).reduce((n,k)=> n+(t.includes(k)?1:0), 0);

    // ======  قاعدة موسّعة (مجمّعة بحسب الفصول) ======
    // كل عنصر: { group, code, name, aka?, any[], all?, exclude?, minDays?, tips[] }
    const CATALOG = [
      // ——— اضطرابات المزاج/الاكتئاب ———
      {group:"اضطرابات اكتئابية", code:"MDD", name:"الاكتئاب الشديد (MDD)",
        aka:["اكتئاب","حزن","ضيقة","ضيقه","مزاج منخفض","فقدان المتعة","انعدام المتعة","ما عاد استلذ"],
        any:["حزن","فقدان المتعه","انعدام المتعه","ياس","انعدام قيمه","ذنب","انسحاب","ارهاق","ارق","نوم زائد","نقص شهيه","زياده شهيه","انتحار","تفكير بالموت"],
        minDays:14, tips:["تنشيط سلوكي","CBT","SSRI","التأكد من السلامة وإدارة أفكار انتحارية"]},
      {group:"اضطرابات اكتئابية", code:"PDD", name:"الاكتئاب المستمر (ديستيميا)",
        aka:["حزن مزمن","كتمه مزمنه"], any:["مزاج منخفض","حزن","طاقه منخفضه","نقص ثقه","تشاؤم"], minDays:365,
        tips:["CBT طويل الأمد","تنظيم نمط الحياة والنوم","أدوية عند الحاجة"]},
      {group:"اضطرابات اكتئابية", code:"PMDD", name:"اضطراب مزعج سابق للحيض",
        aka:["تقلب مزاج قبل الدوره"], any:["تقلب","تهيج","اكتئاب قبل الدوره","الم قبل الدوره"], tips:["تتبّع الأعراض","SSRI طور لوتيال"]},

      // ——— اضطرابات ثنائية القطب ———
      {group:"ثنائي القطب", code:"BP1", name:"ثنائي القطب النوع الأول",
        any:["نوبه هوس","هوس","نشوه","قله نوم دون تعب","كلام سريع","افكار كثيره","اندفاع","انفاق زائد","افكار عظمه"],
        exclude:["حزن فقط"], minDays:7, tips:["مثبتات مزاج","تثقيف أسري","سلامة"]},
      {group:"ثنائي القطب", code:"BP2", name:"ثنائي القطب النوع الثاني (هوس خفيف + اكتئاب)",
        any:["هوس خفيف","طاقه عاليه","قله نوم","اكتئاب"], minDays:4, tips:["تثبيت مزاج","تتبع نوم"]},

      // ——— القلق والرهاب ———
      {group:"اضطرابات القلق", code:"GAD", name:"قلق معمّم (GAD)",
        aka:["توتر","قلق","تفكير زايد","ضيقه"], any:["قلق","توتر","تفكير زايد","شد عضلي","تعب سريع","صعوبه تركيز","ارق"], minDays:180,
        tips:["CBT للقلق","استرخاء وتنفس","SSRI/SNRI"]},
      {group:"اضطرابات القلق", code:"PD", name:"نوبات هلع/فزع",
        aka:["هلايع","فجعه"], any:["نوبه هلع","خفقان","اختناق","دوخه","رعشه","خوف موت","خوف فقد السيطره"], tips:["تعريض داخلي","تثقيف"]},
      {group:"اضطرابات القلق", code:"SOC", name:"رهاب اجتماعي",
        any:["خوف اجتماعي","خوف تقييم الناس","احمرار","تجنب اجتماعات","تعرق امام الناس"], minDays:180,
        tips:["CBT مهارات اجتماعية","تعريض للأداء","دواء داعم للمواقف عند اللزوم"]},
      {group:"اضطرابات القلق", code:"Agoraphobia", name:"رهاب الميادين/الازدحام",
        any:["خوف من الخروج","خوف من الزحام","تجنب مواصلات"], minDays:180, tips:["تعريض متدرج","CBT"]},
      {group:"اضطرابات القلق", code:"SP", name:"رهاب محدد",
        any:["خوف من العناكب","خوف من الطيران","خوف من الحقن","فوبيا"], tips:["تعريض قصير موجه"]},

      // ——— وسواس قهري ———
      {group:"وسواس قهري", code:"OCD", name:"الوسواس القهري",
        aka:["وسواس","قهري"], any:["افكار تسلطيه","غسل متكرر","تفقد","طقوس","تنظيم قهري","عد","تكرار"], minDays:90,
        tips:["ERP (تعريض ومنع استجابة)","SSRI جرعات أعلى"]},
      {group:"وسواس قهري", code:"BDD", name:"تشوه صورة الجسد",
        any:["انشغال بعيب شكلي","تفقد مرايه","اخفاء ملامح"], minDays:90, tips:["CBT + ERP","تثقيف"]},
      {group:"وسواس قهري", code:"Tricho", name:"نتف الشعر", any:["نتف شعر","شد شعر","فراغات"], tips:["HRT تدريب عادات","CBT"]},
      {group:"وسواس قهري", code:"Onycho", name:"قضم الاظافر القهري", any:["قضم اظافر","اكل اظافر"], tips:["HRT","بدائل حسية"]},

      // ——— صدمات ———
      {group:"صدمات", code:"PTSD", name:"ما بعد الصدمة (PTSD)",
        any:["صدمة","كابوس","استرجاع","تجنب","يقظه مفرطه","خدر"], minDays:30, tips:["TF-CBT/EMDR","دعم اجتماعي"]},
      {group:"صدمات", code:"ASD", name:"كرب حاد (Acute Stress)",
        any:["صدمة حديثه","كابوس","استرجاع","خدر"], minDays:3, tips:["دعم نفسي","مراقبة التحول لـPTSD"]},

      // ——— ذهانيات ———
      {group:"ذهانيات", code:"SCHZ", name:"فصام",
        any:["هلاوس سمعيه","ضلالات","تفكك كلام","انسحاب","تبلد وجداني"], minDays:180, tips:["مضادات ذهان","إحالة سريعة"]},
      {group:"ذهانيات", code:"Schizoaff", name:"فصامي عاطفي", any:["اعراض فصام","نوبات مزاج"], tips:["مضاد ذهان + مثبت مزاج"]},
      {group:"ذهانيات", code:"BriefPsych", name:"ذهاني وجيز", any:["هلاوس","ضلالات","تفكك","ضغط نفسي قوي"], minDays:1, tips:["سلامة/تقييم خطر","مضاد ذهان قصير"]},

      // ——— انتباه وتنفيذي ———
      {group:"انتباه/تنفيذي", code:"ADHD", name:"فرط حركة/تشتت (بالغين)",
        aka:["تشتت","نسايين"], any:["تشتت","نسيان","تاجيل","اندفاع","تنظيم وقت ضعيف","حركه زايده"], minDays:180,
        tips:["CBT تنفيذية","تنظيم روتين"]},

      // ——— نوم ———
      {group:"نوم", code:"INS", name:"أرق مزمن",
        any:["ارق","صعوبه نوم","استيقاظ مبكر","نوم سطحي"], minDays:90, tips:["CBT-I","نظافة نوم"]},
      {group:"نوم", code:"Hypersomnia", name:"فرط النعاس", any:["نعاس نهاري","نوم طويل","غفوات"], tips:["تنظيم نوم","فحص أسباب طبية"]},
      {group:"نوم", code:"Parasomnia", name:"اضطرابات نوم (كوابيس/مشي نوم)",
        any:["كابوس","مشي اثناء النوم","هلع ليلي"], tips:["سلامة بيئة النوم","CBT للكوابيس"]},

      // ——— أكل ———
      {group:"أكل", code:"AN", name:"فقدان شهية عصبي",
        any:["نقص وزن شديد","خوف زياده وزن","صوره جسم مشوهه","تقييد اكل"], minDays:90,
        tips:["فريق متعدد التخصصات","خطة تغذية","مراقبة مخاطر"]},
      {group:"أكل", code:"BN", name:"نهام عصبي",
        any:["نهم اكل","قيء تعويضي","ملينات","تذبذب وزن"], minDays:90, tips:["CBT-E","فحص بوتاسيوم"]},
      {group:"أكل", code:"BED", name:"نهم الطعام", any:["اكل كميات كبيره","فقد السيطره على الاكل","ندم بعد الاكل"], minDays:90, tips:["CBT-E","تنظيم وجبات"]},

      // ——— جسدية الشكل/قلق صحي ———
      {group:"جسدية الشكل", code:"SOM", name:"اضطراب أعراض جسدية",
        any:["آلام متنقله","اعراض جسديه كثيره","فحوصات سليمه","انشغال صحي"], minDays:180, tips:["CBT للانشغال","تقليل فحوصات"]},
      {group:"جسدية الشكل", code:"IAD", name:"قلق المرض", any:["خوف من المرض","تفقد جسد","قراءة طبيه مفرطه"], minDays:180, tips:["CBT","اتفاق مراجعة"]},

      // ——— تفارقي ———
      {group:"تفارقي", code:"DID", name:"اضطراب الهوية التفارقي", any:["هويات متعدده","فجوات ذاكره","انفصال"], tips:["اختصاصي صدمات"]},
      {group:"تفارقي", code:"DPDR", name:"اختلال الآنية/الواقع", any:["لاواقعيه","انفصال عن الذات","ضبابيه العالم"], minDays:30, tips:["تأريض","ادارة قلق/اكتئاب"]},

      // ——— تعاطي/إدمان ———
      {group:"تعاطي/إدمان", code:"AUD", name:"تعاطي الكحول", any:["خمر","كحول","ثماله","انسحاب","فقد السيطره"], tips:["خطة تقليل/إيقاف","دعم","نالتريكسون"]},
      {group:"تعاطي/إدمان", code:"CUD", name:"تعاطي الحشيش", any:["حشيش","قنب","استعمال يومي","نسيان"], tips:["إيقاف تدريجي","CBT للإدمان"]},
      {group:"تعاطي/إدمان", code:"OUD", name:"تعاطي الأفيونات", any:["هيروين","مسكنات أفيونيه","انسحاب","تحمل"], tips:["برنامج دوائي (بوبرينورفين/ميثادون)"]},
      {group:"تعاطي/إدمان", code:"STIM", name:"تعاطي المنبهات", any:["امفيتامين","كوكايين","كبتاجون","سهر طويل","بارانويا"], tips:["دعم انتكاس","علاج ذهاني حاد"]},
      {group:"تعاطي/إدمان", code:"BDZ", name:"اساءة البنزوديازبين", any:["زاناكس","فاليوم","انسحاب","تحمل"], tips:["خفض تدريجي مراقب"]},
      {group:"تعاطي/إدمان", code:"TobUse", name:"تعاطي نيكوتين/تبع", any:["تدخين","سجائر","سحبات","رغبه شديده"], tips:["NRT/فارنيكلين","خطة إقلاع"]},

      // ——— طيف التوحّد/نمو ———
      {group:"نمو عصبي", code:"ASD", name:"طيف التوحّد (بالغين)", any:["صعوبات تواصل اجتماعي","اهتمامات حصريه","حساسيه حسيه"], tips:["تقييم تخصصي","تدريب مهارات"]},

      // ——— شخصية (مؤشرات عامة) ———
      {group:"شخصية", code:"BPD", name:"سمات حدّية", any:["اندفاع شديد","تقلّب حاد","خوف هجر","ايذاء ذاتي"], tips:["DBT","خطة امان"]},
      {group:"شخصية", code:"AvPD", name:"تجنّبية", any:["تجنب اجتماعي شديد","حساسيه للنقد","خجل مفرط"], tips:["CBT اجتماعي"]},
      {group:"شخصية", code:"OCPD", name:"قسرية (شخصية)", any:["مثاليه مفرطه","صرامه","انشغال بالنظام"], tips:["مرونه معرفيه","CBT"]},

      // ——— دلائل طبية مرافقة (مؤشرات لاستبعاد) ———
      {group:"مؤشرات طبية", code:"Thy", name:"اشتباه اضطراب درقي", any:["خفقان","تعرق","نقص وزن غير مفسر","رجفه"], tips:["TSH/T4"]},
      {group:"مؤشرات طبية", code:"Anemia", name:"اشتباه فقر دم", any:["ارهاق مزمن","دوخه","شحوب"], tips:["CBC"]},

      // ——— تكيّف/ضغوط ———
      {group:"تكيّف/ضغوط", code:"ADJ", name:"اضطراب تكيّف", any:["حزن بعد حدث","قلق بعد حدث","صعوبه تكيف","ضغوط حياتيه"], tips:["علاج داعم","حل مشكلات"]},
      {group:"تكيّف/ضغوط", code:"Grief", name:"حزن/فجيعه مطوّل", any:["فقد شخص","حزن مستمر","اشتياق مرير"], minDays:180, tips:["علاج متمحور حول الفقد"]},

      // ——— اندفاع/عادات ———
      {group:"اندفاع/عادات", code:"IED", name:"انفجارات غضب (IED)", any:["نوبات غضب لا تتناسب","عدوان اندفاعي"], tips:["DBT/CBT غضب"]},
      {group:"اندفاع/عادات", code:"Klepto", name:"هوس سرقة (مؤشر)", any:["سرقه متكرره بلا مكسب","توتر قبل الفعل","راحه بعده"], tips:["CBT/تحكم اندفاع"]},
      {group:"اندفاع/عادات", code:"Pyro", name:"هوس اشعال حرائق (مؤشر)", any:["اشعال متكرر","اهتمام بالنار"], tips:["تقييم أمان/قانوني"]},

      // ——— أخرى توسيع الالتقاط ———
      {group:"أخرى", code:"Rumination", name:"اجترار افكار", any:["تفكير دائري","اعاده تحليل الماضي","لوم ذات مستمر"], tips:["ايقاف فكر","نشاط بديل"]},
      {group:"أخرى", code:"HealthAnx", name:"قلق صحي بعد عدوى/جائحه", any:["خوف من العدوى","تعقيم مفرط","تفقد حراره"], tips:["CBT للانشغال","تعريض تدريجي"]},
      {group:"أخرى", code:"DrivePhobia", name:"رهاب القياده/الطرق", any:["خوف من القياده","تجنب الطرق","خوف حوادث"], tips:["تعريض تدرّجي بالمواقف"]}
    ];
    // (ممكن إضافة المزيد لاحقًا بسهولة بنفس البنية)

    // ======  توليد الكتالوج المرجعي (للقراءة) ======
    (function renderCatalog(){
      const byGroup = {};
      CATALOG.forEach(d => {
        (byGroup[d.group]??=[]).push(d);
      });
      const catalogEl = document.getElementById('catalog');
      catalogEl.innerHTML = Object.keys(byGroup).map(g => `
        <details>
          <summary>${g}</summary>
          <ul>
            ${byGroup[g].map(d => `<li><b>${d.name}</b> <span class="muted">(${d.code})</span></li>`).join('')}
          </ul>
        </details>
      `).join('');
    })();

    // ======  حساب النتيجة ======
    const text = norm((FORM.symptoms||'') + ' ' + (FORM.history||''));
    const dur  = FORM.duration || 0;

    function scoreOne(d){
      let score = 0;
      score += countHits(text, (d.aka||[]).map(norm));
      score += countHits(text, (d.any||[]).map(norm));
      score += 2*countHits(text,(d.all||[]).map(norm));
      if (d.exclude && hasAny(text,(d.exclude||[]).map(norm))) score -= 2;
      if (d.minDays && dur >= d.minDays) score += 2;
      if (score < 0) score = 0;
      const level = score >= 10 ? "strong" : score >= 5 ? "ok" : score>0 ? "weak" : "weak";
      return {...d, score, level};
    }

    function renderResults(){
      const out = document.getElementById('out');
      if (!out) return;

      if (!text) {
        out.innerHTML = `<div class="result"><p>أدخل الأعراض لعرض نتيجة.</p></div>`;
        return;
      }

      const ranked = CATALOG.map(scoreOne)
        .filter(x=>x.score>0)
        .sort((a,b)=> b.score - a.score);

      if (!ranked.length) {
        out.innerHTML = `
          <div class="result">
            <h3>لا توجد مؤشرات كافية لتشخيص محدد.</h3>
            <p class="notes">زد تفاصيل الأعراض (الشدة/المدة/المحفزات)، أو جرّب اختبارات مساعدة.</p>
            <div class="chips">
              <a class="chip" href="{{ url_for('tests') }}">اختبارات مساندة</a>
              <a class="chip" href="{{ url_for('cbt') }}">بدء خطة CBT</a>
            </div>
          </div>`;
        return;
      }

      const top = ranked.slice(0, 10);
      out.innerHTML = top.map(d => `
        <div class="result">
          <h3>${d.name}
            <span class="badge ${d.level}">
              ${d.level==='strong'?'قوي':d.level==='ok'?'متوسط':'ضعيف'}
            </span>
            <span class="badge">درجة: ${d.score}</span>
            <span class="badge muted">${d.group}</span>
          </h3>
          ${d.minDays? `<div class="muted">تقوى الشبهة إذا استمرت الأعراض ≥ ${d.minDays} يومًا.</div>`:''}
          ${d.aka?.length? `<div class="muted">مرادفات/دارج: ${d.aka.join('، ')}</div>`:''}
          ${d.tips?.length? `<div class="notes"><b>اقتراحات أولية:</b><ul class="list">
            ${d.tips.map(t=>`<li>${t}</li>`).join('')}
          </ul></div>`:''}
        </div>
      `).join('') + `
        <div class="pill muted" style="margin-top:8px">
          ⚠️ هذه نتيجة تقديرية بالمطابقة النصية والمدة؛ لا تُعد تشخيصًا نهائيًا. للتأكيد يُستحسن مقابلة مختص.
          يمكن ربط النتائج مع <a href="{{ url_for('cbt') }}" class="btn ghost" style="margin-inline:6px">CBT</a>
          أو إجراء <a href="{{ url_for('tests') }}" class="btn ghost" style="margin-inline:6px">اختبارات مساندة</a>.
        </div>
      `;
    }

    renderResults();
  </script>
  {% endif %}
</body>
</html>
