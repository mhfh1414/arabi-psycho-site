<!-- templates/dsm.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نتائج التشخيص (DSM) - عربي سايكو</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    body{margin:0;font-family:"Tajawal",Tahoma,Arial,sans-serif;
      background:linear-gradient(135deg,#0e3a8a,#1d4ed8);color:#fff}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .title{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .title h1{margin:0;color:#FFD700;font-size:clamp(22px,3.4vw,30px)}
    .card{background:#0b1220ee;border:1px solid rgba(255,255,255,.15);border-radius:16px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);padding:16px;margin:12px 0}
    .subtle{color:#dbe5ff;opacity:.95}
    .grid{display:grid;gap:10px}
    @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{color:#f1c40f;text-align:right;font-weight:800}
    td,th{padding:8px 10px;background:rgba(255,255,255,.05);border-radius:10px}
    .muted{color:#d0dcff;opacity:.9}
    .warn{color:#f59e0b}.bad{color:#ff6b6b}.ok{color:#22c55e}
    .pill{display:inline-block;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);
      color:#dbe6ff;border-radius:999px;padding:6px 10px;font-size:12px;margin:4px 6px 0 0}
    .result{border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:12px;margin-top:10px;background:#0c1529}
    .bar{height:10px;background:rgba(255,255,255,.18);border-radius:999px;overflow:hidden;margin-top:6px}
    .bar i{display:block;height:100%;width:0;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444)}
    .section-title{color:#f1c40f;margin:0 0 10px;font-size:18px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:#FFD700;color:#063162;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .note{font-size:13px;color:#dbe6ff;opacity:.9}
    a.link{color:#ffe082;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="title">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="عربي سايكو" style="width:38px;height:38px;border-radius:8px">
      <h1>نتائج التشخيص (DSM)</h1>
    </div>

    <!-- بيانات الحالة -->
    <div class="card">
      <h3 class="section-title">📋 بيانات الحالة</h3>
      <div class="grid grid-2">
        <table>
          <tr><th>الاسم</th><td>{{ (case.name if case and case.name else '—') }}</td></tr>
          <tr><th>العمر</th><td>{{ (case.age if case and case.age else '—') }}</td></tr>
          <tr><th>الجنس</th><td>{{ (case.gender if case and case.gender else '—') }}</td></tr>
          <tr><th>مدة الأعراض</th><td>{{ (case.duration if case and case.duration else '—') }}</td></tr>
        </table>
        <table>
          <tr><th>الأعراض</th><td>{{ (case.symptoms if case and case.symptoms else '—') }}</td></tr>
          <tr><th>التاريخ الطبي/النفسي</th><td>{{ (case.history if case and case.history else '—') }}</td></tr>
        </table>
      </div>
      <div class="btns" style="margin-top:10px">
        <a class="link" href="{{ url_for('case_study') }}">↩︎ تعديل البيانات</a>
      </div>
    </div>

    <!-- أعلام حمراء (إن وجدت) -->
    {% if flags and flags|length > 0 %}
    <div class="card">
      <h3 class="section-title">⚠️ تنبيهات طبية عاجلة</h3>
      {% for f in flags %}
        <div class="pill bad">{{ f }}</div>
      {% endfor %}
      <p class="note" style="margin-top:8px">عند وجود خطر على النفس أو الآخرين، يُنصح بطلب مساعدة فورية.</p>
    </div>
    {% endif %}

    <!-- النتائج -->
    <div class="card">
      <h3 class="section-title">🎯 أعلى التشخيصات المحتملة</h3>
      {% if results and results|length > 0 %}
        {% for r in results %}
          <div class="result">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div><b>{{ r.name }}</b> <span class="muted">({{ r.group }})</span></div>
              <div class="muted">درجة الثقة</div>
            </div>
            <div class="bar"><i style="width: {{ (r.score * 100)|round(0) }}%"></i></div>
            <div class="muted" style="margin-top:6px">
              أعراض مطابقة: {{ r.met }} • الحد الأدنى: {{ r.min_required }}
              {% if r.duration_required %} • المدة الموصى بها ≥ {{ r.duration_required }} يوم{% endif %}
            </div>
            {% if r.matched_keys and r.matched_keys|length > 0 %}
              <div style="margin-top:6px">
                {% for k in r.matched_keys[:8] %}
                  <span class="pill">{{ k }}</span>
                {% endfor %}
              </div>
            {% endif %}
            {% if r.red_flags and r.red_flags|length > 0 %}
              <div class="warn" style="margin-top:6px">⚠️ مؤشرات خطورة: {{ r.red_flags|join("، ") }}</div>
            {% endif %}
            {% if r.tips and r.tips|length > 0 %}
              <div class="note" style="margin-top:6px">اقتراحات: {{ r.tips|join(" — ") }}</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="subtle">لا توجد أعراض كافية لإظهار تشخيص محتمل. يرجى توضيح الأعراض بشكل أكبر.</div>
      {% endif %}
      <p class="note" style="margin-top:10px">
        هذه النتائج إرشادية وفق قواعد سريرية مبسطة، ولا تغني عن التقييم الطبي المتخصص.
      </p>
    </div>

  </div>
</body>
</html>
