# -*- coding: utf-8 -*-
"""
dsm_suite.py
Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¶Ø®Ù… ÙŠØ¬Ù…Ø¹:
- Ù‚Ø§Ø¹Ø¯Ø© DSM Ù…ÙˆØ³Ù‘Ø¹Ø© (Ù…Ø±Ù†Ø© ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØºØ°ÙŠØ©)
- Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ + Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©)
- Ù…Ø·Ø§Ø¨Ù‚Ø© Ø°ÙƒÙŠØ© (ØªØ·Ø¨ÙŠØ¹ Ø¹Ø±Ø¨ÙŠ + Ù…Ø±Ø§Ø¯ÙØ§Øª + Ø£ÙˆØ²Ø§Ù† + ØªØ¹Ø²ÙŠØ² Ø¨Ø§Ù„Ù…Ø¯Ù‘Ø©/Ø§Ù„Ø¹Ù…Ø±/Ø§Ù„Ø¬Ù†Ø³/Ø§Ù„Ø£Ø«Ø±)
- Ø§Ù‚ØªØ±Ø§Ø­ ÙƒÙ„Ù…Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø© Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
"""

import re
from collections import defaultdict
from flask import render_template_string

# ============================= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØºÙˆÙŠØ© =============================
_AR_DIAC = r"[ÙÙ‹ÙÙŒÙÙÙ’Ù‘Ù€]"
def normalize(s: str) -> str:
    if not s:
        return ""
    s = s.strip()
    # Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ§Øª
    s = re.sub(_AR_DIAC, "", s)
    # ØªÙˆØ­ÙŠØ¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø±ÙˆÙ
    s = (s.replace("Ø£","Ø§").replace("Ø¥","Ø§").replace("Ø¢","Ø§")
           .replace("Ø©","Ù‡").replace("Ù‰","ÙŠ").replace("Ø¤","Ùˆ").replace("Ø¦","ÙŠ"))
    # Ø§Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡Ø§ (Ù…Ù…Ù…Ù… â†’ Ù…Ù…)
    s = re.sub(r"(.)\1{2,}", r"\1\1", s)
    # Ù…Ø³Ø§ÙØ§Øª
    s = re.sub(r"\s+", " ", s)
    return s

def tokenize(s: str):
    s = normalize(s)
    # ÙØµÙ„ Ø¹Ù„Ø§Ù…Ø§Øª
    s = re.sub(r"[^\w\s\-]", " ", s)
    s = re.sub(r"\s+", " ", s).strip()
    # ÙƒÙ„Ù…Ø§Øª Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚ØµÙŠØ±Ø©
    return s.split()

def contains_phrase(text_norm: str, phrase: str) -> bool:
    return normalize(phrase) in text_norm

# ============================= Ù…Ø±Ø§Ø¯ÙØ§Øª Ø¹Ø§Ù…Ø© (ØªØ¹Ø²ÙŠØ²) =============================
# Ù…Ø±Ø§Ø¯ÙØ§Øª Ø´Ø§Ø¦Ø¹Ø© ØªÙØ³ØªØ®Ø¯Ù… Ù„ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©)
SYNONYMS = {
    # Ù…Ø²Ø§Ø¬/Ø§ÙƒØªØ¦Ø§Ø¨
    "Ø­Ø²Ù†": ["Ø²Ø¹Ù„","Ø§ÙƒØªØ¦Ø§Ø¨","ÙƒØ¯Ø±","Ø·ÙØ´","ØºÙ…","Ø¶ÙŠÙ‚Ù‡","Ù‡Ù…"],
    "Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø©": ["ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ù…ØªØ¹Ù‡","Ù…Ø§ÙÙŠ Ù…ØªØ¹Ù‡","Ø¹Ø¯Ù… Ø§Ø³ØªÙ…ØªØ§Ø¹","Ù„Ø§ Ø§Ø³ØªÙ…ØªØ¹"],
    "Ø·Ø§Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©": ["Ø®Ù…ÙˆÙ„","ÙƒØ³Ù„","Ø§Ø±Ù‡Ø§Ù‚","ØªØ¹Ø¨","Ù…Ø§ÙÙŠ Ø·Ø§Ù‚Ù‡"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù†ÙˆÙ…": ["Ù‚Ù„Ø© Ù†ÙˆÙ…","ÙƒØ«Ø±Ø© Ù†ÙˆÙ…","Ø§Ø±Ù‚","Ù†ÙˆÙ… Ù…ØªÙ‚Ø·Ø¹","Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ Ù…Ø¨ÙƒØ±"],
    "Ø´Ù‡ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©": ["Ù‚Ù„Ø© Ø§ÙƒÙ„","Ù…Ø§ Ø§Ù‚Ø¯Ø± Ø§ÙƒÙ„","ÙÙ‚Ø¯Ø§Ù† Ø´Ù‡ÙŠØ©"],
    "Ø²ÙŠØ§Ø¯Ø© ÙˆØ²Ù†": ["Ø³Ù…Ù†Øª","Ø³Ù…Ù†Ù‡","ÙˆØ²Ù†ÙŠ Ø²Ø§Ø¯"],
    "Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ": ["Ø§Ù†Ø¹Ø²Ø§Ù„","Ù…Ø§ Ø§Ø·Ù„Ø¹","Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ø§Ù„Ù†Ø§Ø³"],

    # Ù‚Ù„Ù‚/Ù‡Ù„Ø¹
    "Ù‚Ù„Ù‚": ["ØªÙˆØªØ±","ØªÙˆØ¬Ø³","Ø®ÙˆÙ Ù…Ø³ØªÙ…Ø±","Ø¹Ù„Ù‰ Ø§Ø¹ØµØ§Ø¨ÙŠ"],
    "Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹": ["Ù‡Ø¬ÙˆÙ… Ù‡Ù„Ø¹","ØªØ³Ø§Ø±Ø¹ Ù‚Ù„Ø¨","Ø®ÙÙ‚Ø§Ù†","Ø¶ÙŠÙ‚Ù‡ ØªÙ†ÙØ³","Ø§Ø®ØªÙ†Ø§Ù‚"],
    "Ø®ÙˆÙ Ø§Ù„Ù…ÙˆØª": ["Ø­Ø§Ø³ Ø¨Ù…ÙˆØª","Ø¨Ù…ÙˆØª","Ø®Ø§ÙŠÙ Ø§Ù…ÙˆØª"],

    # ÙˆØ³ÙˆØ§Ø³ Ù‚Ù‡Ø±ÙŠ
    "ÙˆØ³ÙˆØ§Ø³": ["Ø§ÙÙƒØ§Ø± Ù…Ø²Ø¹Ø¬Ù‡","Ø§ÙÙƒØ§Ø± Ù…Ù„Ø­Ø§Ø­Ù‡","Ø§ÙÙƒØ§Ø± Ù‚Ø³Ø±ÙŠÙ‡","Ø§ÙÙƒØ§Ø± Ø§Ù‚ØªØ­Ø§Ù…ÙŠÙ‡"],
    "Ø³Ù„ÙˆÙƒ Ù‚Ù‡Ø±ÙŠ": ["Ø·Ù‚ÙˆØ³","ØªÙƒØ±Ø§Ø± ØºØ³ÙŠÙ„","ØªÙÙ‚Ø¯ Ù…ÙƒØ±Ø±","Ø¹Ø¯ Ù‚Ù‡Ø±ÙŠ","ØªÙ†Ø¸ÙŠÙ Ø´Ø¯ÙŠØ¯"],
    "Ø®ÙˆÙ ØªÙ„ÙˆØ«": ["Ù‚Ø°Ø§Ø±Ù‡","ÙˆØ³Ø§ÙˆØ³ Ù†Ø¸Ø§ÙÙ‡"],

    # ØµØ¯Ù…Ø©
    "Ø­Ø¯Ø« ØµØ§Ø¯Ù…": ["Ø­Ø§Ø¯Ø« Ø´Ø¯ÙŠØ¯","ØªØ¹Ø±Ø¶Øª Ù„Ø­Ø§Ø¯Ø«","Ø§Ø¹ØªØ¯Ø§Ø¡","Ø­Ø±Ø¨","ÙƒØ§Ø±Ø«Ù‡"],
    "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø¯Ø«": ["ÙÙ„Ø§Ø´ Ø¨Ø§Ùƒ","Ø°ÙƒØ±ÙŠØ§Øª Ù…Ø¤Ù„Ù…Ù‡","ÙƒÙˆØ§Ø¨ÙŠØ³"],

    # Ø°Ù‡Ø§Ù†
    "Ù‡Ù„ÙˆØ³Ø©": ["Ø§Ø³Ù…Ø¹ Ø§ØµÙˆØ§Øª","Ø§Ø´ÙˆÙ Ø§Ø´ÙŠØ§Ø¡","Ù‡Ù„Ø§ÙˆØ³ Ø³Ù…Ø¹ÙŠÙ‡","Ù‡Ù„Ø§ÙˆØ³ Ø¨ØµØ±ÙŠÙ‡"],
    "Ø§ÙˆÙ‡Ø§Ù…": ["Ø¶Ù„Ø§Ù„Ø§Øª","Ø§ÙÙƒØ§Ø± ØºÙŠØ± ÙˆØ§Ù‚Ø¹ÙŠÙ‡","Ø´ÙƒÙˆÙƒÙŠÙ‡ Ù…Ø¨Ø§Ù„Øº Ø¨Ù‡Ø§"],

    # ADHD
    "ØªØ´ØªØª": ["Ø¹Ø¯Ù… ØªØ±ÙƒÙŠØ²","Ø³Ù‡Ùˆ","Ù†Ø³ÙŠØ§Ù†","Ù…Ø§ Ø§Ø±ÙƒØ²"],
    "ÙØ±Ø· Ø­Ø±ÙƒØ©": ["ÙƒØ«Ø±Ø© Ø­Ø±ÙƒÙ‡","Ø§Ù†Ø¯ÙØ§Ø¹","Ù…Ù‚Ø§Ø·Ø¹Ù‡","Ù…Ù„Ù„ Ø³Ø±ÙŠØ¹"],

    # ØªÙˆØ­Ø¯
    "ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø¶Ø¹ÙŠÙ": ["ØµØ¹ÙˆØ¨Ù‡ ØªÙˆØ§ØµÙ„","Ù†Ø¸Ø±Ù‡ Ø¹ÙŠÙˆÙ† Ø¶Ø¹ÙŠÙÙ‡","Ø¹Ù„Ø§Ù‚Ø§Øª Ù…Ø­Ø¯ÙˆØ¯Ù‡"],
    "Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ù…Ù‚ÙŠØ¯Ø©": ["Ø±ÙˆØªÙŠÙ† ØµØ§Ø±Ù…","ØªÙƒØ±Ø§Ø± Ø­Ø±ÙƒØ§Øª","ØªÙ…ØªÙ…Ù‡","Ø­Ø³Ø§Ø³ÙŠØ§Øª ØµÙˆØª/Ø¶ÙˆØ¡"],

    # Ù†ÙˆÙ…/Ø£ÙƒÙ„
    "Ù†Ù‡Ù…": ["Ø´Ø±Ø§Ù‡Ù‡","Ø§ÙƒÙ„ Ø¨ÙƒØ«Ø±Ù‡","Ù…Ø§ Ø§Ù‚Ø¯Ø± Ø§ÙˆÙ‚Ù Ø§ÙƒÙ„"],
    "ØªØ·Ù‡ÙŠØ±": ["ØªØ±Ø¬ÙŠØ¹ Ù…ØªØ¹Ù…Ø¯","Ø§Ø³ØªÙØ±Ø§Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø§ÙƒÙ„","Ù…Ù„ÙŠÙ†Ø§Øª"],

    # Ø§Ø¯Ù…Ø§Ù†
    "ØªØ¹Ø§Ø·ÙŠ": ["Ø§Ø³ØªØ®Ø¯Ø§Ù…","Ø§Ø¯Ù…Ø§Ù†","Ø§Ø¹ØªÙ…Ø§Ø¯","Ø´Ø±Ø§Ù‡Ù‡ Ø§Ø³ØªØ®Ø¯Ø§Ù…"],
    "Ø§Ù†Ø³Ø­Ø§Ø¨": ["Ø§Ø¹Ø±Ø§Ø¶ Ø§Ù†Ø³Ø­Ø§Ø¨","Ø±Ø¬ÙÙ‡","ØªØ¹Ø±Ù‚","Ø§Ø±Ù‚","Ù‚Ù„Ù‚"],
}

def expand_with_synonyms(text: str) -> str:
    """ÙŠØ¶ÙŠÙ Ù…Ø±Ø§Ø¯ÙØ§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù†Øµ Ù„Ø²ÙŠØ§Ø¯Ø© ÙØ±Øµ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©."""
    text_norm = normalize(text)
    extra = []
    for base, syns in SYNONYMS.items():
        if any(normalize(s) in text_norm for s in [base] + syns):
            extra.extend([base] + syns)
    if extra:
        text_norm += " " + " ".join(set(normalize(w) for w in extra))
    return text_norm

# ============================= Ù‚Ø§Ø¹Ø¯Ø© DSM Ù…ÙˆØ³Ù‘Ø¹Ø© =============================
# Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³ÙŠØ¹ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ÙØ±Ø¯Ø§Øª Ø¹Ø§Ù…ÙŠÙ‘Ø©/Ø·Ø¨ÙŠØ©.
# Ø£Ø¶ÙØª Ù…ÙØ±Ø¯Ø§Øª ÙƒØ«ÙŠØ±Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø±Ø¬ÙˆØ¹ "ØºÙŠØ± ÙƒØ§ÙÙŠØ©".
DSM_DB = {
    # --------- Ø§Ø¶Ø·Ø±Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¬ ---------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§ÙƒØªØ¦Ø§Ø¨ÙŠ Ø¬Ø³ÙŠÙ…": [
        "Ø­Ø²Ù†","Ù…Ø²Ø§Ø¬ Ù…Ù†Ø®ÙØ¶","Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø©","ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ù…ØªØ¹Ø©","ØªØ´Ø§Ø¤Ù…","ØªÙÙƒÙŠØ± Ø³Ù„Ø¨ÙŠ","Ø¨ÙƒØ§Ø¡","Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ",
        "Ø·Ø§Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©","Ø§Ø±Ù‡Ø§Ù‚","ØªØ¹Ø¨","Ø®Ù…ÙˆÙ„","ÙƒØ³Ù„","Ø¨Ø·Ø¡ Ù†ÙØ³ÙŠ Ø­Ø±ÙƒÙŠ",
        "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù†ÙˆÙ…","Ù‚Ù„Ø© Ù†ÙˆÙ…","ÙƒØ«Ø±Ø© Ù†ÙˆÙ…","Ø§Ø±Ù‚","Ù†ÙˆÙ… Ù…ØªÙ‚Ø·Ø¹","Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ Ù…Ø¨ÙƒØ±",
        "Ø´Ù‡ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©","Ù‚Ù„Ø© Ø§ÙƒÙ„","ÙÙ‚Ø¯Ø§Ù† Ø´Ù‡ÙŠØ©","ÙÙ‚Ø¯Ø§Ù† ÙˆØ²Ù†","Ø²ÙŠØ§Ø¯Ø© ÙˆØ²Ù†",
        "ØªØ±ÙƒÙŠØ² Ø¶Ø¹ÙŠÙ","Ø§Ø­ØªÙ‚Ø§Ø± Ø§Ù„Ø°Ø§Øª","Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„Ø°Ù†Ø¨","ÙŠØ£Ø³","Ø§ÙÙƒØ§Ø± Ø§Ù†ØªØ­Ø§Ø±ÙŠØ©","Ø§Ù†ØªØ­Ø§Ø±"
    ],
    "Ø§ÙƒØªØ¦Ø§Ø¨ Ù…Ø³ØªÙ…Ø± (Ø¹Ø³Ø± Ø§Ù„Ù…Ø²Ø§Ø¬)": [
        "Ù…Ø²Ø§Ø¬ Ù…ÙƒØªØ¦Ø¨ Ù…Ø²Ù…Ù†","ØªØ´Ø§Ø¤Ù… Ù…Ø²Ù…Ù†","Ø·Ø§Ù‚Ø© Ù‚Ù„ÙŠÙ„Ø©","Ù†ÙˆÙ… Ø¶Ø¹ÙŠÙ","Ø´Ù‡ÙŠØ© Ù‚Ù„ÙŠÙ„Ø©",
        "Ø«Ù‚Ø© Ø¨Ø§Ù„Ù†ÙØ³ Ù…Ù†Ø®ÙØ¶Ø©","ØªØ±ÙƒÙŠØ² Ø¶Ø¹ÙŠÙ","Ø§Ù†ØªØ§Ø¬ÙŠØ© Ø¶Ø¹ÙŠÙÙ‡","Ø§Ø­Ø¨Ø§Ø· Ù…Ø²Ù…Ù†"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø¨": [
        "Ù†ÙˆØ¨Ø© Ù‡ÙˆØ³","Ù‡ÙˆØ³","Ù†Ø´Ø§Ø· Ø²Ø§Ø¦Ø¯","Ø·Ø§Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©","Ù‚Ù„ÙŠÙ„ Ù†ÙˆÙ…","Ø§Ù†Ø¯ÙØ§Ø¹","ØªÙ‡ÙˆØ±","Ø§ÙÙƒØ§Ø± Ø³Ø¨Ø§Ù‚","Ø·Ù„Ø§Ù‚Ø© Ø§Ù„ÙƒÙ„Ø§Ù…","Ø¹Ø¸Ù…Ø©",
        "Ù†ÙˆØ¨Ø§Øª Ø§ÙƒØªØ¦Ø§Ø¨","ØªØ°Ø¨Ø°Ø¨ Ø§Ù„Ù…Ø²Ø§Ø¬","ØªÙ‚Ù„Ø¨ Ø´Ø¯ÙŠØ¯"
    ],

    # --------- Ø§Ù„Ù‚Ù„Ù‚ ÙˆØ§Ù„Ø·ÙŠÙ ---------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù‚Ù„Ù‚ Ø§Ù„Ø¹Ø§Ù…": [
        "Ù‚Ù„Ù‚","Ù‚Ù„Ù‚ Ù…ÙØ±Ø·","ØªÙˆØªØ±","ØªÙˆØ¬Ø³","Ø§ÙÙƒØ§Ø± Ø³Ù„Ø¨ÙŠØ©","Ø´Ø¯ Ø¹Ø¶Ù„ÙŠ","ØµØ¹ÙˆØ¨Ø© ØªØ±ÙƒÙŠØ²","Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ø³ØªÙØ²Ø§Ø²","Ø§Ø±Ù‚","ØªØ¹Ø¨"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù‡Ù„Ø¹": [
        "Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹","Ø®ÙÙ‚Ø§Ù†","Ø§Ø®ØªÙ†Ø§Ù‚","Ø¶ÙŠÙ‚ Ù†ÙØ³","ØªØ¹Ø±Ù‚","Ø±Ø¬ÙØ©","Ø¯ÙˆØ§Ø±","Ø®ÙˆÙ Ø§Ù„Ù…ÙˆØª","Ø®ÙˆÙ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø³ÙŠØ·Ø±Ø©","ØºØ«ÙŠØ§Ù†","Ø®Ø¯Ø±"
    ],
    "Ø±Ù‡Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ": [
        "Ø®ÙˆÙ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ø®ÙˆÙ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…","Ø®Ø¬Ù„ Ø´Ø¯ÙŠØ¯","ØªØ¬Ù†Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ø§Ø­Ù…Ø±Ø§Ø±","Ø±Ø¬ÙÙ‡","Ù‚Ù„Ù‚ Ø§Ø¯Ø§Ø¡","Ø±Ù‡Ø¨Ù‡ Ù…ÙˆØ§Ø¬Ù‡Ù‡"
    ],
    "Ø±Ù‡Ø§Ø¨ Ù…Ø­Ø¯Ø¯": [
        "Ø±Ù‡Ø§Ø¨","Ø®ÙˆÙ Ø´Ø¯ÙŠØ¯","ØªØ¬Ù†Ø¨ Ù…ÙˆØ§Ù‚Ù","Ø®ÙˆÙ Ù…Ù† Ø·ÙŠØ±Ø§Ù†","Ø®ÙˆÙ Ù…Ù† Ø­Ø´Ø±Ø§Øª","Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ù…Ø±ØªÙØ¹Ø§Øª","Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø¸Ù„Ø§Ù…"
    ],
    "Ø±Ù‡Ø§Ø¨ Ø§Ù„Ø³Ø§Ø­Ø© (Ø§Ù„Ø§Ù…Ø§ÙƒÙ†)": [
        "Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø§Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ÙØªÙˆØ­Ù‡","Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…","ØªØ¬Ù†Ø¨ Ù…ÙˆØ§ØµÙ„Ø§Øª","ØµØ¹ÙˆØ¨Ù‡ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ­ÙŠØ¯Ø§"
    ],

    # --------- Ø§Ù„ÙˆØ³ÙˆØ§Ø³ ÙˆØ§Ù„ØµØ¯Ù…Ø© ---------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„ÙˆØ³ÙˆØ§Ø³ Ø§Ù„Ù‚Ù‡Ø±ÙŠ": [
        "ÙˆØ³ÙˆØ§Ø³","Ø§ÙÙƒØ§Ø± Ø§Ù‚ØªØ­Ø§Ù…ÙŠÙ‡","Ø³Ù„ÙˆÙƒ Ù‚Ù‡Ø±ÙŠ","Ø·Ù‚ÙˆØ³","ØªÙÙ‚Ø¯ Ù…ØªÙƒØ±Ø±","ØºØ³Ù„ Ù…ØªÙƒØ±Ø±","ØªÙ†Ø¸ÙŠÙ… Ù…ÙØ±Ø·","Ø¹Ø¯ Ù‚Ù‡Ø±ÙŠ","Ø®ÙˆÙ ØªÙ„ÙˆØ«"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØµØ¯Ù…Ø©": [
        "Ø­Ø¯Ø« ØµØ§Ø¯Ù…","Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø¯Ø«","ÙÙ„Ø§Ø´ Ø¨Ø§Ùƒ","ÙƒØ§Ø¨ÙˆØ³","ØªØ¬Ù†Ø¨","Ø®Ø¯Ø± Ø¹Ø§Ø·ÙÙŠ","ÙŠÙ‚Ø¸Ù‡ Ù…ÙØ±Ø·Ù‡","Ø­Ø³Ø§Ø³ÙŠÙ‡ ØµÙˆØª","ÙØ±Ø· ÙŠÙ‚Ø¸Ù‡"
    ],

    # --------- Ø§Ù„Ø·ÙŠÙ Ø§Ù„Ø°Ù‡Ø§Ù†ÙŠ ---------
    "ÙØµØ§Ù…": [
        "Ù‡Ù„ÙˆØ³Ø©","Ù‡Ù„Ø§ÙˆØ³ Ø³Ù…Ø¹ÙŠÙ‡","Ø§ÙˆÙ‡Ø§Ù…","Ø¶Ù„Ø§Ù„Ø§Øª","ØªÙÙƒÙŠØ± ØºÙŠØ± Ù…Ù†Ø¸Ù…","Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","ØªØ³Ø·Ø­ ÙˆØ¬Ø¯Ø§Ù†ÙŠ","Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ø±Ø§Ø¯Ù‡"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙØµØ§Ù…ÙŠ Ø¹Ø§Ø·ÙÙŠ": [
        "Ø§Ø¹Ø±Ø§Ø¶ Ø°Ù‡Ø§Ù†ÙŠÙ‡","Ø§ÙƒØªØ¦Ø§Ø¨ Ø´Ø¯ÙŠØ¯","Ù‡ÙˆØ³","ØªØ°Ø¨Ø°Ø¨ Ù…Ø²Ø§Ø¬","Ù‡Ù„ÙˆØ³Ù‡","Ø§ÙˆÙ‡Ø§Ù…"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙˆÙ‡Ø§Ù…ÙŠ": [
        "Ø¶Ù„Ø§Ù„Ø§Øª Ø«Ø§Ø¨ØªÙ‡","ØºÙŠØ±Ù‡ ÙˆÙ‡Ø§Ù…ÙŠÙ‡","Ø§Ø¶Ø·Ù‡Ø§Ø¯","Ø¹Ø¸Ù…Ù‡","Ø´Ùƒ Ù…Ø±Ø¶ÙŠ"
    ],

    # --------- Ù†Ù…Ø§Ø¦ÙŠ/Ø¹ØµØ¨ÙŠ ---------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙØ±Ø· Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØªØ´ØªØª Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡": [
        "ØªØ´ØªØª","Ø¹Ø¯Ù… ØªØ±ÙƒÙŠØ²","ÙØ±Ø· Ø­Ø±ÙƒØ©","Ø§Ù†Ø¯ÙØ§Ø¹ÙŠÙ‡","Ù†Ø³ÙŠØ§Ù†","ØªØ§Ø¬ÙŠÙ„","ØªÙ†Ø¸ÙŠÙ… Ø¶Ø¹ÙŠÙ","ÙƒØ«Ø±Ø© Ø­Ø±ÙƒØ©","Ù…Ù‚Ø§Ø·Ø¹Ù‡","Ù…Ù„Ù„ Ø³Ø±ÙŠØ¹"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø·ÙŠÙ Ø§Ù„ØªÙˆØ­Ø¯": [
        "ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø¶Ø¹ÙŠÙ","ØªÙˆØ§ØµÙ„ ØºÙŠØ± Ù„ÙØ¸ÙŠ Ø¶Ø¹ÙŠÙ","ØµØ¹ÙˆØ¨Ø§Øª Ø¹Ù„Ø§Ù‚Ø§Øª","Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ù…Ù‚ÙŠØ¯Ù‡","Ø±ÙˆØªÙŠÙ† ØµØ§Ø±Ù…",
        "Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø­Ø³ÙŠÙ‡","Ø­Ø±ÙƒØ§Øª Ù†Ù…Ø·ÙŠÙ‡","Ù„ØºØ© Ù…ØªØ£Ø®Ø±Ù‡","Ù‚Ù„Ù‡ ØªÙˆØ§ØµÙ„ Ø¨ØµØ±ÙŠ"
    ],

    # --------- Ù†ÙˆÙ…/Ø£ÙƒÙ„/Ø¬Ø³Ø¯ ---------
    "Ø§Ø±ÙÙ‚ Ù…Ø²Ù…Ù†": ["ØµØ¹ÙˆØ¨Ù‡ Ù†ÙˆÙ…","Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ Ù…Ø¨ÙƒØ±","Ù†ÙˆÙ… Ù…ØªÙ‚Ø·Ø¹","Ø¹Ø¯Ù… Ø±Ø§Ø­Ù‡","Ø§Ø¬Ù‡Ø§Ø¯ Ù†Ù‡Ø§Ø±ÙŠ"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù†Ù‡Ù… Ø§Ù„Ø·Ø¹Ø§Ù…": ["Ù†Ù‡Ù…","Ø§ÙƒÙ„ Ø¨Ø´Ø±Ø§Ù‡Ù‡","ÙÙ‚Ø¯Ø§Ù† ØªØ­ÙƒÙ…","Ø§ÙƒÙ„ Ø³Ø±Ø§","Ù†Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø§ÙƒÙ„","Ø²ÙŠØ§Ø¯Ù‡ ÙˆØ²Ù†"],
    "Ù†Ù‡Ø§Ù… Ø¹ØµØ¨ÙŠ": ["Ù†Ù‡Ù… Ù…ØªÙƒØ±Ø±","ØªØ·Ù‡ÙŠØ±","Ø§Ø³ØªÙØ±Ø§Øº","Ù…Ù„ÙŠÙ†Ø§Øª","ØµÙˆØ±Ø© Ø¬Ø³Ø¯ Ù…Ø´ÙˆÙ‡Ù‡"],
    "Ù‚Ù‡Ù… Ø¹ØµØ¨ÙŠ": ["Ù†Ù‚Øµ ÙˆØ²Ù† Ø´Ø¯ÙŠØ¯","Ø®ÙˆÙ Ù…Ù† Ø²ÙŠØ§Ø¯Ù‡ Ø§Ù„ÙˆØ²Ù†","ØµÙˆØ±Ø© Ø¬Ø³Ø¯ Ø³Ù„Ø¨ÙŠÙ‡","ØªÙ‚ÙŠÙŠØ¯ Ø·Ø¹Ø§Ù…"],
    "Ø§Ø¹Ø±Ø§Ø¶ Ø¬Ø³Ø¯ÙŠÙ‡ (Ø³ÙˆÙ…Ø§ØªÙŠØ²ÙŠØ´Ù†)": ["Ø§Ù„Ù… ØºÙŠØ± Ù…ÙØ³Ø±","Ø§Ø¹Ø±Ø§Ø¶ Ø¬Ø³Ø¯ÙŠÙ‡ Ù…ØªØ¹Ø¯Ø¯Ù‡","Ø§Ù†Ø´ØºØ§Ù„ ØµØ­ÙŠ","Ø²ÙŠØ§Ø±Ù‡ Ø§Ø·Ø¨Ø§Ø¡ ÙƒØ«ÙŠØ±Ù‡"],
    "Ù‚Ù„Ù‚ Ø§Ù„Ù…Ø±Ø¶ (Ù‡ÙŠØ¨ÙˆÙƒÙˆÙ†Ø¯Ø±ÙŠØ§)": ["Ø®ÙˆÙ Ù…Ø±Ø¶ Ø®Ø·ÙŠØ±","ØªÙÙ‚Ø¯ Ø¬Ø³Ø¯","Ø·Ù…Ø£Ù†Ù‡ Ù…ØªÙƒØ±Ø±Ù‡","Ø¨Ø­Ø« Ø·Ø¨ÙŠ Ù…Ø³ØªÙ…Ø±"],

    # --------- Ø§Ø¯Ù…Ø§Ù† Ù…ÙˆØ§Ø¯ ---------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„ÙƒØ­ÙˆÙ„": [
        "ÙƒØ­ÙˆÙ„","Ø³ÙƒØ± Ù…ØªÙƒØ±Ø±","ØªØ­Ù…Ù„","Ø§Ø¹Ø±Ø§Ø¶ Ø§Ù†Ø³Ø­Ø§Ø¨","ÙÙ‚Ø¯Ø§Ù† Ø³ÙŠØ·Ø±Ø©","Ù…Ø´Ø§ÙƒÙ„ Ø¹Ù…Ù„","Ù…Ø´Ø§ÙƒÙ„ Ø¹Ù„Ø§Ù‚Ø§Øª"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ù‚Ù†Ø¨": [
        "Ø­Ø´ÙŠØ´","Ù‚Ù†Ø¨","Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙŠÙˆÙ…ÙŠ","ØªØ³Ø§Ù…Ø­","Ø§Ù†Ø³Ø­Ø§Ø¨","Ù‚Ù„Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ÙŠÙ‚Ø§Ù"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ù…Ù†Ø¨Ù‡Ø§Øª": [
        "Ù…Ù†Ø´Ø·Ø§Øª","Ø§Ù…ÙÙŠØªØ§Ù…ÙŠÙ†","ÙƒÙˆÙƒØ§ÙŠÙŠÙ†","Ø³Ù‡Ø±","ÙÙ‚Ø¯Ø§Ù† Ø´Ù‡ÙŠÙ‡","Ø¨Ø§Ø±Ø§Ù†ÙˆÙŠØ§","Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ù‡Ø±ÙŠ"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ø§ÙÙŠÙˆÙ†Ø§Øª": [
        "Ù‡ÙŠØ±ÙˆÙŠÙ†","Ù…ÙˆØ±ÙÙŠÙ†","Ø§ÙˆÙƒØ³ÙŠØ¯ÙˆØ¯ÙˆÙ†","Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§ÙÙŠÙˆØªÙŠ","Ø±ØºØ¨Ù‡ Ù…Ù„Ø­Ù‡","ØªØ­Ù…Ù„"
    ],

    # --------- Ø§Ù„Ø´Ø®ØµÙŠØ© ---------
    "Ø´Ø®ØµÙŠØ© Ø­Ø¯Ù‘ÙŠØ©": ["Ø§Ù†Ø¯ÙØ§Ø¹","ØªÙ‚Ù„Ø¨ Ø¹Ø§Ø·ÙÙŠ","Ø®ÙˆÙ Ù‡Ø¬Ø±","Ø§ÙŠØ°Ø§Ø¡ Ø°Ø§ØªÙŠ","ÙØ±Ø§Øº Ù…Ø²Ù…Ù†","Ø¹Ù„Ø§Ù‚Ø§Øª ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±Ø©"],
    "Ø´Ø®ØµÙŠØ© Ù†Ø±Ø¬Ø³ÙŠØ©": ["Ø¹Ø¸Ù…Ù‡","Ø­Ø§Ø¬Ù‡ Ø§Ø¹Ø¬Ø§Ø¨","ØªØ¹Ø§Ø·Ù Ù‚Ù„ÙŠÙ„","Ø§Ø³ØªØºÙ„Ø§Ù„ÙŠ","Ø­Ø³Ø§Ø³ Ù„Ù„Ù†Ù‚Ø¯"],
    "Ø´Ø®ØµÙŠØ© Ù…Ø¹Ø§Ø¯ÙŠØ© Ù„Ù„Ù…Ø¬ØªÙ…Ø¹": ["Ø®Ø±Ù‚ Ù‚ÙˆØ§Ø¹Ø¯","Ø¹Ø¯ÙˆØ§Ù†ÙŠÙ‡","Ø®Ø¯Ø§Ø¹","Ø§Ù†Ø¯ÙØ§Ø¹","Ù„Ø§Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ‡","Ù†Ø¯Ù… Ù‚Ù„ÙŠÙ„"],
    "Ø´Ø®ØµÙŠØ© Ø§Ø¬ØªÙ†Ø§Ø¨ÙŠØ©": ["ØªØ¬Ù†Ø¨ Ù†Ù‚Ø¯","Ø®Ø¬Ù„ Ø´Ø¯ÙŠØ¯","Ù†Ù‚Øµ ÙƒÙØ§Ø¡Ù‡","Ø­Ø³Ø§Ø³ÙŠÙ‡ Ø±ÙØ¶"],
    "Ø´Ø®ØµÙŠØ© Ø§ØªÙƒØ§Ù„ÙŠÙ‡": ["Ø§ØªÙƒØ§Ù„ÙŠÙ‡","ØµØ¹ÙˆØ¨Ù‡ Ù‚Ø±Ø§Ø±","Ø®ÙˆÙ ÙØ±Ø§Ù‚","Ø§Ø­ØªÙŠØ§Ø¬ Ø¯Ø¹Ù… Ù…Ø³ØªÙ…Ø±"],
    "Ø´Ø®ØµÙŠØ© ÙˆØ³ÙˆØ§Ø³ÙŠØ© Ù‚Ù‡Ø±ÙŠØ©": ["Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„","ÙƒÙ…Ø§Ù„ÙŠÙ‡","ØµØ±Ø§Ù…Ù‡","Ø¹Ù†Ø§Ø¯","Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯"],
    "Ø´Ø®ØµÙŠØ© Ø§Ù†Ø³Ø­Ø§Ø¨ÙŠØ©": ["Ø¨Ø±ÙˆØ¯ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ù‚Ù„Ø© Ù…ØªØ¹Ù‡","Ø§Ù†Ø¹Ø²Ø§Ù„","Ù‚Ù„Ø© Ø¹Ù„Ø§Ù‚Ø§Øª ÙˆØ«ÙŠÙ‚Ù‡"],

    # --------- Ù…Ø¹Ø±ÙÙŠ/Ù‡Ø±Ù…ÙˆÙ†ÙŠ/ØªÙƒÙŠÙ‘ÙÙŠ ---------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªÙƒÙŠÙ": ["ØªÙˆØªØ± Ù…ÙˆÙ‚Ù","Ø­Ø²Ù† Ø¨Ø¹Ø¯ Ø­Ø¯Ø«","Ù‚Ù„Ù‚ Ø¸Ø±ÙÙŠ","ØªØ±Ø§Ø¬Ø¹ Ø§Ø¯Ø§Ø¡ Ø¨Ø¹Ø¯ Ø¶ØºØ·"],
    "Ø§ÙƒØªØ¦Ø§Ø¨ Ù…Ø§ Ø­ÙˆÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©": ["Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ù‡","Ø­Ø²Ù† Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ„Ø§Ø¯Ù‡","Ø¨ÙƒØ§Ø¡","Ù‚Ù„Ù‚ Ø·ÙÙ„","Ù†ÙˆÙ… Ù…Ø¶Ø·Ø±Ø¨"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ù…Ø« Ø§Ù„Ù…Ø²Ø¹Ø¬": ["ØªÙ‚Ù„Ø¨ Ù…Ø²Ø§Ø¬ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙˆØ±Ù‡","ØªÙ‡ÙŠØ¬","Ø­Ø³Ø§Ø³ÙŠÙ‡","Ø§Ù†ØªÙØ§Ø®","Ø´Ù‡ÙŠÙ‡"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…Ø¹Ø±ÙÙŠ Ø®ÙÙŠÙ/Ø®Ø±Ù Ù…Ø¨ÙƒØ±": ["Ù†Ø³ÙŠØ§Ù† Ø¬Ø¯ÙŠØ¯","Ø¶ÙŠØ§Ø¹","Ø¨Ø·Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ù‡","ØªØ±Ø§Ø¬Ø¹ ØªÙ†ÙÙŠØ°ÙŠ"]
}

# ============================= ØªØ¹Ø²ÙŠØ²Ø§Øª Ø§Ù„ØªØ±Ø¬ÙŠØ­ (Ø³Ù†/Ø¬Ù†Ø³/Ù…Ø¯Ø©/Ø£Ø«Ø±) =============================
def duration_boost(duration_days: str) -> float:
    try:
        d = float(duration_days)
    except:
        return 0.0
    if d >= 365: return 2.0
    if d >= 90:  return 1.0
    if d >= 30:  return 0.5
    return 0.0

def gender_bias(gender: str, disorder: str) -> float:
    g = normalize(gender)
    if "Ø§Ù†Ø«Ù‰" in g:
        if "Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ù…Ø«" in disorder or "Ù…Ø§ Ø­ÙˆÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©" in disorder:
            return 1.0
    return 0.0

def age_bias(age: str, disorder: str) -> float:
    try:
        a = int(age)
    except:
        return 0.0
    if a < 16 and "ÙØ±Ø· Ø§Ù„Ø­Ø±ÙƒØ©" in disorder:
        return 1.0
    if a >= 50 and ("Ù…Ø¹Ø±ÙÙŠ" in disorder or "Ø®Ø±Ù" in disorder):
        return 1.0
    return 0.0

def impairment_boost(history_text: str) -> float:
    """ØªØ¹Ø²ÙŠØ² Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø£Ø«Ø± ÙˆØ¸ÙŠÙÙŠ ÙˆØ§Ø¶Ø­."""
    if not history_text: return 0.0
    t = normalize(history_text)
    keys = ["Ù…Ø´Ø§ÙƒÙ„ Ø¹Ù…Ù„","ÙØµÙ„","Ø§Ù†Ø°Ø§Ø±","Ù…Ø´Ø§ÙƒÙ„ Ø²ÙˆØ§Ø¬","Ø·Ù„Ø§Ù‚","Ø®Ù„Ø§ÙØ§Øª","Ù…Ø®Ø§Ù„ÙÙ‡","Ù‚Ø¶ÙŠÙ‡","Ù…Ø´Ø§ÙƒÙ„ Ù…Ø§Ù„ÙŠÙ‡","ØªØ¹Ø«Ø± Ø¯Ø±Ø§Ø³ÙŠ"]
    if any(normalize(k) in t for k in keys):
        return 0.5
    return 0.0

# ============================= Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© =============================
def score_diagnoses(symptoms_text: str, age: str="", gender: str="", duration: str="", history: str=""):
    """ØªØ¹Ø·ÙŠ ØªØ±ØªÙŠØ¨Ù‹Ø§ Ù„Ù„ØªØ´Ø®ÙŠØµØ§Øª Ø¨Ø£ÙˆØ²Ø§Ù† Ù…Ø­Ø³Ù‘Ù†Ø© + Ø§Ù‚ØªØ±Ø§Ø­ ÙƒÙ„Ù…Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©."""
    text_raw = symptoms_text or ""
    # ØªÙˆØ³Ø¹Ø© Ø¨Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª
    text_norm = expand_with_synonyms(text_raw)

    scores = defaultdict(float)
    hits_by_disorder = {}

    for disorder, keywords in DSM_DB.items():
        local_hits = []
        sc = 0.0
        for kw in keywords:
            kw_n = normalize(kw)
            # ÙˆØ²Ù† Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ ÙˆØ£Ù‚Ù„ Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙØ±Ø¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ
            if contains_phrase(text_norm, kw):
                w = 1.0
                # Ø¨Ø¹Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ø§Ù„Ù‚ÙˆÙŠØ©
                if kw_n in ("Ø§Ù†ØªØ­Ø§Ø±","Ø§ÙÙƒØ§Ø± Ø§Ù†ØªØ­Ø§Ø±ÙŠØ©","Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹","Ù‡Ù„ÙˆØ³Ø©","Ø§ÙˆÙ‡Ø§Ù…","Ø¶Ù„Ø§Ù„Ø§Øª"):
                    w = 1.8
                sc += w
                local_hits.append(kw)
            else:
                # Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¦ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª
                toks = set(tokenize(text_norm))
                if kw_n in toks:
                    sc += 0.6
                    local_hits.append(kw)

        # ØªØ¹Ø²ÙŠØ²Ø§Øª: Ø³Ù†/Ø¬Ù†Ø³/Ù…Ø¯Ù‘Ø©/Ø£Ø«Ø±
        sc += duration_boost(duration)
        sc += gender_bias(gender, disorder)
        sc += age_bias(age, disorder)
        sc += impairment_boost(history)

        if sc > 0:
            scores[disorder] = sc
            hits_by_disorder[disorder] = local_hits

    # Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ Ø£ÙŠ Ù†ØªÙŠØ¬Ø©ØŒ Ø§Ù‚ØªØ±Ø­ Ø£Ù‚Ø±Ø¨ ÙØ¦Ø© Ø¹Ø§Ù…Ø© Ø¨Ø¯Ù„ "ØºÙŠØ± ÙƒØ§ÙÙŠØ©"
    if not scores:
        # Ø§Ù‚ØªØ±Ø§Ø­ Ø¹Ø§Ù… Ø­Ø³Ø¨ ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ø±Ø²Ø©
        buckets = {
            "Ù…Ø²Ø§Ø¬/Ø§ÙƒØªØ¦Ø§Ø¨": ["Ø­Ø²Ù†","Ù…Ø²Ø§Ø¬","Ù…ØªØ¹Ù‡","ÙŠØ£Ø³","Ù†ÙˆÙ…","Ø·Ø§Ù‚Ù‡","Ø°Ù†Ø¨"],
            "Ù‚Ù„Ù‚/Ù‡Ù„Ø¹": ["Ù‚Ù„Ù‚","ØªÙˆØªØ±","Ù†ÙˆØ¨Ù‡","Ø®ÙÙ‚Ø§Ù†","Ø§Ø®ØªÙ†Ø§Ù‚","Ø®ÙˆÙ"],
            "ÙˆØ³ÙˆØ§Ø³ Ù‚Ù‡Ø±ÙŠ": ["ÙˆØ³ÙˆØ§Ø³","Ø·Ù‚ÙˆØ³","ØºØ³Ù„","ØªÙÙ‚Ø¯","ØªÙ„ÙˆØ«"],
            "ØµØ¯Ù…Ø©": ["Ø­Ø¯Ø«","ÙÙ„Ø§Ø´","ÙƒÙˆØ§Ø¨ÙŠØ³","ØªØ¬Ù†Ø¨"],
            "Ø°Ù‡Ø§Ù†": ["Ù‡Ù„ÙˆØ³Ù‡","Ø§ÙˆÙ‡Ø§Ù…","Ø¶Ù„Ø§Ù„Ø§Øª"],
            "Ø§Ù†ØªØ¨Ø§Ù‡/Ø­Ø±ÙƒÙ‡": ["ØªØ´ØªØª","ØªØ±ÙƒÙŠØ²","ÙØ±Ø·","Ø§Ù†Ø¯ÙØ§Ø¹"],
            "ØªÙˆØ­Ø¯": ["ØªÙˆØ§ØµÙ„","Ø±ÙˆØªÙŠÙ†","Ø­Ø³Ø§Ø³ÙŠØ§Øª"],
            "Ù†ÙˆÙ…/Ø£ÙƒÙ„": ["Ù†ÙˆÙ…","Ø´Ù‡ÙŠØ©","Ù†Ù‡Ù…","ØªØ·Ù‡ÙŠØ±"],
            "Ø§Ø¯Ù…Ø§Ù†": ["ØªØ¹Ø§Ø·ÙŠ","Ø§Ù†Ø³Ø­Ø§Ø¨","ØªØ­Ù…Ù„"]
        }
        txt = normalize(text_raw)
        hints = []
        for label, kws in buckets.items():
            if any(normalize(k) in txt for k in kws):
                hints.append(label)
        return [], {"suggestion": "Ø¬Ø±Ù‘Ø¨ Ø¥Ø¶Ø§ÙØ© ÙˆØµÙ Ø£Ø¯Ù‚ Ù„Ù„Ø£Ø¹Ø±Ø§Ø¶ (Ø§Ù„Ù…Ø¯Ø©/Ø§Ù„Ø´Ø¯Ø©/Ø§Ù„Ø³ÙŠØ§Ù‚).",
                    "buckets": hints[:3]}

    ranked = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    # Ø¨Ù†Ø§Ø¡ ØªÙØ§ØµÙŠÙ„ ØºÙ†ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶
    details = []
    for d, sc in ranked[:5]:
        hits = hits_by_disorder.get(d, [])
        details.append({
            "name": d,
            "score": round(sc, 2),
            "hits": ", ".join(hits[:7]) + ("..." if len(hits) > 7 else "")
        })
    return details, None

# ============================= Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø© =============================
_BASE = """
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#0b3a75;--bg2:#0a65b0;--gold:#f4b400}
    *{box-sizing:border-box}
    body{font-family:"Tajawal",system-ui;background:linear-gradient(135deg,var(--bg1),var(--bg2)) fixed;color:#fff;margin:0}
    .wrap{max-width:1180px;margin:28px auto;padding:16px}
    .bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:18px;backdrop-filter:blur(6px)}
    a.btn,button.btn{display:inline-block;background:var(--gold);color:#2b1b02;border-radius:14px;padding:12px 16px;text-decoration:none;font-weight:800;border:none;cursor:pointer}
    label{display:block;color:#ffe28a;margin:8px 2px 6px}
    input,select,textarea{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);color:#fff;padding:12px 14px}
    textarea{min-height:130px;resize:vertical}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .result{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.85rem;margin:4px 0}
    .ok{background:#16a34a;color:#fff}
    .warn{background:#ef4444;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid rgba(255,255,255,.15);padding:8px 6px;text-align:right}
    th{color:#ffe28a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h2 style="margin:0">{{ heading }}</h2>
      <a class="btn" href="/">Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</a>
    </div>
    {{ body|safe }}
  </div>
</body>
</html>
"""

def _render(title, heading, body):
    return render_template_string(_BASE, title=title, heading=heading, body=body)

# ============================= Ø§Ù„Ø¹Ø±Ø¶ (GET/POST) =============================
def render_dsm_get():
    form_html = """
    <div class="grid">
      <section class="card">
        <form method="post">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input name="name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ù†Ø²ÙŠ"></div>
            <div><label>Ø§Ù„Ø¹Ù…Ø±</label><input name="age" placeholder="30"></div>
            <div><label>Ø§Ù„Ø¬Ù†Ø³</label>
              <select name="gender"><option value="">â€” Ø§Ø®ØªØ± â€”</option><option>Ø°ÙƒØ±</option><option>Ø£Ù†Ø«Ù‰</option></select>
            </div>
            <div><label>Ù…Ø¯Ø© Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label><input name="duration" placeholder="Ù…Ø«Ø§Ù„: 60"></div>
          </div>
          <label>Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ (Ø§Ø°ÙƒØ± ÙƒÙ„Ù…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙØ±Ø¯Ø§Øª Ø¹Ø§Ù…ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª)</label>
          <textarea name="symptoms" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø²Ù† Ø´Ø¯ÙŠØ¯ØŒ Ø®Ù…ÙˆÙ„ØŒ Ù‚Ù„Ø© Ù†ÙˆÙ…ØŒ ÙÙ‚Ø¯Ø§Ù† Ø´Ù‡ÙŠØ©ØŒ Ø§Ù†Ø³Ø­Ø§Ø¨ Ø¹Ù† Ø§Ù„Ù†Ø§Ø³..."></textarea>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ/Ø§Ù„Ù†ÙØ³ÙŠ ÙˆØ§Ù„Ø£Ø«Ø± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea name="history" placeholder="Ø£Ø¯ÙˆÙŠØ© Ø­Ø§Ù„ÙŠØ©ØŒ Ø¬Ù„Ø³Ø§Øª Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù…Ø´Ø§ÙƒÙ„ Ø¹Ù…Ù„/Ø¯Ø±Ø§Ø³Ø©ØŒ Ø®Ù„Ø§ÙØ§Øª Ø£Ø³Ø±ÙŠØ©..."></textarea>
          <div style="margin-top:10px"><button class="btn" type="submit">ØªØ´Ø®ÙŠØµ Ù…Ø¨Ø¯Ø¦ÙŠ</button></div>
        </form>
      </section>
      <aside class="result"><span class="badge warn">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯</span><p>Ø§Ù…Ù„Ø£ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø¨Ø¯Ù‚Ø© Ø«Ù… Ø§Ø¶ØºØ· ØªØ´Ø®ÙŠØµ. Ø³Ù†Ø¹Ø±Ø¶ Ù„Ùƒ Ø£ÙØ¶Ù„ 5 ØªØ±Ø´ÙŠØ­Ø§Øª Ø¯Ø§Ø¦Ù…Ù‹Ø§.</p></aside>
    </div>
    """
    return _render("DSM-5 | Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© ÙˆØªØ´Ø®ÙŠØµ", "ğŸ—‚ï¸ Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© + ØªØ´Ø®ÙŠØµ (DSM-5)", form_html)

def render_dsm_post(form):
    name = form.get("name","").strip()
    age = form.get("age","").strip()
    gender = form.get("gender","").strip()
    duration = form.get("duration","").strip()
    symptoms = form.get("symptoms","").strip()
    history = form.get("history","").strip()

    details, fallback = score_diagnoses(symptoms, age=age, gender=gender, duration=duration, history=history)

    if fallback is not None:
        result_html = f"""
        <div class="result">
          <h3>ğŸ“‹ Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
          <p><span class="badge warn">Ù„Ø§ ØªØ·Ø§Ø¨Ù‚Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙƒØ§ÙÙŠØ©</span> â€” Ø¬Ø±Ù‘Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…ÙØ±Ø¯Ø§Øª Ø£ÙˆØ¶Ø­ Ù„Ù„Ø£Ø¹Ø±Ø§Ø¶ (Ù…Ø«Ø§Ù„: <em>Ø­Ø²Ù†ØŒ Ù‚Ù„Ù‚ØŒ Ø£Ø±Ù‚ØŒ Ù†Ù‡Ù…ØŒ ÙˆØ³ÙˆØ§Ø³...</em>)</p>
          {"<p><strong>Ø£Ù‚Ø±Ø¨ ÙØ¦Ø§Øª:</strong> " + ", ".join(fallback.get("buckets", [])) + "</p>" if fallback.get("buckets") else ""}
          <p>Ù†Ù‚ØªØ±Ø­ Ø°ÙƒØ± <strong>Ø§Ù„Ù…Ø¯Ø©</strong> Ø¨Ø¯Ù‚Ø©ØŒ ÙˆÙˆØ¬ÙˆØ¯ <strong>Ø£Ø«Ø± ÙˆØ¸ÙŠÙÙŠ</strong> (Ù…Ø´Ø§ÙƒÙ„ Ø¹Ù…Ù„/Ø¯Ø±Ø§Ø³Ø©)ØŒ ÙˆØ£ÙŠ <strong>Ø¹Ù„Ø§Ø¬Ø§Øª/Ø£Ø¯ÙˆÙŠØ©</strong> Ø­Ø§Ù„ÙŠØ©.</p>
        </div>
        """
    else:
        # Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù„Ø£ÙØ¶Ù„ 5 ØªØ±Ø´ÙŠØ­Ø§Øª
        rows = []
        for item in details:
            rows.append(f"<tr><td>{item['name']}</td><td>{item['score']}</td><td>{item['hits']}</td></tr>")
        table = "<table><thead><tr><th>Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ù‚ØªØ±Ø­</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>ÙƒÙ„Ù…Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</th></tr></thead><tbody>" + "".join(rows) + "</tbody></table>"
        result_html = f"""
        <div class="result">
          <h3>ğŸ“‹ Ø£Ù‚Ø±Ø¨ Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª (Ø£ÙØ¶Ù„ 5)</h3>
          {table}
          <p style="opacity:.85;margin-top:8px">âš ï¸ Ù†ØªÙŠØ¬Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙ„ÙŠØ³Øª ØªØ´Ø®ÙŠØµÙ‹Ø§ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. ÙŠÙÙ†ØµØ­ Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ.</p>
        </div>
        """

    body = f"""
    <div class="grid">
      <section class="card">
        <form method="post">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input name="name" value="{name}"></div>
            <div><label>Ø§Ù„Ø¹Ù…Ø±</label><input name="age" value="{age}"></div>
            <div><label>Ø§Ù„Ø¬Ù†Ø³</label>
              <select name="gender">
                <option value="" {"selected" if not gender else ""}>â€” Ø§Ø®ØªØ± â€”</option>
                <option {"selected" if gender=="Ø°ÙƒØ±" else ""}>Ø°ÙƒØ±</option>
                <option {"selected" if gender=="Ø£Ù†Ø«Ù‰" else ""}>Ø£Ù†Ø«Ù‰</option>
              </select>
            </div>
            <div><label>Ù…Ø¯Ø© Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label><input name="duration" value="{duration}"></div>
          </div>
          <label>Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</label>
          <textarea name="symptoms">{symptoms}</textarea>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ/Ø§Ù„Ù†ÙØ³ÙŠ ÙˆØ§Ù„Ø£Ø«Ø± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
          <textarea name="history">{history}</textarea>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" type="submit">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ</button>
            <a class="btn" href="/">Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</a>
          </div>
        </form>
      </section>
      {result_html}
    </div>
    """
    return _render("DSM-5 | Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© ÙˆØªØ´Ø®ÙŠØµ", "ğŸ—‚ï¸ Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© + ØªØ´Ø®ÙŠØµ (DSM-5)", body)

# Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ù„Ù site_app.py ÙŠØ³ØªÙˆØ±Ø¯:
# from dsm_suite import render_dsm_get, render_dsm_post
# Ø«Ù… ÙŠØ±Ø¨Ø· Ø§Ù„Ù…Ø³Ø§Ø± /dsm Ø¨Ù€ GET/POST Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„.
