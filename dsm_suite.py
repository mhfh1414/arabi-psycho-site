# -*- coding: utf-8 -*-
# dsm_suite.py â€” Ù‚Ø§Ø¹Ø¯Ø© DSM Ù…ÙˆØ³Ø¹Ø© + Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© + Ù…Ø·Ø§Ø¨Ù‚Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ø£Ø¹Ø±Ø§Ø¶ (ØªØ´Ø®ÙŠØµ Ù…Ø±Ø¬Ù‘Ø­ ÙˆØ§Ø­Ø¯)

from flask import Blueprint, render_template_string, request
import re

dsm_bp = Blueprint("dsm", __name__, url_prefix="/dsm")

# ============================== Ø£Ø¯ÙˆØ§Øª Ù†Øµ Ø¹Ø±Ø¨ÙŠØ© ==============================
_AR_DIAC  = r"[ÙÙ‹ÙÙŒÙÙÙ’Ù‘Ù€]"
_AR_PUNCT = r"[.,ØŒ;Ø›!?ØŸ()\[\]{}\"\'<>:]"

def normalize(s: str) -> str:
    if not s: return ""
    s = re.sub(_AR_DIAC, "", s.strip())
    s = re.sub(_AR_PUNCT, " ", s)
    s = (s.replace("Ø£","Ø§").replace("Ø¥","Ø§").replace("Ø¢","Ø§")
           .replace("Ø©","Ù‡").replace("Ù‰","ÙŠ").replace("Ø¤","Ùˆ").replace("Ø¦","ÙŠ")
           .replace("Ù€","").replace("ï»»","Ù„Ø§").replace("ï»·","Ù„Ø§"))
    s = re.sub(r"\s+", " ", s)
    return s.lower()

def tokens(s: str) -> set:
    return set(normalize(s).split())

def soft_contains(text_norm: str, phrase: str) -> bool:
    """Ù…Ø·Ø§Ø¨Ù‚Ø© Ù†Ø§Ø¹Ù…Ø©: ØªØ¹ØªØ¨Ø± Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª ÙƒÙ„ ÙƒÙ„Ù…Ø§ØªÙ‡Ø§ Ø¨Ø§Ù„Ù†Øµ"""
    ptoks = set(normalize(phrase).split())
    return ptoks.issubset(tokens(text_norm))

# Ù…Ø±Ø§Ø¯ÙØ§Øª Ù…Ø®ØªØµØ±Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©
SYN = {
    "Ø­Ø²Ù†": ["ÙƒØ§Ø¨Ù‡","ØªØ¹Ø§Ø³Ù‡","Ø²Ø¹Ù„","Ø¶ÙŠÙ‚Ù‡","Ø·ÙØ´","ØºÙ…"],
    "Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø©": ["ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ù…ØªØ¹Ù‡","Ù…Ø§ Ø§Ø³ØªÙ…ØªØ¹","Ù…Ø§ Ø¹Ø§Ø¯ ÙŠÙØ±Ø­Ù†ÙŠ Ø´ÙŠ","ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…"],
    "Ø·Ø§Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©": ["Ø®Ù…ÙˆÙ„","ÙƒØ³Ù„","Ø§Ø±Ù‡Ø§Ù‚","ØªØ¹Ø¨","ÙˆÙ‡Ù†"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù†ÙˆÙ…": ["Ø§Ø±Ù‚","Ù‚Ù„Ø© Ù†ÙˆÙ…","Ù†ÙˆÙ… Ù…ØªÙ‚Ø·Ø¹","Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ Ù…Ø¨ÙƒØ±","ÙƒØ«Ø±Ø© Ù†ÙˆÙ…","ÙƒÙˆØ§Ø¨ÙŠØ³","Ù†Ø¹Ø§Ø³"],
    "Ø´Ù‡ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©": ["Ù‚Ù„Ø© Ø§ÙƒÙ„","Ø³Ø¯Øª Ù†ÙØ³ÙŠ","ÙÙ‚Ø¯Ø§Ù† Ø´Ù‡ÙŠÙ‡"],
    "Ø´Ù‡ÙŠØ© Ø²Ø§Ø¦Ø¯Ø©": ["Ù†Ù‡Ù…","Ø§ÙƒÙ„ ÙƒØ«ÙŠØ±","Ø´Ø±Ø§Ù‡Ù‡"],
    "Ù‚Ù„Ù‚": ["ØªÙˆØªØ±","ØªÙˆØ¬Ø³","Ø¹Ù„Ù‰ Ø§Ø¹ØµØ§Ø¨ÙŠ","Ù‚Ù„Ù‚ Ù…ÙØ±Ø·"],
    "Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹": ["Ø®ÙÙ‚Ø§Ù†","Ø§Ø®ØªÙ†Ø§Ù‚","Ø¶ÙŠÙ‚ Ù†ÙØ³","Ø°Ø¹Ø±","Ø±Ø¬ÙÙ‡","ØªØ¹Ø±Ù‚","Ø¯ÙˆØ§Ø±"],
    "Ø®ÙˆÙ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ": ["Ø±Ù‡Ø¨Ù‡ Ù…ÙˆØ§Ø¬Ù‡Ù‡","Ø®Ø¬Ù„ Ø´Ø¯ÙŠØ¯","Ù‚Ù„Ù‚ Ø§Ø¯Ø§Ø¡"],
    "Ø®ÙˆÙ Ø´Ø¯ÙŠØ¯": ["ÙÙˆØ¨ÙŠØ§","Ø®ÙˆÙ Ø·ÙŠØ±Ø§Ù†","Ø®ÙˆÙ Ø§Ù„Ù…Ø±ØªÙØ¹Ø§Øª","Ø®ÙˆÙ Ø§Ù„Ø¸Ù„Ø§Ù…","Ø®ÙˆÙ Ø­Ù‚Ù†","Ø®ÙˆÙ Ø­Ø´Ø±Ø§Øª","Ø®ÙˆÙ Ø¯Ù…"],
    "ÙˆØ³ÙˆØ§Ø³": ["Ø§ÙÙƒØ§Ø± Ù…ØªØ³Ù„Ø·Ù‡","Ø§Ù‚ØªØ­Ø§Ù…ÙŠÙ‡","Ù‡ÙˆØ§Ø¬Ø³","Ø®ÙˆÙ ØªÙ„ÙˆØ«"],
    "Ø³Ù„ÙˆÙƒ Ù‚Ù‡Ø±ÙŠ": ["Ø·Ù‚ÙˆØ³","ØªÙÙ‚Ø¯ Ù…ØªÙƒØ±Ø±","Ø¹Ø¯ Ù‚Ù‡Ø±ÙŠ","ØºØ³Ù„ Ù…ØªÙƒØ±Ø±","ØªÙ†Ø¸ÙŠÙ… Ù…ÙØ±Ø·"],
    "Ø­Ø¯Ø« ØµØ§Ø¯Ù…": ["ØªØ¹Ø±Ø¶Øª Ù„Ø­Ø§Ø¯Ø«","Ø§Ø¹ØªØ¯Ø§Ø¡","ÙƒØ§Ø±Ø«Ù‡","Ø­Ø±Ø¨","ÙÙ‚Ø¯ Ø¹Ø²ÙŠØ²","ØªÙ†Ù…Ø± Ù‚Ø§Ø³"],
    "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø¯Ø«": ["ÙÙ„Ø§Ø´ Ø¨Ø§Ùƒ","Ø°ÙƒØ±ÙŠØ§Øª Ù…Ø¤Ù„Ù…Ù‡"],
    "Ù‡Ù„ÙˆØ³Ø©": ["Ù‡Ù„Ø§ÙˆØ³ Ø³Ù…Ø¹ÙŠÙ‡","Ø§Ø³Ù…Ø¹ Ø§ØµÙˆØ§Øª","Ø§Ø´ÙˆÙ Ø§Ø´ÙŠØ§Ø¡"],
    "Ø§ÙˆÙ‡Ø§Ù…": ["Ø¶Ù„Ø§Ù„Ø§Øª","Ø§Ø¹ØªÙ‚Ø§Ø¯Ø§Øª ÙˆÙ‡Ù…ÙŠÙ‡","Ø§Ø¶Ø·Ù‡Ø§Ø¯","Ø¹Ø¸Ù…Ù‡","ØºÙŠØ±Ù‡ ÙˆÙ‡Ø§Ù…ÙŠÙ‡"],
    "ØªØ´ØªØª": ["Ø¹Ø¯Ù… ØªØ±ÙƒÙŠØ²","Ø³Ù‡Ùˆ","Ø´Ø±ÙˆØ¯","Ù†Ø³ÙŠØ§Ù†","Ø¶Ø¹Ù ØªÙ†Ø¸ÙŠÙ…"],
    "ÙØ±Ø· Ø­Ø±ÙƒØ©": ["Ù†Ø´Ø§Ø· Ø²Ø§Ø¦Ø¯","Ø§Ù†Ø¯ÙØ§Ø¹","Ù…Ù‚Ø§Ø·Ø¹Ù‡","Ù…Ù„Ù„ Ø³Ø±ÙŠØ¹"],
}

def expand_text_with_synonyms(text: str) -> str:
    t = normalize(text)
    for base, syns in SYN.items():
        if any(normalize(w) in t for w in [base] + syns):
            t += " " + " ".join(normalize(s) for s in ([base]+syns))
    return t

# ============================== Ù‚Ø§Ø¹Ø¯Ø© DSM Ù…ÙˆØ³Ù‘Ø¹Ø© ==============================
# Ù„ÙƒÙ„ Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ø±Ø§Ø¶ Ù†Ù…ÙˆØ°Ø¬ÙŠØ©. (Ø¨Ø¯ÙˆÙ† ÙÙ‡Ø±Ø³ØŒ ÙÙ‚Ø· Ø£Ù…Ø±Ø§Ø¶ + Ø£Ø¹Ø±Ø§Ø¶)
DSM_DATA = {
    # -------- Ø§Ø¶Ø·Ø±Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¬ --------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§ÙƒØªØ¦Ø§Ø¨ÙŠ Ø¬Ø³ÙŠÙ…": [
        "Ø­Ø²Ù†", "Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø©", "Ø·Ø§Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©", "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù†ÙˆÙ…", "Ø´Ù‡ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©", "Ø´Ù‡ÙŠØ© Ø²Ø§Ø¦Ø¯Ø©",
        "Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", "ØªØ±ÙƒÙŠØ² Ø¶Ø¹ÙŠÙ", "Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„Ø°Ù†Ø¨", "ÙŠØ£Ø³", "Ø§ÙÙƒØ§Ø± Ø§Ù†ØªØ­Ø§Ø±ÙŠØ©"
    ],
    "Ø§ÙƒØªØ¦Ø§Ø¨ Ù…Ø³ØªÙ…Ø± (Ø¹Ø³Ø± Ø§Ù„Ù…Ø²Ø§Ø¬)": [
        "Ù…Ø²Ø§Ø¬ Ù…ÙƒØªØ¦Ø¨ Ù…Ø²Ù…Ù†", "Ø·Ø§Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©", "Ù†ÙˆÙ… Ø¶Ø¹ÙŠÙ", "Ø´Ù‡ÙŠØ© Ù‚Ù„ÙŠÙ„Ø©", "Ø«Ù‚Ù‡ Ù…Ù†Ø®ÙØ¶Ù‡", "Ø§Ù†ØªØ§Ø¬ÙŠØ© Ø¶Ø¹ÙŠÙÙ‡"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø¨ I/II": [
        "Ù†ÙˆØ¨Ø© Ù‡ÙˆØ³", "Ù‚Ù„ÙŠÙ„ Ù†ÙˆÙ…", "Ø§Ù†Ø¯ÙØ§Ø¹", "ØªÙ‡ÙˆØ±", "Ø§ÙÙƒØ§Ø± Ø³Ø¨Ø§Ù‚", "Ø·Ù„Ø§Ù‚Ø© Ø§Ù„ÙƒÙ„Ø§Ù…", "Ø¹Ø¸Ù…Ø©", "Ù†ÙˆØ¨Ø§Øª Ø§ÙƒØªØ¦Ø§Ø¨"
    ],

    # -------- Ø§Ø¶Ø·Ø±Ø§Ø¨Ø§Øª Ø§Ù„Ù‚Ù„Ù‚ ÙˆØ§Ù„Ø±Ù‡Ø§Ø¨ --------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù‚Ù„Ù‚ Ø§Ù„Ø¹Ø§Ù…": [
        "Ù‚Ù„Ù‚", "Ù‚Ù„Ù‚ Ù…ÙØ±Ø·", "ØªÙˆØªØ±", "Ø´Ø¯ Ø¹Ø¶Ù„ÙŠ", "ØµØ¹ÙˆØ¨Ø© ØªØ±ÙƒÙŠØ²", "Ø£Ø±Ù‚", "ØªØ¹Ø¨", "Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ø³ØªÙØ²Ø§Ø²"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù‡Ù„Ø¹": [
        "Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹", "Ø®ÙÙ‚Ø§Ù†", "Ø§Ø®ØªÙ†Ø§Ù‚", "Ø¶ÙŠÙ‚ Ù†ÙØ³", "Ø±Ø¬ÙÙ‡", "ØªØ¹Ø±Ù‚", "Ø¯ÙˆØ§Ø±", "Ø®ÙˆÙ Ø§Ù„Ù…ÙˆØª", "Ø®ÙˆÙ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø³ÙŠØ·Ø±Ø©"
    ],
    "Ø±Ù‡Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ": [
        "Ø®ÙˆÙ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", "Ø®Ø¬Ù„ Ø´Ø¯ÙŠØ¯", "Ù‚Ù„Ù‚ Ø§Ø¯Ø§Ø¡", "ØªØ¬Ù†Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", "Ø§Ø­Ù…Ø±Ø§Ø±", "Ø±Ø¬ÙÙ‡"
    ],
    "Ø±Ù‡Ø§Ø¨ Ø§Ù„Ø³Ø§Ø­Ø©": [
        "Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø§Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ÙØªÙˆØ­Ù‡", "Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…", "ØªØ¬Ù†Ø¨ Ù…ÙˆØ§ØµÙ„Ø§Øª", "ØµØ¹ÙˆØ¨Ù‡ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ­ÙŠØ¯Ø§"
    ],
    "Ø±Ù‡Ø§Ø¨ Ù…Ø­Ø¯Ø¯": [
        "Ø®ÙˆÙ Ø´Ø¯ÙŠØ¯", "ÙÙˆØ¨ÙŠØ§", "Ø®ÙˆÙ Ø·ÙŠØ±Ø§Ù†", "Ø®ÙˆÙ Ø§Ù„Ù…Ø±ØªÙØ¹Ø§Øª", "Ø®ÙˆÙ Ø§Ù„Ø¸Ù„Ø§Ù…", "Ø®ÙˆÙ Ø­Ø´Ø±Ø§Øª", "Ø®ÙˆÙ Ø­Ù‚Ù†", "Ø®ÙˆÙ Ø¯Ù…"
    ],

    # -------- ÙˆØ³ÙˆØ§Ø³/Ø£ÙØ¹Ø§Ù„ Ù‚Ù‡Ø±ÙŠØ© --------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„ÙˆØ³ÙˆØ§Ø³ Ø§Ù„Ù‚Ù‡Ø±ÙŠ": [
        "ÙˆØ³ÙˆØ§Ø³", "Ø³Ù„ÙˆÙƒ Ù‚Ù‡Ø±ÙŠ", "ØªÙÙ‚Ø¯ Ù…ØªÙƒØ±Ø±", "ØºØ³Ù„ Ù…ØªÙƒØ±Ø±", "ØªÙ†Ø¸ÙŠÙ… Ù…ÙØ±Ø·", "Ø¹Ø¯ Ù‚Ù‡Ø±ÙŠ", "Ø®ÙˆÙ ØªÙ„ÙˆØ«"
    ],
    "ØªØ´ÙˆÙ‡ ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø³Ø¯": [
        "Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø§Ù„Ù…Ø¸Ù‡Ø±", "Ø¹ÙŠÙˆØ¨ Ù…ØªØ®ÙŠÙ„Ù‡", "ØªÙÙ‚Ø¯ Ø§Ù„Ù…Ø±Ø¢Ù‡", "ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¸Ù‡Ø± Ù…ÙØ±Ø·"
    ],
    "Ø§ÙƒØªÙ†Ø§Ø²": [
        "Ø§ÙƒØªÙ†Ø§Ø²", "ØµØ¹ÙˆØ¨Ø© Ø±Ù…ÙŠ", "ØªÙƒØ¯ÙŠØ³", "ÙÙˆØ¶Ù‰ Ù…Ù†Ø²Ù„"
    ],

    # -------- ØµØ¯Ù…Ø© ÙˆØ¶ØºÙˆØ· --------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØµØ¯Ù…Ø©": [
        "Ø­Ø¯Ø« ØµØ§Ø¯Ù…", "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø¯Ø«", "ÙƒØ§Ø¨ÙˆØ³", "ØªØ¬Ù†Ø¨", "Ø®Ø¯Ø± Ø¹Ø§Ø·ÙÙŠ", "ÙŠÙ‚Ø¸Ù‡ Ù…ÙØ±Ø·Ù‡", "Ø°Ù†Ø¨ Ø§Ù„Ù†Ø§Ø¬ÙŠ"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙƒØ±Ø¨ Ø­Ø§Ø¯": [
        "Ø§Ø¹Ø±Ø§Ø¶ ØµØ¯Ù…Ø© Ù‚ØµÙŠØ±Ø©", "ÙŠÙ‚Ø¸Ù‡ Ù…ÙØ±Ø·Ù‡", "ØªØ¬Ù†Ø¨", "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø¶ØºØ· Ø­Ø§Ø¯"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªÙƒÙŠÙ": [
        "ØªÙˆØªØ± Ù…ÙˆÙ‚Ù", "Ø­Ø²Ù† Ø¨Ø¹Ø¯ Ø­Ø¯Ø«", "Ù‚Ù„Ù‚ Ø¸Ø±ÙÙŠ", "ØªØ±Ø§Ø¬Ø¹ Ø§Ø¯Ø§Ø¡ Ø¨Ø¹Ø¯ Ø¶ØºØ·"
    ],

    # -------- Ø·ÙŠÙ Ø°Ù‡Ø§Ù†ÙŠ --------
    "ÙØµØ§Ù…": [
        "Ù‡Ù„ÙˆØ³Ø©", "Ø§ÙˆÙ‡Ø§Ù…", "ØªÙÙƒÙŠØ± ØºÙŠØ± Ù…Ù†Ø¸Ù…", "Ø§Ù†Ø³Ø­Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", "ØªØ³Ø·Ø­ ÙˆØ¬Ø¯Ø§Ù†ÙŠ", "Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ø±Ø§Ø¯Ù‡"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙØµØ§Ù…ÙŠ Ø¹Ø§Ø·ÙÙŠ": [
        "Ø§Ø¹Ø±Ø§Ø¶ Ø°Ù‡Ø§Ù†ÙŠÙ‡", "Ø§ÙƒØªØ¦Ø§Ø¨ Ø´Ø¯ÙŠØ¯", "Ù†ÙˆØ¨Ø© Ù‡ÙˆØ³", "ØªØ°Ø¨Ø°Ø¨ Ù…Ø²Ø§Ø¬"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙˆÙ‡Ø§Ù…ÙŠ": [
        "Ø¶Ù„Ø§Ù„Ø§Øª Ø«Ø§Ø¨ØªØ©", "ØºÙŠØ±Ø© ÙˆÙ‡Ø§Ù…ÙŠØ©", "Ø§Ø¶Ø·Ù‡Ø§Ø¯", "Ø¹Ø¸Ù…Ø©", "Ø´Ùƒ Ù…Ø±Ø¶ÙŠ"
    ],

    # -------- Ù†Ù…Ø§Ø¦ÙŠØ©/Ø¹ØµØ¨ÙŠØ© --------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù†Ù‚Øµ Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ ÙˆÙØ±Ø· Ø§Ù„Ø­Ø±ÙƒØ©": [
        "ØªØ´ØªØª", "Ø¹Ø¯Ù… ØªØ±ÙƒÙŠØ²", "ÙØ±Ø· Ø­Ø±ÙƒØ©", "Ø§Ù†Ø¯ÙØ§Ø¹", "Ù†Ø³ÙŠØ§Ù†", "ØªÙ†Ø¸ÙŠÙ… Ø¶Ø¹ÙŠÙ", "Ù…Ù‚Ø§Ø·Ø¹Ù‡", "Ù…Ù„Ù„ Ø³Ø±ÙŠØ¹"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø·ÙŠÙ Ø§Ù„ØªÙˆØ­Ø¯": [
        "ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø¶Ø¹ÙŠÙ", "Ø³Ù„ÙˆÙƒ Ù†Ù…Ø·ÙŠ", "Ø±ÙˆØªÙŠÙ†", "Ø­Ø³Ø§Ø³ÙŠØ§Øª Ø­Ø³ÙŠÙ‡", "Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ù…Ù‚ÙŠØ¯Ù‡", "Ù„ØºØ© Ù…ØªØ£Ø®Ø±Ù‡", "Ø­Ø±ÙƒØ§Øª Ù†Ù…Ø·ÙŠÙ‡"
    ],
    "Ù…ØªÙ„Ø§Ø²Ù…Ø© ØªÙˆØ±ÙŠØª/Ø¹Ø±Ø§Øª": [
        "Ø¹Ø±Ø§Øª", "Ø­Ø±ÙƒØ§Øª Ù„Ø§ Ø¥Ø±Ø§Ø¯ÙŠØ©", "Ø£ØµÙˆØ§Øª Ù„Ø§ Ø¥Ø±Ø§Ø¯ÙŠØ©", "ØªÙØ±ÙŠØº ØªÙˆØªØ±"
    ],

    # -------- Ù†ÙˆÙ…/ÙŠÙ‚Ø¸Ø© --------
    "Ø£Ø±Ù‚ Ù…Ø²Ù…Ù†": [
        "ØµØ¹ÙˆØ¨Ù‡ Ù†ÙˆÙ…", "Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ Ù…Ø¨ÙƒØ±", "Ù†ÙˆÙ… Ù…ØªÙ‚Ø·Ø¹", "Ø¹Ø¯Ù… Ø±Ø§Ø­Ù‡", "Ø§Ø¬Ù‡Ø§Ø¯ Ù†Ù‡Ø§Ø±ÙŠ"
    ],
    "ÙØ±Ø· Ù†Ø¹Ø§Ø³/Ù†Ø§Ø±ÙƒÙˆÙ„ÙŠØ¨Ø³ÙŠ": [
        "Ù†Ø¹Ø§Ø³ Ù†Ù‡Ø§Ø±ÙŠ", "ØºÙÙˆØ§Øª Ù…ÙØ§Ø¬Ø¦Ø©", "Ø´Ù„Ù„ Ù†ÙˆÙ…", "Ù‡Ù„ÙˆØ³Ø§Øª Ù†Ø¹Ø§Ø³"
    ],
    "Ø§Ù†Ù‚Ø·Ø§Ø¹ Ù†ÙØ³ Ø§Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…": [
        "Ø´Ø®ÙŠØ±", "ØªÙˆÙ‚Ù ØªÙ†ÙØ³", "Ø§Ø®ØªÙ†Ø§Ù‚ Ù„ÙŠÙ„ÙŠ", "Ù†Ø¹Ø§Ø³ Ù†Ù‡Ø§Ø±ÙŠ"
    ],

    # -------- Ø£ÙƒÙ„ --------
    "Ù‚Ù‡Ù… Ø¹ØµØ¨ÙŠ": [
        "Ù†Ù‚Øµ ÙˆØ²Ù† Ø´Ø¯ÙŠØ¯", "Ø®ÙˆÙ Ù…Ù† Ø²ÙŠØ§Ø¯Ù‡ Ø§Ù„ÙˆØ²Ù†", "ØµÙˆØ±Ø© Ø¬Ø³Ø¯ Ø³Ù„Ø¨ÙŠÙ‡", "ØªÙ‚ÙŠÙŠØ¯ Ø·Ø¹Ø§Ù…"
    ],
    "Ù†Ù‡Ø§Ù… Ø¹ØµØ¨ÙŠ": [
        "Ù†Ù‡Ù… Ù…ØªÙƒØ±Ø±", "ØªØ·Ù‡ÙŠØ±", "Ø§Ø³ØªÙØ±Ø§Øº", "Ù…Ù„ÙŠÙ†Ø§Øª", "Ø°Ù†Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ÙƒÙ„"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù†Ù‡Ù… Ø§Ù„Ø·Ø¹Ø§Ù…": [
        "Ù†Ù‡Ù…", "Ø§ÙƒÙ„ Ø¨Ø´Ø±Ø§Ù‡Ù‡", "ÙÙ‚Ø¯Ø§Ù† ØªØ­ÙƒÙ…", "Ø§ÙƒÙ„ Ø³Ø±Ø§", "Ø²ÙŠØ§Ø¯Ø© ÙˆØ²Ù†"
    ],

    # -------- Ø£Ø¹Ø±Ø§Ø¶ Ø¬Ø³Ø¯ÙŠØ© --------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ø§Ø¹Ø±Ø§Ø¶ Ø§Ù„Ø¬Ø³Ø¯ÙŠØ©": [
        "Ø§Ù„Ù… ØºÙŠØ± Ù…ÙØ³Ø±", "Ø§Ø¹Ø±Ø§Ø¶ Ø¬Ø³Ø¯ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø©", "Ø§Ù†Ø´ØºØ§Ù„ ØµØ­ÙŠ", "Ø²ÙŠØ§Ø±Ù‡ Ø§Ø·Ø¨Ø§Ø¡ ÙƒØ«ÙŠØ±Ù‡"
    ],
    "Ù‚Ù„Ù‚ Ø§Ù„Ù…Ø±Ø¶": [
        "Ù‚Ù„Ù‚ ØµØ­ÙŠ", "Ø®ÙˆÙ Ù…Ø±Ø¶ Ø®Ø·ÙŠØ±", "ØªÙÙ‚Ø¯ Ø¬Ø³Ø¯", "Ø·Ù…Ø£Ù†Ù‡ Ù…ØªÙƒØ±Ø±Ù‡", "Ø¨Ø­Ø« Ø·Ø¨ÙŠ Ù…Ø³ØªÙ…Ø±"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ­ÙˆÙ„ÙŠ": [
        "Ø§Ø¹Ø±Ø§Ø¶ Ø¹ØµØ¨ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ Ø¹Ø¶ÙˆÙŠ", "Ø´Ù„Ù„ ÙˆØ¸ÙŠÙÙŠ", "Ù†ÙˆØ¨Ø§Øª ØºÙŠØ± ØµØ±Ø¹ÙŠØ©", "ÙÙ‚Ø¯Ø§Ù† Ø§Ø­Ø³Ø§Ø³"
    ],

    # -------- Ø´Ø®ØµÙŠØ© --------
    "Ø´Ø®ØµÙŠØ© Ø­Ø¯ÙŠØ©": [
        "ØªÙ‚Ù„Ø¨ Ø¹Ø§Ø·ÙÙŠ", "Ø§Ù†Ø¯ÙØ§Ø¹", "Ø®ÙˆÙ Ù‡Ø¬Ø±", "Ø§ÙŠØ°Ø§Ø¡ Ø°Ø§ØªÙŠ", "ÙØ±Ø§Øº Ù…Ø²Ù…Ù†", "Ø¹Ù„Ø§Ù‚Ø§Øª ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±Ø©"
    ],
    "Ø´Ø®ØµÙŠØ© Ù†Ø±Ø¬Ø³ÙŠØ©": [
        "Ø¹Ø¸Ù…Ø©", "Ø­Ø§Ø¬Ø© Ø§Ø¹Ø¬Ø§Ø¨", "ØªØ¹Ø§Ø·Ù Ù‚Ù„ÙŠÙ„", "Ø­Ø³Ø§Ø³ Ù„Ù„Ù†Ù‚Ø¯"
    ],
    "Ø´Ø®ØµÙŠØ© ÙˆØ³ÙˆØ§Ø³ÙŠØ© Ù‚Ù‡Ø±ÙŠØ©": [
        "Ø§Ù†Ø´ØºØ§Ù„ Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„", "ÙƒÙ…Ø§Ù„ÙŠÙ‡", "ØµØ±Ø§Ù…Ù‡", "Ù‚ÙˆØ§Ø¹Ø¯", "Ø¹Ù†Ø§Ø¯"
    ],

    # -------- Ù…ÙˆØ§Ø¯/Ø¥Ø¯Ù…Ø§Ù† --------
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„ÙƒØ­ÙˆÙ„": [
        "ÙƒØ­ÙˆÙ„", "Ø³ÙƒØ± Ù…ØªÙƒØ±Ø±", "ØªØ­Ù…Ù„", "Ø§Ø¹Ø±Ø§Ø¶ Ø§Ù†Ø³Ø­Ø§Ø¨", "ÙÙ‚Ø¯Ø§Ù† Ø³ÙŠØ·Ø±Ø©"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ù‚Ù†Ø¨": [
        "Ø­Ø´ÙŠØ´", "Ù‚Ù†Ø¨", "Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙŠÙˆÙ…ÙŠ", "ØªØ³Ø§Ù…Ø­", "Ø§Ù†Ø³Ø­Ø§Ø¨"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ù…Ù†Ø¨Ù‡Ø§Øª": [
        "Ù…Ù†Ø´Ø·Ø§Øª", "Ø§Ù…ÙÙŠØªØ§Ù…ÙŠÙ†", "ÙƒÙˆÙƒØ§ÙŠÙŠÙ†", "Ø³Ù‡Ø±", "ÙÙ‚Ø¯Ø§Ù† Ø´Ù‡ÙŠÙ‡", "Ø¨Ø§Ø±Ø§Ù†ÙˆÙŠØ§"
    ],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ ØªØ¹Ø§Ø·ÙŠ Ø§Ù„Ø£ÙÙŠÙˆÙ†Ø§Øª": [
        "Ù‡ÙŠØ±ÙˆÙŠÙ†", "Ù…ÙˆØ±ÙÙŠÙ†", "Ø§ÙˆÙƒØ³ÙŠØ¯ÙˆØ¯ÙˆÙ†", "Ø§Ù†Ø³Ø­Ø§Ø¨", "ØªØ­Ù…Ù„", "Ø±ØºØ¨Ù‡ Ù…Ù„Ø­Ù‡"
    ],
}

# Ø£Ø¹Ø±Ø§Ø¶ Ù„Ø§Ø²Ù…Ø© Ù„Ø¨Ø¹Ø¶ Ø§Ù„ØªØ´Ø®ÙŠØµØ§Øª Ù„Ø±ÙØ¹ Ø¯Ù‚Ù‘Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
REQUIRED = {
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§ÙƒØªØ¦Ø§Ø¨ÙŠ Ø¬Ø³ÙŠÙ…": ["Ø­Ø²Ù†", "Ø§Ù†Ø¹Ø¯Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø©"],
    "ÙØµØ§Ù…": ["Ù‡Ù„ÙˆØ³Ø©", "Ø§ÙˆÙ‡Ø§Ù…"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„Ù‡Ù„Ø¹": ["Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ù„ÙˆØ³ÙˆØ§Ø³ Ø§Ù„Ù‚Ù‡Ø±ÙŠ": ["ÙˆØ³ÙˆØ§Ø³", "Ø³Ù„ÙˆÙƒ Ù‚Ù‡Ø±ÙŠ"],
    "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØµØ¯Ù…Ø©": ["Ø­Ø¯Ø« ØµØ§Ø¯Ù…", "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø¯Ø«"],
    "Ù‚Ù‡Ù… Ø¹ØµØ¨ÙŠ": ["Ù†Ù‚Øµ ÙˆØ²Ù† Ø´Ø¯ÙŠØ¯", "Ø®ÙˆÙ Ù…Ù† Ø²ÙŠØ§Ø¯Ù‡ Ø§Ù„ÙˆØ²Ù†"],
    "Ù†Ù‡Ø§Ù… Ø¹ØµØ¨ÙŠ": ["Ù†Ù‡Ù… Ù…ØªÙƒØ±Ø±", "ØªØ·Ù‡ÙŠØ±"],
}

# ØªØ¹Ø²ÙŠØ²Ø§Øª: Ø±Ø§ÙŠØ§Øª Ø­Ø±Ø¬Ø© + Ù…Ø¯Ø©
CRITICAL_SYM = {"Ù‡Ù„ÙˆØ³Ø©","Ø§ÙˆÙ‡Ø§Ù…","Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹","Ø§ÙÙƒØ§Ø± Ø§Ù†ØªØ­Ø§Ø±ÙŠØ©"}
DURATION_BOOSTS = [(365*2,1.25),(180,1.18),(90,1.1),(30,1.05)]

def score_diagnoses(symptoms_text: str, duration_days: int) -> list[dict]:
    """ÙŠØ­Ø³Ø¨ Ø¯Ø±Ø¬Ø§Øª Ù„ÙƒÙ„ Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙˆÙŠØ±Ø¬Ø¹ Ø£ÙØ¶Ù„ 3"""
    text = expand_text_with_synonyms(symptoms_text or "")
    dur_boost = 1.0
    for d, b in DURATION_BOOSTS:
        if duration_days >= d:
            dur_boost = b; break

    out = []
    for dx, kws in DSM_DATA.items():
        # ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø§Øª (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
        req = REQUIRED.get(dx, [])
        if req and not all(soft_contains(text, r) for r in req):
            continue

        sc = 0.0; hits=[]
        # Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø§Øª Ø£Ø«Ù‚Ù„
        for r in req:
            if soft_contains(text, r):
                sc += 1.2; hits.append(r)
        # Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙ„Ù…Ø§Øª
        for k in kws:
            if soft_contains(text, k):
                sc += 0.7; hits.append(k)

        # Ø±Ø§ÙŠØ§Øª Ø­Ø±Ø¬Ø©
        if any(soft_contains(text, c) for c in CRITICAL_SYM):
            sc *= 1.15

        if sc>0:
            sc *= dur_boost
            out.append({"name": dx, "score": round(sc,2), "hits": list(dict.fromkeys(hits))[:12]})

    out.sort(key=lambda x: x["score"], reverse=True)
    return out[:3]

def pick_top(cands: list[dict], min_score: float = 2.2):
    if not cands: return None
    return cands[0] if cands[0]["score"] >= min_score else None

# ============================== ÙˆØ§Ø¬Ù‡Ø© HTML ==============================
PAGE = """
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>DSM | Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© ÙˆØªØ´Ø®ÙŠØµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#0b3a75;--bg2:#0a65b0;--gold:#f4b400}
    *{box-sizing:border-box}
    body{font-family:"Tajawal",system-ui;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;margin:0}
    .wrap{max-width:1180px;margin:26px auto;padding:16px}
    .card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px}
    label{display:block;color:#ffe28a;margin:6px 2px}
    input,select,textarea{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);color:#fff;padding:11px}
    textarea{min-height:120px;resize:vertical}
    .btn{background:var(--gold);color:#2b1b02;border:none;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-block}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px}
    .ok{background:#16a34a}.warn{background:#ef4444}.mid{background:#f59e0b}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid rgba(255,255,255,.15);padding:8px;text-align:right}
    th{color:#ffe28a}
    ul{margin:0 0 0 1rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px">
      <h2 style="margin:0">ğŸ—‚ï¸ Ø¯Ø±Ø§Ø³Ø© Ø­Ø§Ù„Ø© + ØªØ´Ø®ÙŠØµ (DSM)</h2>
      <a class="btn" href="/">Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</a>
    </div>
    <div class="grid">
      <section class="card">
        <form method="post">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div><label>Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input name="name" value="{{name}}"></div>
            <div><label>Ø§Ù„Ø¹Ù…Ø±</label><input name="age" value="{{age}}" placeholder="Ù…Ø«Ø§Ù„ 30"></div>
            <div><label>Ø§Ù„Ø¬Ù†Ø³</label>
              <select name="gender">
                <option value="" {{'selected' if not gender else ''}}>â€” Ø§Ø®ØªØ± â€”</option>
                <option {{'selected' if gender=='Ø°ÙƒØ±' else ''}}>Ø°ÙƒØ±</option>
                <option {{'selected' if gender=='Ø£Ù†Ø«Ù‰' else ''}}>Ø£Ù†Ø«Ù‰</option>
              </select>
            </div>
            <div><label>Ù…Ø¯Ø© Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ (Ø£ÙŠØ§Ù…)</label><input name="duration" value="{{duration}}" placeholder="90"></div>
          </div>

          <label>Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ (Ø­Ø±Ù‘/Ø¹Ø§Ù…ÙŠ)</label>
          <textarea name="symptoms" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø¨Ø­Ø±Ù‘ÙŠØ©: Ø­Ø²Ù†ØŒ Ù…Ø§ Ø§Ø³ØªÙ…ØªØ¹ØŒ Ù‚Ù„Ø© Ù†ÙˆÙ…ØŒ ÙˆØ³ÙˆØ§Ø³ + Ø·Ù‚ÙˆØ³ØŒ Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹...">{{symptoms}}</textarea>

          <label>Ø£Ùˆ Ø§Ø®ØªØ± ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select name="picked">
            <option value="">â€” Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªÙŠØ§Ø± â€”</option>
            {% for k in options %}
              <option value="{{k}}" {{'selected' if picked==k else ''}}>{{k}}</option>
            {% endfor %}
          </select>

          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" type="submit">Ø¥ØµØ¯Ø§Ø± ØªØ´Ø®ÙŠØµ</button>
          </div>
        </form>
      </section>

      <aside class="card">
        {% if picked %}
          <div><span class="badge ok">Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ</span></div>
          <h3 style="margin:.4rem 0 0">{{picked}}</h3>
          <p>Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</p>
          <ul>
            {% for s in DSM_DATA[picked] %}
              <li>{{s}}</li>
            {% endfor %}
          </ul>
          <p style="opacity:.8;margin-top:8px">âš ï¸ ÙŠÙ„Ø²Ù… ØªÙ‚ÙŠÙŠÙ… Ø³Ø±ÙŠØ±ÙŠ Ù„Ù„ØªØ£ÙƒÙŠØ¯.</p>
        {% elif best %}
          <div><span class="badge ok">Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø±Ø¬Ù‘Ø­</span></div>
          <h3 style="margin:.4rem 0 0">{{best.name}}</h3>
          <div style="opacity:.85">Ø§Ù„Ø¯Ø±Ø¬Ø©: {{best.score}}</div>
          <table>
            <thead><tr><th>Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</th></tr></thead>
            <tbody>
              {% for h in best.hits %}
                <tr><td>{{h}}</td></tr>
              {% endfor %}
            </tbody>
          </table>

          {% if top3 and top3|length>1 %}
          <div style="margin-top:10px">
            <span class="badge mid">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø±ÙŠØ¹Ø© (Ø£Ù‚Ø±Ø¨ 3)</span>
            <ul>
              {% for c in top3 %}
                {% if c.name != best.name %}
                  <li><b>{{c.name}}</b> â€” {{c.score}}</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          <p style="opacity:.8;margin-top:8px">âš ï¸ Ù†ØªÙŠØ¬Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙ„Ø§ ØªÙØºÙ†ÙŠ Ø¹Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ.</p>
        {% else %}
          <div><span class="badge warn">Ù„Ø§ ØªØ´Ø®ÙŠØµ Ù…Ø¤ÙƒØ¯ Ø¨Ø¹Ø¯</span></div>
          <p>Ø§ÙƒØªØ¨ Ù…ÙØ±Ø¯Ø§Øª Ø£Ø¯Ù‚ (Ù…Ø«Ø§Ù„: <b>Ù‡Ù„ÙˆØ³Ø©/Ø£ÙˆÙ‡Ø§Ù…/Ù†ÙˆØ¨Ø© Ù‡Ù„Ø¹/ÙˆØ³ÙˆØ§Ø³+Ø·Ù‚ÙˆØ³/Ù†Ù‡Ù…+ØªØ·Ù‡ÙŠØ±/Ø§Ù†Ù‚Ø·Ø§Ø¹ Ù†ÙØ³</b>) ÙˆØ§Ø°ÙƒØ± Ø§Ù„Ù…Ø¯Ø©.</p>
        {% endif %}
      </aside>
    </div>
  </div>
</body>
</html>
"""

# ============================== Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==============================
@dsm_bp.route("/", methods=["GET","POST"])
def dsm_home():
    form = request.form if request.method=="POST" else {}
    name     = (form.get("name") or "").strip()
    age      = (form.get("age") or "").strip()
    gender   = (form.get("gender") or "").strip()
    duration = (form.get("duration") or "").strip()
    symptoms = (form.get("symptoms") or "").strip()
    picked   = (form.get("picked") or "").strip()

    best = None
    top3 = []
    if not picked and request.method=="POST":
        try:
            d = int(float(duration)) if duration else 0
        except:
            d = 0
        cands = score_diagnoses(symptoms, d)
        if cands:
            top3 = [type("C",(object,),c)() for c in cands]
            b = cands[0]
            if pick_top(cands):
                best = type("B",(object,),b)()

    return render_template_string(
        PAGE,
        name=name, age=age, gender=gender, duration=duration, symptoms=symptoms, picked=picked,
        best=best, top3=top3, options=sorted(DSM_DATA.keys()), DSM_DATA=DSM_DATA
    )
