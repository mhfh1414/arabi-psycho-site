# -*- coding: utf-8 -*-
"""
اختبارات نفسية شائعة + تصحيحها
- كل اختبار داخل PSYCH_TESTS يحوي:
  key, name, about, items[{id,text,scale}], scoring: cutoffs أو دالة مخصّصة
- دالة score_test(test_key, answers) تعيد قاموس نتيجة موحّد
- دالة get_scale_options(scale_key) تعيد خيارات ليكرت للعرض
"""

from __future__ import annotations
from typing import Dict, List, Any

# ---------------------------
# خيارات المقاييس (للعرض في HTML)
# ---------------------------
SCALES: Dict[str, List[Dict[str, Any]]] = {
    "0-3_freq": [
        {"value": 0, "label": "أبداً"},
        {"value": 1, "label": "عدة أيام"},
        {"value": 2, "label": "أكثر من نصف الأيام"},
        {"value": 3, "label": "تقريبًا كل يوم"},
    ],
    "0-3_sev": [
        {"value": 0, "label": "لا شيء"},
        {"value": 1, "label": "خفيف"},
        {"value": 2, "label": "متوسط"},
        {"value": 3, "label": "شديد"},
    ],
    "0-4_freq": [
        {"value": 0, "label": "أبداً"},
        {"value": 1, "label": "نادرًا"},
        {"value": 2, "label": "أحيانًا"},
        {"value": 3, "label": "غالبًا"},
        {"value": 4, "label": "دائمًا"},
    ],
    "audit_0_4": [
        {"value": 0, "label": "0"},
        {"value": 1, "label": "1"},
        {"value": 2, "label": "2"},
        {"value": 3, "label": "3"},
        {"value": 4, "label": "4"},
    ],
}

def get_scale_options(key: str) -> List[Dict[str, Any]]:
    return SCALES.get(key, SCALES["0-3_freq"])

# ---------------------------
# أدوات مساعدة
# ---------------------------
def _sum(answers: Dict[int, int]) -> int:
    return int(sum(answers.values())) if answers else 0

def _band(total: int, bands: List[Dict[str, Any]]) -> Dict[str, Any]:
    """ارجاع مستوى الشدة وفق حدود درجات."""
    last = {"level": "غير محدد"}
    for b in bands:
        if total >= b["min"] and total <= b.get("max", 10**9):
            return b
        last = b
    return last

# ---------------------------
# تعريف الاختبارات
# ---------------------------

PSYCH_TESTS: Dict[str, Dict[str, Any]] = {}

# ============== PHQ-9 ==============
phq_items = [
    "قلة الاهتمام أو المتعة بالقيام بالأشياء",
    "الشعور بالاكتئاب أو اليأس",
    "صعوبة في النوم أو فرط النوم",
    "الإرهاق أو قلة الطاقة",
    "ضعف الشهية أو الإفراط في الأكل",
    "الشعور بسوء تجاه نفسك أو أنك فاشل",
    "صعوبة في التركيز",
    "تباطؤ أو تهيج حركي/كلامي ملحوظ",
    "أفكار بأنك قد تكون أفضل حالاً ميتًا أو بإيذاء نفسك",
]
PSYCH_TESTS["phq9"] = {
    "key": "phq9",
    "name": "PHQ-9 (الاكتئاب)",
    "about": "مقياس الأعراض الاكتئابية خلال آخر أسبوعين.",
    "items": [{"id": i+1, "text": t, "scale": "0-3_freq"} for i, t in enumerate(phq_items)],
    "cutoffs": [
        {"min": 0, "max": 4, "level": "لا/خفيف جدًا"},
        {"min": 5, "max": 9, "level": "خفيف"},
        {"min": 10, "max": 14, "level": "متوسط"},
        {"min": 15, "max": 19, "level": "متوسط-شديد"},
        {"min": 20, "max": 27, "level": "شديد"},
    ],
}

# ============== GAD-7 ==============
gad_items = [
    "الشعور بالتوتر أو القلق أو العصبية",
    "عدم القدرة على إيقاف القلق أو التحكم به",
    "القلق المفرط حيال أمور مختلفة",
    "صعوبة في الاسترخاء",
    "التململ بحيث يصعب الجلوس بهدوء",
    "الانزعاج/التهيج بسهولة",
    "الشعور بالخوف كأن شيئًا سيئًا قد يحدث",
]
PSYCH_TESTS["gad7"] = {
    "key": "gad7",
    "name": "GAD-7 (القلق العام)",
    "about": "مقياس القلق العام خلال الأسبوعين الماضيين.",
    "items": [{"id": i+1, "text": t, "scale": "0-3_freq"} for i, t in enumerate(gad_items)],
    "cutoffs": [
        {"min": 0, "max": 4, "level": "طبيعي"},
        {"min": 5, "max": 9, "level": "قلق خفيف"},
        {"min": 10, "max": 14, "level": "قلق متوسط"},
        {"min": 15, "max": 21, "level": "قلق شديد"},
    ],
}

# ============== ISI (الأرق المختصر 7 بنود) ==============
isi_items = [
    "صعوبة في بدء النوم",
    "صعوبة في استمرار النوم",
    "الاستيقاظ مبكرًا",
    "الرضا/عدم الرضا عن نمط النوم الحالي",
    "تأثير صعوبات النوم على الأداء النهاري",
    "مدى ظهور المشكلة للآخرين",
    "القلق/الانزعاج من مشكلات النوم",
]
PSYCH_TESTS["insomnia"] = {
    "key": "insomnia",
    "name": "ISI (مؤشر شدة الأرق)",
    "about": "مؤشر شدة الأرق خلال آخر أسبوعين.",
    "items": [{"id": i+1, "text": t, "scale": "0-3_sev"} for i, t in enumerate(isi_items)],
    "cutoffs": [
        {"min": 0, "max": 7, "level": "لا أرق"},
        {"min": 8, "max": 14, "level": "أرق تحت العتبة"},
        {"min": 15, "max": 21, "level": "أرق متوسط"},
        {"min": 22, "max": 28, "level": "أرق شديد"},
    ],
}

# ============== PCL-5 ==============
# 20 بند بنطاق 0-4 (أبداً → دائمًا)
pcl5_items = [
    "ذكريات مزعجة متكررة للحدث الصادمي",
    "كوابيس مزعجة تتعلق بالحدث",
    "ومضات/استرجاع للحدث وكأنه يحدث الآن",
    "ضيق نفسي شديد عند التعرّض لمذكّرات",
    "تفاعلات جسدية قوية عند التعرّض لمذكّرات",
    "تجنب أفكار/مشاعر تتعلق بالحدث",
    "تجنب مواقف/أماكن تذكرك بالحدث",
    "صعوبة تذكّر جوانب مهمة من الحدث",
    "معتقدات سلبية مستمرة عن الذات/العالم",
    "تشويه لوم الذات أو الآخرين",
    "مشاعر سلبية مستمرة (خوف/غضب/ذنب/خجل)",
    "فقدان الاهتمام بالأنشطة",
    "الشعور بالانفصال عن الآخرين",
    "صعوبة الشعور بالمشاعر الإيجابية",
    "تهيج/نوبات غضب",
    "سلوك متهور/مدمّر",
    "فرط يقظة/انتباه",
    "ارتباك أو فزع مفرط",
    "صعوبة التركيز",
    "اضطراب النوم",
]
PSYCH_TESTS["pcl5"] = {
    "key": "pcl5",
    "name": "PCL-5 (أعراض ما بعد الصدمة)",
    "about": "قياس شدة أعراض اضطراب ما بعد الصدمة خلال الشهر الماضي.",
    "items": [{"id": i+1, "text": t, "scale": "0-4_freq"} for i, t in enumerate(pcl5_items)],
    "cutoffs": [
        {"min": 0, "max": 19, "level": "منخفض"},
        {"min": 20, "max": 33, "level": "متوسط"},
        {"min": 34, "max": 80, "level": "مرتفع (يستحق تقييماً سريريًا)"},
    ],
}

# ============== SPIN (قلق اجتماعي 17 بند) ==============
spin_items = [
    "الخوف من مقابلة أشخاص جدد", "الخوف من التحدث أمام مجموعة",
    "تجنّب المواقف الاجتماعية", "الشعور بالحرج/الخجل الشديد",
    "القلق من أن يلاحظ الآخرون الارتباك", "الخوف من الانتقاد",
    "الخوف من الاتصال البصري", "قلق سابق للموقف الاجتماعي",
    "تسارع قلب/رجفة في المواقف الاجتماعية", "خشية أن أبدو غبيًا",
    "تجنب المناسبات/الدعوات", "صعوبة بدء محادثة", "الخوف من الأكل أمام الناس",
    "الخوف من الاتصال بالغرباء هاتفياً", "تأثير الأعراض على حياتي",
    "تجنب العمل/الدراسة بسبب القلق", "انزعاج عام من التفاعل الاجتماعي",
]
PSYCH_TESTS["spinh"] = {
    "key": "spinh",
    "name": "SPIN (قلق اجتماعي مختصر)",
    "about": "نسخة مختصرة غير سريرية (0-4).",
    "items": [{"id": i+1, "text": t, "scale": "0-4_freq"} for i, t in enumerate(spin_items)],
    "cutoffs": [
        {"min": 0, "max": 18, "level": "منخفض"},
        {"min": 19, "max": 35, "level": "متوسط"},
        {"min": 36, "max": 68, "level": "مرتفع"},
    ],
}

# ============== Y-BOCS (وسواس قهري 10 بنود) ==============
ybocs_items = [
    "الوقت المستغرق في الوساوس", "الضيق الناتج عن الوساوس",
    "التحكم/مقاومة الوساوس", "درجة السيطرة على الوساوس", "تداخل الوساوس مع الحياة",
    "الوقت المستغرق في الأفعال القهرية", "الضيق الناتج عن الأفعال القهرية",
    "التحكم/مقاومة الأفعال", "درجة السيطرة على الأفعال", "تداخل الأفعال مع الحياة",
]
PSYCH_TESTS["y_bocs"] = {
    "key": "y_bocs",
    "name": "Y-BOCS (شدة الوسواس القهري)",
    "about": "مؤشر ذاتي مبسّط (0-4 لكل بند).",
    "items": [{"id": i+1, "text": t, "scale": "0-4_freq"} for i, t in enumerate(ybocs_items)],
    "cutoffs": [
        {"min": 0, "max": 7, "level": "خفيف جدًا"},
        {"min": 8, "max": 15, "level": "خفيف"},
        {"min": 16, "max": 23, "level": "متوسط"},
        {"min": 24, "max": 31, "level": "شديد"},
        {"min": 32, "max": 40, "level": "شديد جدًا"},
    ],
}

# ============== PSQI (جودة النوم – تبسيط 7 بنود 0-3) ==============
psqi_items = [
    "جودة النوم الذاتية", "زمن الاستغراق في النوم", "مدة النوم",
    "كفاءة النوم", "اضطرابات النوم", "استخدام أدوية منوّمة", "الوظيفة النهارية",
]
PSYCH_TESTS["psqi"] = {
    "key": "psqi",
    "name": "PSQI (جودة النوم – مبسّط)",
    "about": "نسخة مبسّطة للعرض السريع؛ الدرجات الأعلى تعني جودة أسوأ.",
    "items": [{"id": i+1, "text": t, "scale": "0-3_sev"} for i, t in enumerate(psqi_items)],
    "cutoffs": [
        {"min": 0, "max": 4, "level": "جيدة"},
        {"min": 5, "max": 9, "level": "متوسطة"},
        {"min": 10, "max": 21, "level": "ضعيفة"},
    ],
}

# ============== AUDIT (الكحول 10 بنود 0-4) ==============
audit_items = [
    "كم مرة تتناول مشروبًا كحوليًا؟", "كم عدد المشروبات في اليوم المعتاد؟",
    "كم مرّة تتناول ستة مشروبات أو أكثر في مناسبة واحدة؟",
    "عجز عن التوقف بعد البدء", "فشل في أداء ما هو متوقع بسبب الشرب",
    "احتياج صباحي لمشروب (فاتح للشهية)", "شعور بالذنب أو الندم بعد الشرب",
    "فقدان ذاكرة بسبب الشرب", "إصابة/أذى بسبب الشرب", "قلق من الآخرين حول شربك",
]
PSYCH_TESTS["audit"] = {
    "key": "audit",
    "name": "AUDIT (الكحول)",
    "about": "فحص مشكلات تناول الكحول (0-4).",
    "items": [{"id": i+1, "text": t, "scale": "audit_0_4"} for i, t in enumerate(audit_items)],
    "cutoffs": [
        {"min": 0, "max": 7, "level": "خطر منخفض"},
        {"min": 8, "max": 15, "level": "استخدام مخاطِر"},
        {"min": 16, "max": 19, "level": "استخدام ضار"},
        {"min": 20, "max": 40, "level": "احتمال اضطراب اعتماد"},
    ],
}

# ============== ASSIST (تبسيط 8 بنود عامة 0-4) ==============
assist_items = [
    "استخدام مواد غير مشروعة خلال 3 أشهر", "رغبة قوية/اشتهاء",
    "مشاكل صحية أو نفسية بسبب الاستخدام", "تقصير في الأدوار بسبب الاستخدام",
    "قلق من الأسرة/الأصدقاء", "محاولات فاشلة للتقليل/الإقلاع",
    "استهلاك صباحي لبدء اليوم", "مشاكل قانونية مرتبطة بالاستخدام",
]
PSYCH_TESTS["assist"] = {
    "key": "assist",
    "name": "ASSIST (تعاطي مواد – مبسّط)",
    "about": "مؤشر فحص مبسّط متعدد المواد (0-4).",
    "items": [{"id": i+1, "text": t, "scale": "0-4_freq"} for i, t in enumerate(assist_items)],
    "cutoffs": [
        {"min": 0, "max": 3, "level": "منخفض"},
        {"min": 4, "max": 11, "level": "متوسط"},
        {"min": 12, "max": 32, "level": "مرتفع"},
    ],
}

# ---------------------------
# التصحيح
# ---------------------------
def score_test(test_key: str, answers: Dict[int, int]) -> Dict[str, Any]:
    """
    answers: dict {item_id: value}
    return: {total, level, by_item(optional), details}
    """
    test = PSYCH_TESTS.get(test_key)
    if not test:
        return {"total": 0, "level": "اختبار غير معروف", "details": {}}

    total = _sum(answers)

    # مستوى الشدة حسب cutoffs العامة
    level_info = _band(total, test.get("cutoffs", []))
    level = level_info.get("level", "غير محدد")

    return {
        "test_key": test_key,
        "name": test["name"],
        "total": total,
        "level": level,
        "details": {
            "about": test.get("about", ""),
            "n_items": len(test.get("items", [])),
        },
    }

# تجربة محلية
if __name__ == "__main__":
    demo = {i+1: 2 for i in range(9)}  # كل بند = 2
    print(score_test("phq9", demo))
    print(score_test("gad7", {i+1: 1 for i in range(7)}))
