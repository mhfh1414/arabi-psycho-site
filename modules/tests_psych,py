from __future__ import annotations

# اختبارات نفسية (قلق/اكتئاب…)
# بنحط نموذجين كبداية، وتقدر تزيد لاحقاً
PSYCH_TESTS = {
    "phq9": {
        "title": "PHQ-9 (الاكتئاب)",
        "scale": {0: "أبدًا", 1: "عدة أيام", 2: "أكثر من النصف", 3: "تقريبًا كل يوم"},
        "items": [{"id": i+1, "text": f"البند {i+1}"} for i in range(9)],
        "ranges": [(0,4,"خفيف جدًا"), (5,9,"خفيف"), (10,14,"متوسط"), (15,19,"شديد"), (20,27,"شديد جدًا")]
    },
    "gad7": {
        "title": "GAD-7 (القلق العام)",
        "scale": {0: "أبدًا", 1: "عدة أيام", 2: "أكثر من النصف", 3: "تقريبًا كل يوم"},
        "items": [{"id": i+1, "text": f"العرض {i+1}"} for i in range(7)],
        "ranges": [(0,4,"خفيف جدًا"), (5,9,"خفيف"), (10,14,"متوسط"), (15,21,"شديد")]
    }
}

def get_scale_options(test_key: str):
    """للاستخدام في القوالب: يرجّع خيارات مقياس الإجابة للـ test_key."""
    test = PSYCH_TESTS.get(test_key)
    return test["scale"].items() if test else []

def score_test(test_key: str, answers: dict) -> dict:
    """يحسب الدرجة الكلية ويعطي وصف النطاق."""
    test = PSYCH_TESTS.get(test_key)
    if not test:
        return {"total": 0, "band": "غير معروف"}
    total = sum(int(answers.get(i["id"], 0)) for i in test["items"])
    band = "غير معروف"
    for lo, hi, label in test["ranges"]:
        if lo <= total <= hi:
            band = label
            break
    return {"total": total, "band": band}
