# -*- coding: utf-8 -*-
"""
اختبارات نفسية (مقاييس القلق والاكتئاب وغيرها)
"""

from typing import Dict, Any

# ======================================================
# تعريف بنك الاختبارات النفسية
# ======================================================

PSYCH_TESTS: Dict[str, Dict[str, Any]] = {
    "gad7": {
        "title": "مقياس القلق العام GAD-7",
        "items": [
            {"id": 1, "text": "الشعور بالتوتر أو القلق أو العصبية"},
            {"id": 2, "text": "صعوبة التحكم بالقلق"},
            {"id": 3, "text": "القلق المفرط حول مواضيع مختلفة"},
            {"id": 4, "text": "صعوبة الاسترخاء"},
            {"id": 5, "text": "الشعور بالتململ أو صعوبة الجلوس"},
            {"id": 6, "text": "سهولة الانزعاج أو العصبية"},
            {"id": 7, "text": "الشعور بالخوف من أن يحدث شيء سيء"},
        ],
        "scoring": {"min": 0, "max": 21},
        "cutoffs": {
            "0-4": "قلق ضئيل",
            "5-9": "قلق خفيف",
            "10-14": "قلق متوسط",
            "15-21": "قلق شديد"
        }
    },
    "phq9": {
        "title": "مقياس الاكتئاب PHQ-9",
        "items": [
            {"id": 1, "text": "قلة الاهتمام أو المتعة في القيام بالأشياء"},
            {"id": 2, "text": "الشعور بالاكتئاب أو الإحباط أو اليأس"},
            {"id": 3, "text": "صعوبة النوم أو النوم الزائد"},
            {"id": 4, "text": "الشعور بالتعب أو قلة الطاقة"},
            {"id": 5, "text": "ضعف الشهية أو الإفراط في الأكل"},
            {"id": 6, "text": "الشعور بسوء تجاه نفسك أو أنك فاشل"},
            {"id": 7, "text": "صعوبة التركيز على أشياء مثل القراءة أو التلفاز"},
            {"id": 8, "text": "بطء في الحركة أو الكلام أو العكس (توتر زائد)"},
            {"id": 9, "text": "أفكار بأنك تود إيذاء نفسك"},
        ],
        "scoring": {"min": 0, "max": 27},
        "cutoffs": {
            "0-4": "لا يوجد اكتئاب",
            "5-9": "اكتئاب خفيف",
            "10-14": "اكتئاب متوسط",
            "15-19": "اكتئاب متوسط إلى شديد",
            "20-27": "اكتئاب شديد"
        }
    }
}

# ======================================================
# دوال التصحيح
# ======================================================

def score_test(test_key: str, answers: Dict[int, int]) -> Dict[str, Any]:
    """
    يجمع الدرجات ويحدد المستوى.
    answers: dict {id: value}
    """
    test = PSYCH_TESTS.get(test_key)
    if not test:
        return {"error": "اختبار غير موجود"}

    total = sum(answers.values())
    level = "غير محدد"

    for rng, desc in test.get("cutoffs", {}).items():
        lo, hi = map(int, rng.split("-"))
        if lo <= total <= hi:
            level = desc
            break

    return {
        "total": total,
        "level": level,
        "max": test["scoring"]["max"]
    }
