"""
DSM-5 (Arabic) — ملف واحد شامل بدون فهرس خارجي
ملف: dsm.py
وصف:
  يحتوي هذا الملف على جميع الفئات (01→19) وكل فئة تضم عناصر اضطرابات أساسية
  مع دوال جاهزة للقراءة والبحث والعرض داخل الموقع مباشرة دون الحاجة لأي ملف فهرس.
"""

from __future__ import annotations
from typing import Dict, List, Any, Optional
import json

# =========================
# البنية العامة للبيانات
# =========================
# CATEGORIES: مفتاحه = مفتاح الفئة (slug) مثل "anxiety_disorders"
# كل فئة: {"id": "01", "key": "...", "name_ar": "...", "items": [ ... ]}
# كل عنصر (اضطراب): {"code": "GAD", "name_ar": "...", "summary": "...", "criteria": [...], "notes": [...]}

CATEGORIES: Dict[str, Dict[str, Any]] = {

    # 01 — اضطرابات القلق
    "anxiety_disorders": {
        "id": "01",
        "key": "anxiety_disorders",
        "name_ar": "اضطرابات القلق",
        "items": [
            {
                "code": "GAD",
                "name_ar": "اضطراب القلق المعمم",
                "summary": "قلق وتوتر مفرط معظم الأيام ≥ 6 أشهر مع صعوبة التحكم وأعراض جسدية.",
                "criteria": [
                    "قلق وتوتر مفرط حول عدد من الأحداث/الأنشطة معظم الأيام ≥ 6 أشهر.",
                    "صعوبة في التحكم بالقلق.",
                    "≥ 3 من: توتر عضلي، تعب، تهيج، صعوبة تركيز، اضطراب نوم.",
                    "يسبّب ضيقًا أو اختلالًا وظيفيًا.",
                ],
                "notes": ["العلاج المعرفي السلوكي (CBT) وخط أول SSRIs/ SNRIs."]
            },
            {
                "code": "PD",
                "name_ar": "اضطراب الهلع",
                "summary": "نوبات هلع متكررة وغير متوقعة مع قلق توقعي/تجنّب ≥ شهر.",
                "criteria": [
                    "نوبات هلع مفاجئة متكررة وغير متوقعة.",
                    "قلق مستمر من نوبات مستقبلية أو تغير سلوكي تجنّبي ≥ شهر.",
                ],
                "notes": ["تثقيف + تمارين تنفس؛ SSRIs؛ بنزوديازيبين قصير الأمد بحذر."]
            },
            {
                "code": "SAD",
                "name_ar": "اضطراب القلق الاجتماعي",
                "summary": "خوف من التقييم السلبي في مواقف اجتماعية/أدائية مع تجنّب واضح ≥ 6 أشهر.",
                "criteria": [
                    "خوف ملحوظ من مواقف اجتماعية يتعرض فيها الشخص لتدقيق الآخرين.",
                    "المواقف تُتجنب أو تُحتمل بقلق شديد وغير متناسب.",
                    "ضيق/اختلال وظيفي.",
                ],
                "notes": ["CBT اجتماعي؛ SSRIs؛ بروبرانولول قبل الأداء لبعض الحالات."]
            },
        ]
    },

    # 02 — الوسواس القهري وما يرتبط به
    "ocd_related_disorders": {
        "id": "02",
        "key": "ocd_related_disorders",
        "name_ar": "اضطرابات الوسواس القهري وما يرتبط بها",
        "items": [
            {
                "code": "OCD",
                "name_ar": "اضطراب الوسواس القهري",
                "summary": "وساوس/أفعال قهرية تستغرق الوقت وتؤثر وظيفيًا.",
                "criteria": [
                    "وجود وساوس و/أو أفعال قهرية.",
                    "تستغرق وقتًا أو تسبب ضيقًا/اختلالًا.",
                ],
                "notes": ["ERP (تعرض ومنع استجابة)، SSRIs/كلوميبرامين؛ تحفيز للحالات المقاومة."]
            },
            {
                "code": "BDD",
                "name_ar": "اضطراب تشوّه صورة الجسد",
                "summary": "انشغال بعيوب متصوّرة بالمظهر مع سلوكيات متكررة.",
                "criteria": ["انشغال متكرر + سلوكيات فحص/إخفاء.", "ضيق/اختلال وظيفي."],
                "notes": ["CBT موجه للمظهر؛ SSRIs."]
            },
            {
                "code": "HOARD",
                "name_ar": "اضطراب الاكتناز",
                "summary": "صعوبة التخلص من الممتلكات → تراكم يعيق المساحات.",
                "criteria": ["صعوبة التخلص بغض النظر عن القيمة.", "تراكم يعيق الاستخدام الآمن للمساحات."],
                "notes": ["CBT موجه للاكتناز؛ دعم تنظيمي."]
            },
        ]
    },

    # 03 — الاضطرابات المزاجية
    "mood_disorders": {
        "id": "03",
        "key": "mood_disorders",
        "name_ar": "الاضطرابات المزاجية",
        "items": [
            {
                "code": "MDD",
                "name_ar": "اضطراب اكتئابي جسيم",
                "summary": "نوبة اكتئابية كبرى ≥ أسبوعين مع تأثير وظيفي.",
                "criteria": [
                    "≥ 5 أعراض (مزاج مكتئب/فقدان المتعة إلزامي).",
                    "ضيق/اختلال وظيفي، لا تُفسّر بمادة/حالة طبية.",
                ],
                "notes": ["SSRIs/SNRIs؛ CBT؛ ECT للحالات الشديدة."]
            },
            {
                "code": "BP1",
                "name_ar": "ثنائي القطب النوع الأول",
                "summary": "≥ نوبة هوس واحدة (± اكتئاب).",
                "criteria": ["نوبة هوس مدة ≥ أسبوع أو بحاجة إدخال.", "اختلال واضح أو سلوك خطِر."],
                "notes": ["مثبّتات المزاج (ليثيوم/فالبروات) + مضادات الذهان."]
            },
            {
                "code": "BP2",
                "name_ar": "ثنائي القطب النوع الثاني",
                "summary": "هوس خفيف + اكتئاب كبرى، دون هوس كامل.",
                "criteria": ["نوبة هوس خفيف + نوبة اكتئاب كبرى.", "لا توجد نوبة هوس."],
                "notes": ["لاموتريجين/ليثيوم؛ تجنب مضادات الاكتئاب منفردة."]
            },
        ]
    },

    # 04 — طيف الفصام والذهانات
    "schizophrenia_spectrum": {
        "id": "04",
        "key": "schizophrenia_spectrum",
        "name_ar": "طيف الفصام والاضطرابات الذهانية",
        "items": [
            {
                "code": "SCZ",
                "name_ar": "الفُصام",
                "summary": "أعراض ذهانية أساسية لمدة ممتدة (≥ 6 أشهر).",
                "criteria": [
                    "≥ 2 من: ضلالات، هلوسات، تفكك كلامي، سلوك غير منظّم/كاتاتونيا، أعراض سلبية.",
                    "مدة ≥ 6 أشهر مع شهر نشط.",
                ],
                "notes": ["مضادات الذهان؛ إعادة تأهيل؛ كلوزابين للمقاومة."]
            },
            {
                "code": "BRF",
                "name_ar": "اضطراب ذهاني وجيز",
                "summary": "أعراض ذهانية من يوم إلى < شهر مع عودة للخط الأساس.",
                "criteria": ["ظهور مفاجئ؛ مدة قصيرة؛ عودة كاملة."],
                "notes": ["مضادات الذهان قصيرة الأمد + متابعة."]
            },
            {
                "code": "SCHSAFF",
                "name_ar": "الاضطراب الفصامي العاطفي",
                "summary": "معايير فصام + نوبات مزاجية كبرى.",
                "criteria": ["ذُهان ≥ أسبوعين بغياب أعراض مزاجية.", "نوبات مزاجية في أغلب مدة المرض."],
                "notes": ["مضادات الذهان + معالجة الاضطراب المزاجي."]
            },
        ]
    },

    # 05 — الاضطرابات النمائية العصبية
    "neurodevelopmental_disorders": {
        "id": "05",
        "key": "neurodevelopmental_disorders",
        "name_ar": "الاضطرابات النمائية العصبية",
        "items": [
            {
                "code": "ASD",
                "name_ar": "اضطراب طيف التوحّد",
                "summary": "عجز تواصلي/تفاعلي وأنماط سلوك مقيدة/متكررة منذ الطفولة.",
                "criteria": ["عجز تواصلي/اجتماعي.", "سلوكيات/اهتمامات مقيدة متكررة."],
                "notes": ["تدخلات سلوكية مبكرة؛ دعم لغوي/وظيفي."]
            },
            {
                "code": "ADHD",
                "name_ar": "فرط الحركة وتشتت الانتباه",
                "summary": "نقص انتباه و/أو فرط حركة-اندفاعية قبل 12 سنة وفي ≥ بيئتين.",
                "criteria": ["أعراض مستمرة ≥ 6 أشهر.", "أذى وظيفي في المدرسة/البيت."],
                "notes": ["منبّهات/بدائل + تدريب سلوكي."]
            },
            {
                "code": "SLD",
                "name_ar": "اضطراب التعلّم المحدد",
                "summary": "عجز في القراءة/الكتابة/الحساب رغم التدخل.",
                "criteria": ["ثبات الصعوبات ≥ 6 أشهر.", "توثيق بالاختبارات القياسية."],
                "notes": ["خُطط تعليم فردية وتسهيلات."]
            },
        ]
    },

    # 06 — اضطرابات الصدمة والضغوط
    "trauma_stressor_disorders": {
        "id": "06",
        "key": "trauma_stressor_disorders",
        "name_ar": "اضطرابات الصدمة والضغوط",
        "items": [
            {
                "code": "PTSD",
                "name_ar": "اضطراب ما بعد الصدمة",
                "summary": "تعرض لصدمة + اقتحام + تجنب + تبدلات سلبية + فرط يقظة ≥ شهر.",
                "criteria": ["تعرض مباشر/شهود/إخبار متكرر.", "عنقود اقتحامي وتجنب وتبدلات وفرط يقظة."],
                "notes": ["علاج تعرض/معالجة معرفية؛ SSRIs."]
            },
            {
                "code": "ADJ",
                "name_ar": "اضطراب التكيّف",
                "summary": "أعراض مرتبطة بضغوط محددة خلال 3 أشهر مع أثر وظيفي.",
                "criteria": ["استجابة نفسية مبالغ فيها لضغط محدد.", "لا تستوفي تشخيصًا آخر."],
                "notes": ["دعم نفسي قصير الأمد؛ CBT موجّه للضغط."]
            },
        ]
    },

    # 07 — الاضطرابات التفارقية
    "dissociative_disorders": {
        "id": "07",
        "key": "dissociative_disorders",
        "name_ar": "الاضطرابات التفارقية",
        "items": [
            {
                "code": "DID",
                "name_ar": "اضطراب الهوية التفارقي",
                "summary": "هويتان/أكثر مع فجوات في التذكر.",
                "criteria": ["تحول بين حالات هوية.", "نسيان فجواتي ليس مفسرًا طبيًا."],
                "notes": ["علاج نفسي طويل الأمد متمركز على الصدمة."]
            },
            {
                "code": "DPDR",
                "name_ar": "تبدّد الشخصية/الواقع",
                "summary": "خبرات مستمرة من تبدد الشخصية/الواقع مع سلامة اختبار الواقع.",
                "criteria": ["وعي بأن التجربة ذاتية.", "ضيق/اختلال وظيفي."],
                "notes": ["علاج نفسي داعم/معرفي؛ معالجة المسببات."]
            },
        ]
    },

    # 08 — الاضطرابات الجسدية الشكل
    "somatic_symptom_disorders": {
        "id": "08",
        "key": "somatic_symptom_disorders",
        "name_ar": "اضطرابات الأعراض الجسدية",
        "items": [
            {
                "code": "SSD",
                "name_ar": "اضطراب الأعراض الجسدية",
                "summary": "عرض/أعراض جسدية مع أفكار/مشاعر/سلوكيات مفرطة.",
                "criteria": ["قلق صحي مبالغ.", "وقت/طاقة مفرطة للأعراض."],
                "notes": ["رعاية أولية منسقة؛ CBT؛ حد أدنى من الفحوصات الزائدة."]
            },
            {
                "code": "IAD",
                "name_ar": "اضطراب قلق المرض",
                "summary": "انشغال شديد بمرض خطير مع أعراض قليلة/معدومة.",
                "criteria": ["قلق صحي مستمر ≥ 6 أشهر.", "تفقد/تجنب طبي مفرط."],
                "notes": ["CBT؛ معالجة القلق الصحي؛ تجنب الطمأنة المفرطة."]
            },
        ]
    },

    # 09 — اضطرابات الأكل
    "feeding_eating_disorders": {
        "id": "09",
        "key": "feeding_eating_disorders",
        "name_ar": "اضطرابات الأكل",
        "items": [
            {
                "code": "AN",
                "name_ar": "القهم العصبي",
                "summary": "تقييد شديد للمدخول وخوف من زيادة الوزن واضطراب صورة الجسد.",
                "criteria": ["نقص وزن ملحوظ.", "سلوكيات تجنب/تقييد.", "اضطراب صورة الجسد."],
                "notes": ["استعادة الوزن بأمان؛ علاج أسري/CBT-E؛ المتابعة الطبية."]
            },
            {
                "code": "BN",
                "name_ar": "الشره العصبي",
                "summary": "نهم متكرر + سلوكيات تعويضية غير مناسبة + تقييم ذاتي متأثر بشكل الجسم.",
                "criteria": ["نهم ≥ مرة أسبوعيًا لمدة 3 أشهر.", "تعويض (قيء/مسهل/صيام/رياضة)."],
                "notes": ["CBT-E؛ SSRIs (فلوكسيتين)."]
            },
            {
                "code": "BED",
                "name_ar": "اضطراب نهم الطعام",
                "summary": "نهم متكرر دون سلوكيات تعويضية مع ضيق واضح.",
                "criteria": ["≥ مرة أسبوعيًا لمدة 3 أشهر.", "ضيق واضح بعد النهم."],
                "notes": ["CBT؛ تدخلات وزن؛ أدوية مختارة."]
            },
        ]
    },

    # 10 — اضطرابات الإطراح (الإخراج)
    "elimination_disorders": {
        "id": "10",
        "key": "elimination_disorders",
        "name_ar": "اضطرابات الإطراح",
        "items": [
            {
                "code": "ENUR",
                "name_ar": "تبول لا إرادي ليلي",
                "summary": "تبول لا إرادي ≥ مرتين أسبوعيًا لمدة 3 أشهر (≥ 5 سنوات).",
                "criteria": ["لا يفسر بمرض/دواء.", "ضيق أو أثر وظيفي."],
                "notes": ["إنذار النهوض؛ تدريب؛ أحيانًا ديسموبريسين."]
            },
            {
                "code": "ENCOP",
                "name_ar": "تبراز لا إرادي",
                "summary": "تبرز غير ملائم ≥ مرة شهريًا لمدة 3 أشهر (≥ 4 سنوات).",
                "criteria": ["أحيانًا مرتبط بإمساك مزمن.", "ضيق/اختلال."],
                "notes": ["علاج الإمساك؛ تدريب المرحاض؛ دعم أسري."]
            },
        ]
    },

    # 11 — اضطرابات النوم واليقظة
    "sleep_wake_disorders": {
        "id": "11",
        "key": "sleep_wake_disorders",
        "name_ar": "اضطرابات النوم واليقظة",
        "items": [
            {
                "code": "INS",
                "name_ar": "الأرق",
                "summary": "صعوبة بدء/استمرار النوم أو الاستيقاظ المبكر ≥ 3 أشهر.",
                "criteria": ["≥ 3 ليالٍ/أسبوع لمدة ≥ 3 أشهر.", "ضيق/اختلال نهاري."],
                "notes": ["CBT-I خط أول؛ نظافة نوم؛ أدوية قصيرة الأمد بحذر."]
            },
            {
                "code": "HYP",
                "name_ar": "فرط النعاس",
                "summary": "نعاس مفرط رغم نوم كافٍ مع أثر وظيفي.",
                "criteria": ["نعاس نهاري مفرط متكرر.", "استبعاد أسباب ثانوية."],
                "notes": ["تنظيم نوم؛ منبّهات مختارة؛ تقييم اضطرابات تنفس النوم."]
            },
            {
                "code": "NAR",
                "name_ar": "النوم القهري (نركولبسي)",
                "summary": "نعاس شديد مع نوبات نوم لا تُقاوم ± كاتابلكسي.",
                "criteria": ["تواتر ≥ 3/أسبوع ≥ 3 أشهر.", "دلائل نقص هيبوكريتين/اختبارات نوم."],
                "notes": ["منبهات يقظة؛ سجلات أمان؛ توعية."]
            },
        ]
    },

    # 12 — الخلل الوظيفي الجنسي
    "sexual_dysfunctions": {
        "id": "12",
        "key": "sexual_dysfunctions",
        "name_ar": "الاختلالات الجنسية",
        "items": [
            {"code": "ED", "name_ar": "اضطراب الانتصاب", "summary": "صعوبة بدء/الحفاظ على الانتصاب.", "criteria": ["مدة ≥ 6 أشهر.", "ضيق معتبر."], "notes": ["علاج سببي؛ مثبطات PDE5."]},
            {"code": "DE", "name_ar": "القذف المتأخر", "summary": "تأخر/غياب القذف مع إثارة كافية.", "criteria": ["مدة ≥ 6 أشهر.", "ضيق."], "notes": ["علاج سلوكي/دوائي مخصص."]},
            {"code": "FOD", "name_ar": "اضطراب هزّة الجماع (إناث)", "summary": "تأخر/غياب الهزّة أو انخفاض شدتها.", "criteria": ["مدة ≥ 6 أشهر.", "ضيق."], "notes": ["تعليم/علاج جنسي/نفسي."]},
        ]
    },

    # 13 — اضطراب الهوية الجندرية
    "gender_dysphoria": {
        "id": "13",
        "key": "gender_dysphoria",
        "name_ar": "اضطراب الهوية الجندرية",
        "items": [
            {"code": "GD-A", "name_ar": "ضيق الهوية الجندرية (بالغون/مراهقون)", "summary": "ضيق بسبب عدم التوافق بين الهوية والخصائص الجنسية.", "criteria": ["مدة ≥ 6 أشهر.", "ضيق/اختلال."], "notes": ["رعاية تأكيدية متعددة الاختصاصات."]},
        ]
    },

    # 14 — الاضطرابات التخريبية وضبط الاندفاع والسلوك
    "disruptive_impulse_control": {
        "id": "14",
        "key": "disruptive_impulse_control",
        "name_ar": "الاضطرابات التخريبية وضبط الاندفاع والسلوك",
        "items": [
            {"code": "ODD", "name_ar": "اضطراب العناد الشارد", "summary": "نمط غضب/جدل/حقد.", "criteria": ["مدة ≥ 6 أشهر.", "اختلال وظيفي."], "notes": ["تدريب والدين؛ برامج سلوكية."]},
            {"code": "IED", "name_ar": "اضطراب الانفجار المتقطع", "summary": "نوبات غضب/عدوان غير متناسب.", "criteria": ["اندفاعية متكررة.", "ضيق/اختلال."], "notes": ["علاج معرفي سلوكي؛ أدوية مختارة."]},
            {"code": "CD", "name_ar": "اضطراب السلوك", "summary": "انتهاك حقوق الآخرين/قواعد رئيسية.", "criteria": ["نمط مستمر.", "بدء طفولي/مراهقي."], "notes": ["علاج أسري متعدد المنظومات؛ وقاية."]},
        ]
    },

    # 15 — اضطرابات تعاطي المواد
    "substance_disorders": {
        "id": "15",
        "key": "substance_disorders",
        "name_ar": "اضطرابات تعاطي المواد",
        "items": [
            {"code": "AUD", "name_ar": "اضطراب تعاطي الكحول", "summary": "نمط مشكل من التعاطي يؤثر وظيفيًا.", "criteria": ["معايير شدة DSM-5."], "notes": ["ME/CBT؛ أكمبروسيت/نالتريكسون بحسب الحالة."]},
            {"code": "OUD", "name_ar": "اضطراب استخدام الأفيونات", "summary": "استخدام مشكل للأفيونات.", "criteria": ["معايير DSM-5."], "notes": ["بدائل (بوبرينورفين/ميثادون) + دعم نفسي."]},
            {"code": "TUD", "name_ar": "اضطراب تعاطي التبغ", "summary": "اعتماد/تعاطي مستمر للنّيكوتين.", "criteria": ["معايير DSM-5."], "notes": ["NRT/فارينيكلين/بوبروبيون + دعم سلوكي."]},
        ]
    },

    # 16 — الاضطرابات العصبية الإدراكية
    "neurocognitive_disorders": {
        "id": "16",
        "key": "neurocognitive_disorders",
        "name_ar": "الاضطرابات العصبية الإدراكية",
        "items": [
            {"code": "MAJ-NCD", "name_ar": "اضطراب معرفي عصبي كبير", "summary": "تدهور ملحوظ يعيق الاستقلالية.", "criteria": ["دليل سريري/اختباري.", "تأثير وظيفي واضح."], "notes": ["خطة أمان؛ تثقيف أسري؛ علاج سبب نوعي."]},
            {"code": "MILD-NCD", "name_ar": "اضطراب معرفي عصبي طفيف", "summary": "تدهور معتدل دون فقد الاستقلالية الكامل.", "criteria": ["دليل قياسي.", "تعويضات وظيفية."], "notes": ["تأهيل معرفي؛ متابعة."]},
        ]
    },

    # 17 — اضطرابات الشخصية
    "personality_disorders": {
        "id": "17",
        "key": "personality_disorders",
        "name_ar": "اضطرابات الشخصية",
        "items": [
            {"code": "BPD", "name_ar": "الشخصية الحدّية", "summary": "اندفاعية وعدم استقرار عاطفي/علاقات.", "criteria": ["≥ 5 معايير DSM-5."], "notes": ["DBT؛ علاج تشاركي؛ معالجة مرافِقات."]},
            {"code": "ASPD", "name_ar": "الشخصية المعادية للمجتمع", "summary": "ازدراء لحقوق الآخرين منذ المراهقة.", "criteria": ["مخالفات/خداع/اندفاع/عدوان."], "notes": ["برامج سلوكية وإدارة مخاطر."]},
            {"code": "OCPD", "name_ar": "الشخصية القهرية الوسواس", "summary": "انشغال بالكمال والنظامية.", "criteria": ["على حساب المرونة والكفاءة."], "notes": ["علاج معرفي سلوكي؛ أدوية عند الاقتضاء."]},
        ]
    },

    # 18 — الانحرافات الجنسية (Paraphilic)
    "paraphilic_disorders": {
        "id": "18",
        "key": "paraphilic_disorders",
        "name_ar": "الانحرافات الجنسية",
        "items": [
            {"code": "VOY", "name_ar": "التلصص", "summary": "إثارة من مراقبة غير واعين.", "criteria": ["ضيق/ضرر أو سلوك غير قانوني."], "notes": ["علاج متخصص طويل الأمد."]},
            {"code": "EXH", "name_ar": "الاستعراء", "summary": "إثارة من كشف الأعضاء لغرباء.", "criteria": ["ضيق/ضرر."], "notes": ["علاج سلوكي/دوائي مختص."]},
            {"code": "PED", "name_ar": "اشتهاء الأطفال", "summary": "خيالات/دوافع نحو أطفال قبل البلوغ.", "criteria": ["ضيق/ضرر أو فعل."], "notes": ["رعاية أمان عالية؛ مختصون."]},
        ]
    },

    # 19 — أخرى محددة/غير محددة
    "other_disorders": {
        "id": "19",
        "key": "other_disorders",
        "name_ar": "اضطرابات أخرى محددة/غير محددة",
        "items": [
            {"code": "OSD", "name_ar": "اضطراب محدد آخر", "summary": "تشخيص يستخدم مع توضيح سبب عدم استيفاء المعايير كاملة.", "criteria": ["سبب محدد موثق."], "notes": ["اكتب السبب في السجل الطبي."]},
            {"code": "USD", "name_ar": "اضطراب غير محدد", "summary": "يُستخدم عند نقص المعلومات مع وجود ضيق/اختلال.", "criteria": ["لا تتوفر معطيات كافية الآن."], "notes": ["إعادة التقييم عند توفر معلومات."]},
        ]
    },
}


# =========================
# دوال مساعدة للاستخدام
# =========================

def list_categories() -> List[Dict[str, Any]]:
    """قائمة الفئات مع (id, key, name_ar وعدد العناصر)."""
    out: List[Dict[str, Any]] = []
    for k, v in CATEGORIES.items():
        out.append({
            "id": v["id"],
            "key": v["key"],
            "name_ar": v["name_ar"],
            "count": len(v.get("items", [])),
        })
    # ترتيب حسب رقم الفئة
    return sorted(out, key=lambda x: int(x["id"]))


def list_disorders(category_key: str) -> List[Dict[str, Any]]:
    """جميع الاضطرابات داخل فئة معينة."""
    cat = CATEGORIES.get(category_key)
    return list(cat.get("items", [])) if cat else []


def get_disorder_by_code(code: str) -> Optional[Dict[str, Any]]:
    """إرجاع عنصر اضطراب عبر رمزه (code) عبر كل الفئات."""
    c = (code or "").strip().upper()
    for v in CATEGORIES.values():
        for it in v.get("items", []):
            if str(it.get("code", "")).upper() == c:
                return it
    return None


def search(text: str) -> List[Dict[str, Any]]:
    """بحث بسيط بالاسم/الملخص/الكود عبر جميع الفئات."""
    q = (text or "").strip().lower()
    if not q:
        return []
    hits: List[Dict[str, Any]] = []
    for cat_key, v in CATEGORIES.items():
        for it in v.get("items", []):
            blob = f"{it.get('name_ar','')} {it.get('summary','')} {it.get('code','')}".lower()
            if q in blob:
                hits.append({"category": v["name_ar"], "item": it})
    return hits


def to_json(indent: int = 2) -> str:
    """تصدير كامل الملف JSON (للاختبار أو واجهة API)."""
    return json.dumps(CATEGORIES, ensure_ascii=False, indent=indent)


# =========================
# أمثلة استخدام (تعطيل وقت التشغيل إذا أردت)
# =========================
if __name__ == "__main__":
    # طباعة ملخص سريع
    print("الفئات:", [f"{c['id']}) {c['name_ar']} ({c['count']})" for c in list_categories()])
    print("بحث عن 'الهلع':", [h["item"]["name_ar"] for h in search("الهلع")])
    print("استرجاع OCD:", get_disorder_by_code("OCD"))
