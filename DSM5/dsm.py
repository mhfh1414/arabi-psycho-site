# -*- coding: utf-8 -*-
"""
DSM-5 Arabic helper (بدون فهرس عام)
قاعدة أمراض وخطط علاج معرفي-سلوكي مفصلة للاستخدام داخل الموقع.
"""

from __future__ import annotations
from typing import Dict, List, Any
import json

# =========================================================
# قاعدة الأمراض (موسّعة)
# =========================================================

DISORDERS: List[Dict[str, Any]] = [
    {
        "id": 1,
        "key": "gad",
        "name_ar": "اضطراب القلق العام",
        "summary": "قلق مفرط صعب التحكم فيه أغلب الأيام ≥ 6 أشهر مع أعراض جسدية ومعرفية.",
        "criteria": [
            "قلق/انشغال مفرط حول مجالات متعددة ≥ 6 أشهر",
            "صعوبة في السيطرة على القلق",
            "٣ أعراض أو أكثر: توتر، إرهاق، صعوبة تركيز، تهيج، توتر عضلي، اضطراب نوم",
            "ضائقة أو تضرر وظيفي واضح"
        ],
        "cbt_plan": {
            "goals": ["خفض شدة القلق", "زيادة التسامح مع عدم اليقين", "تحسين النوم والوظيفة اليومية"],
            "techniques": [
                {"name": "التثقيف النفسي", "steps": ["نموذج القلق (مثير-فكرة-انفعال-سلوك)", "تمييز القلق المفيد مقابل المضر"]},
                {"name": "مراقبة القلق", "steps": ["سجل يومي: الموقف/الفكرة/الانفعال/السلوك/الشدة (0-10)"]},
                {"name": "إعادة البناء المعرفي", "steps": ["تحديد التشوهات", "أسئلة سقراطية", "بدائل متوازنة"]},
                {"name": "التعرّض للهمّ المؤجل", "steps": ["وقت قلق محدد", "منع الطمأنة", "تجارب سلوكية"]},
                {"name": "استرخاء قصير", "steps": ["تنفس بطني 4-6", "إرخاء عضلي تدريجي مختصر"]},
            ],
            "homework": ["سجل القلق اليومي", "تمارين تنفس مرتين يومياً", "تحدي فكرة واحدة يومياً"],
            "sessions": 10,
            "measures": ["GAD-7", "PSQI للنوم"]
        }
    },
    {
        "id": 2,
        "key": "panic",
        "name_ar": "اضطراب الهلع",
        "summary": "نوبات هلع متكررة مع قلقٍ توقّعي أو تجنب منذ ≥ شهر.",
        "criteria": [
            "نوبات هلع مفاجئة ومتكررة",
            "شهر أو أكثر من القلق التوقعي أو تغيرات سلوكية تجنبية",
            "الاعراض ليست بسبب مادة/حالة طبية"
        ],
        "cbt_plan": {
            "goals": ["إطفاء الخوف من الإحساسات الجسدية", "خفض التجنب والطمأنة"],
            "techniques": [
                {"name": "التثقيف", "steps": ["منحنى القلق", "الأمان الجسدي لأعراض الهلع"]},
                {"name": "التعرّض الداخلي", "steps": ["استثارة الإحساسات (دوران، الجري مكانك، تنفس من قشة)", "المراقبة حتى يهبط القلق دون سلوك أمان"]},
                {"name": "التعرّض للمواقف", "steps": ["سلم مواقف (السوق، السيارة، المصعد)", "منع الهروب/الطمأنة"]},
                {"name": "إعادة التفسير", "steps": ["الخفقان ≠ نوبة قلب", "دوخة ≠ إغماء"]},
            ],
            "homework": ["تكرار تعرّض داخلي يومي", "زيارتان لموقف متجنب أسبوعياً"],
            "sessions": 8,
            "measures": ["PDSS", "MIA"]
        }
    },
    {
        "id": 3,
        "key": "mdd",
        "name_ar": "الاكتئاب الجسيم",
        "summary": "مزاج مكتئب أو فقدان متعة مع 5 أعراض لأسبوعين على الأقل.",
        "criteria": [
            "مزاج مكتئب/فقدان الاهتمام معظم اليوم",
            "تغير نوم/شهية/طاقة/تركيز/تباطؤ أو هياج/ذنب/أفكار إيذاء",
            "ضائقة أو تعطل وظيفي"
        ],
        "cbt_plan": {
            "goals": ["زيادة التفعيل السلوكي", "تعديل المعتقدات السلبية الجوهرية"],
            "techniques": [
                {"name": "التفعيل السلوكي", "steps": ["قائمة أنشطة ممتعة وذات قيمة", "جدولة أسبوعية", "تتبع المزاج مقابل النشاط"]},
                {"name": "رصد الأفكار التلقائية", "steps": ["سجل أفكار", "بدائل واقعية", "تجارب سلوكية"]},
                {"name": "مهارات حل المشكلات", "steps": ["تعريف المشكلة", "عصف بدائل", "خطة وتجربة"]},
                {"name": "وقاية الانتكاس", "steps": ["علامات مبكرة", "خطة عمل 30-60-90 يوم"]},
            ],
            "homework": ["٣ أنشطة/أسبوع على الأقل", "نموذج تفكير واحد يومياً"],
            "sessions": 12,
            "measures": ["PHQ-9", "WSAS"]
        }
    },
    {
        "id": 4,
        "key": "ocd",
        "name_ar": "الوسواس القهري",
        "summary": "وساوس/قهر تستغرق وقتًا وتسبب ضيقًا أو تعطيلاً.",
        "criteria": ["وساوس أو أفعال قهرية متكررة", "استغراق > ساعة يومياً أو تضرر وظيفي"],
        "cbt_plan": {
            "goals": ["زيادة التسامح مع عدم اليقين", "خفض الطقوس القهرية"],
            "techniques": [
                {"name": "ERP (تعرّض ومنع استجابة)", "steps": ["سلم تدرج", "تعرّض حي/تخيلي", "منع كل الطقوس والطمأنة"]},
                {"name": "تجارب سلوكية", "steps": ["اختبار التنبؤات (لو لم أغسل...)", "قياس القلق حتى يهبط"]},
            ],
            "homework": ["ERP منزلي 20-40 دقيقة يومياً"],
            "sessions": 14,
            "measures": ["Y-BOCS"]
        }
    },
    {
        "id": 5,
        "key": "sad",
        "name_ar": "قلق اجتماعي",
        "summary": "خوف شديد من التقييم السلبي يؤدي لتجنب مواقف اجتماعية/أدائية.",
        "criteria": ["خوف مستمر ≥ 6 أشهر", "تجنب أو تحمل مع قلق شديد"],
        "cbt_plan": {
            "goals": ["تقليل تركيز الذات", "تصحيح تحيزات التقييم"],
            "techniques": [
                {"name": "التعرّض السلوكي", "steps": ["سلم مهام (سؤال غريب، عرض قصير)", "منع السلوكيات الآمنة"]},
                {"name": "تحويل الانتباه للخارج", "steps": ["مهام مراقبة خارجية أثناء الموقف"]},
                {"name": "إعادة البناء", "steps": ["احتمال/كارثة/قدرة على التحمّل"]},
            ],
            "homework": ["مهمتا تعرّض أسبوعياً", "سجل تقييم قبل/بعد"],
            "sessions": 10,
            "measures": ["SPIN", "Liebowitz"]
        }
    },
    {
        "id": 6,
        "key": "sp",
        "name_ar": "رهاب محدد",
        "summary": "خوف شديد ومحدّد من جسم/موقف يؤدي لتجنب مستمر.",
        "criteria": ["خوف غير متناسب ومستمر", "تجنب واضح", "مدّة ≥ 6 أشهر"],
        "cbt_plan": {
            "goals": ["إطفاء الخوف الشرطي"],
            "techniques": [
                {"name": "تعرّض حي مكثف", "steps": ["جلسة 45-90 دقيقة حتى ينخفض الخوف ≥ 50%", "تكرار في المنزل"]},
            ],
            "homework": ["تعرّض يومي قصير 10-20 دقيقة"],
            "sessions": 4,
            "measures": ["SUDS قبل/بعد"]
        }
    },
    {
        "id": 7,
        "key": "ptsd",
        "name_ar": "اضطراب ما بعد الصدمة",
        "summary": "تعرض لحدث صادمي مع إعادة معايشة وتجنب وتنبيه زائد وتغيرات مزاج.",
        "criteria": ["تعرض لصدمة", "أعراض تجنب/إعادة معايشة/تنبيه/مزاج ≥ شهر"],
        "cbt_plan": {
            "goals": ["معالجة الذكريات الصادمة", "استعادة الشعور بالأمان والسيطرة"],
            "techniques": [
                {"name": "المعالجة عبر السرد/التعرّض التخيلي", "steps": ["سرد تفصيلي متكرر", "معالجة المعاني"]},
                {"name": "التعرّض الحي", "steps": ["عودة تدريجية لمثيرات آمنة متجنبة"]},
                {"name": "تنظيم الاستثارة", "steps": ["تنفس إيقاعي", "التأريض الحسي"]},
            ],
            "homework": ["استماع للتسجيل بين الجلسات", "واجبات تعرّض حي"],
            "sessions": 12,
            "measures": ["PCL-5"]
        }
    },
    {
        "id": 8,
        "key": "insomnia",
        "name_ar": "الأرق",
        "summary": "صعوبة بدء/استمرار النوم مع أثر نهاري.",
        "criteria": ["أعراض ≥ 3 ليالٍ أسبوعياً لمدة ≥ 3 أشهر", "ضائقة أو تضرر وظيفي"],
        "cbt_plan": {
            "goals": ["تحسين كفاءة وجودة النوم", "خفض الاستثارة المعرفية"],
            "techniques": [
                {"name": "تقييد النوم", "steps": ["حساب متوسط وقت النوم الفعلي", "تحديد وقت في السرير = النوم الفعلي + 30-45د", "تعديل أسبوعي"]},
                {"name": "ضبط المنبه", "steps": ["استيقاظ ثابت", "سرير للنوم فقط"]},
                {"name": "تحصين بيئة النوم", "steps": ["إضاءة/حرارة/كافيين/شاشات"]},
                {"name": "إعادة البناء عن النوم", "steps": ["تفكيك المعتقدات الكارثية"]},
            ],
            "homework": ["مفكرة نوم يومية"],
            "sessions": 6,
            "measures": ["ISI", "PSQI"]
        }
    },
    {
        "id": 9,
        "key": "bdd",
        "name_ar": "اضطراب تشوه صورة الجسد",
        "summary": "انشغال مفرط بعيب متصوَّر مع سلوكيات تفحص/إخفاء وتجنب.",
        "criteria": ["انشغال ≥ ساعة يومياً", "سلوكيات متكررة (تفحص/طلب طمأنة)"],
        "cbt_plan": {
            "goals": ["خفض التقصي والطمأنة", "معالجة المعتقدات عن الشكل"],
            "techniques": [
                {"name": "ERP خاص بالصورة", "steps": ["منع المرايا/الطمأنة", "تعرّض للظهور علناً"]},
                {"name": "تجارب سلوكية", "steps": ["مقارنة تنبؤات التقييم مع الواقع"]},
            ],
            "homework": ["سجل طمأنة وتخفيض 50% أسبوعياً"],
            "sessions": 12,
            "measures": ["BDD-YBOCS"]
        }
    },
    {
        "id": 10,
        "key": "illness_anxiety",
        "name_ar": "قلق المرض",
        "summary": "انشغال بالخوف من الإصابة بمرض خطير رغم طمأنة طبية.",
        "criteria": ["قلق صحي مستمر ≥ 6 أشهر", "سلوك تفحص أو تجنب طبي"],
        "cbt_plan": {
            "goals": ["خفض تفحص الجسد والبحث الطبي", "زيادة التسامح مع الشك الطبي"],
            "techniques": [
                {"name": "إدارة الطمأنة", "steps": ["تقليل زيارات البحث/الفحوصات غير الضرورية"]},
                {"name": "التعرّض للقلق الصحي", "steps": ["قراءة مثيرات صحية دون بحث", "منع التفحص"]},
                {"name": "إعادة البناء", "steps": ["احتمال/خطورة/تحمّل"]},
            ],
            "homework": ["سجل طمأنة، وهدف تخفيض أسبوعي"],
            "sessions": 10,
            "measures": ["SHAI"]
        }
    },
    {
        "id": 11,
        "key": "sud",
        "name_ar": "اضطراب تعاطي المواد (خفيف-متوسط)",
        "summary": "نمط مشكل من التعاطي يؤدي لقصور وظيفي مع معايير DSM-5.",
        "criteria": ["رغبة شديدة", "فشل أدوار", "استمرار رغم الضرر", "تحمّل/انسحاب"],
        "cbt_plan": {
            "goals": ["خفض/إيقاف التعاطي", "بناء مهارات الوقاية من الانتكاس"],
            "techniques": [
                {"name": "تحليل المثير-استجابة-نتيجة", "steps": ["مثيرات داخلية/خارجية", "خطط بديلة"]},
                {"name": "إدارة المواقف عالية الخطورة", "steps": ["تدريب رفض", "شبكة دعم"]},
                {"name": "وقاية الانتكاس", "steps": ["إشارات مبكرة", "خطة الطوارئ 24 ساعة"]},
            ],
            "homework": ["سجل رغبة يومي", "حضور دعم زمالة (إن أمكن)"],
            "sessions": 12,
            "measures": ["TLFB", "ASSIST"]
        }
    },
    {
        "id": 12,
        "key": "dysthymia",
        "name_ar": "الاكتئاب المستمر (عسر المزاج)",
        "summary": "مزاج مكتئب معظم اليوم معظم الأيام ≥ سنتين مع أعراض خفيفة مزمنة.",
        "criteria": ["مزاج مكتئب مزمن", "على الأقل عرضان مرافقان (شهية/نوم/طاقة/تقدير ذات/تركيز/يأس)"],
        "cbt_plan": {
            "goals": ["زيادة النشاط الهادف", "تعديل أنماط التفكير المثبِّطة"],
            "techniques": [
                {"name": "التفعيل المتدرج", "steps": ["أنشطة قيمية صغيرة يومياً", "تعزيز ذاتي"]},
                {"name": "مخطط التفكير طويل الأمد", "steps": ["تمييز قواعد الحياة الصارمة", "بدائل مرنة"]},
            ],
            "homework": ["سجل نشاط/مزاج", "ورقة أفكار مرتين أسبوعياً"],
            "sessions": 10,
            "measures": ["PHQ-9", "DASS-21"]
        }
    },
    {
        "id": 13,
        "key": "schizophrenia",
        "name_ar": "الفصام",
        "summary": "اضطراب ذهاني يتميز بأوهام أو هلاوس وأعراض سلبية تستمر ≥ 6 أشهر مع قصور وظيفي.",
        "criteria": [
            "عرضان أو أكثر (أحدهما هلاوس أو أوهام أو كلام غير منظم)",
            "مدة ≥ 6 أشهر تشمل شهر من الأعراض النشطة",
            "قصور في العمل أو العلاقات أو العناية بالذات"
        ],
        "cbt_plan": {
            "goals": ["خفض شدة الأعراض الذهانية", "تحسين التبصر", "تحسين الأداء الاجتماعي"],
            "techniques": [
                {"name": "التثقيف النفسي", "steps": ["شرح طبيعة الأعراض", "إزالة الوصمة"]},
                {"name": "إعادة البناء المعرفي", "steps": ["استجواب الدلائل", "تجارب سلوكية للأوهام"]},
                {"name": "إدارة الانتباه", "steps": ["تحويل الانتباه بعيداً عن الهلاوس"]},
                {"name": "تنشيط سلوكي", "steps": ["جدولة نشاطات يومية بسيطة", "تعزيز اجتماعي"]},
            ],
            "homework": ["سجل هلاوس/أوهام", "تجربة بديل واحد أسبوعياً"],
            "sessions": 16,
            "measures": ["PANSS", "PSP"]
        }
    }
]

# =========================================================
# دوال مساعدة
# =========================================================

def get_all_disorders() -> List[Dict[str, Any]]:
    return DISORDERS

def get_disorder_by_id(disorder_id: int) -> Dict[str, Any]:
    for it in DISORDERS:
        if it["id"] == disorder_id:
            return it
    return {}

def get_disorder_by_key(key: str) -> Dict[str, Any]:
    key = (key or "").strip().lower()
    for it in DISORDERS:
        if it
